<!-- 
CHANGELOG - Data: 2025-01-24
Adicionada funcionalidade de exportação/importação completa de dados
- Adicionado botão flutuante no canto inferior direito com ícone de backup
- Adicionado modal de exportação/importação com ID 'importExportModal'
- Adicionadas funções: detectStorageType, exportAllData, validateImportData, 
  importAllData, createBackup, showImportExportModal, hideImportExportModal
- Adicionado CSS específico com prefixo 'importExport__' para evitar conflitos
- Adicionado script de testes automático acessível via console (window.runImportExportTests)
- Todas as funções existentes permanecem inalteradas
- Chaves de armazenamento existentes não foram modificadas
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow - Gerenciador de Ciclos de Estudo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Variáveis de cores */
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #06d6a0;
            --danger: #ef476f;
            --warning: #ffd166;
            --info: #118ab2;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --card-bg: #ffffff;
            --body-bg: #f5f7fb;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        .dark-theme {
            --primary: #5a7dff;
            --primary-dark: #4a6cef;
            --card-bg: #1e293b;
            --body-bg: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --light-gray: #334155;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Reset e estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--body-bg);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .logo i {
            font-size: 2rem;
        }

        .nav-buttons {
            display: flex;
            gap: 5px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background-color: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-btn:hover {
            background-color: var(--light-gray);
            color: var(--primary);
        }

        .nav-btn.active {
            background-color: var(--primary);
            color: white;
        }

        .nav-btn i {
            font-size: 1.2rem;
        }

        .theme-toggle, .mobile-menu-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--light-gray);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .theme-toggle:hover, .mobile-menu-btn:hover {
            background-color: var(--primary);
            color: white;
        }

        .mobile-menu-btn {
            display: none;
        }

        /* Main Content */
        main {
            padding: 30px 0;
            min-height: calc(100vh - 140px);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .section-title i {
            color: var(--primary);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
        }

        /* Dashboard */
        .cycle-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .cycle-title {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .cycle-badges {
            display: flex;
            gap: 10px;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-review {
            background-color: rgba(6, 214, 160, 0.15);
            color: #06d6a0;
        }

        .badge-simulated {
            background-color: rgba(113, 9, 183, 0.15);
            color: #7209b7;
        }

        .badge-completed {
            background-color: rgba(239, 71, 111, 0.15);
            color: var(--danger);
        }

        .progress-container {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .progress-ring-container {
            position: relative;
            width: 150px;
            height: 150px;
        }

        .progress-ring {
            width: 100%;
            height: 100%;
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--light-gray);
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percentage {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .progress-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .progress-info {
            flex: 1;
            min-width: 200px;
        }

        .current-day-subjects {
            flex: 1;
            min-width: 300px;
        }

        .subject-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .subject-name {
            font-weight: 500;
        }

        .subject-name.completed {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .complete-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .complete-btn:hover {
            background-color: #05b58b;
        }

        .complete-btn.completed {
            background-color: var(--light-gray);
            color: var(--text-secondary);
        }

        .complete-btn.completed:hover {
            background-color: #d1d5db;
        }

        .cycle-days h3 {
            margin-bottom: 15px;
        }

        .cycle-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
        }

        .day-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .day-item:last-child {
            border-bottom: none;
        }

        .day-number {
            font-weight: 500;
            min-width: 70px;
        }

        .day-subject {
            flex: 1;
        }

        .day-item.completed .day-number,
        .day-item.completed .day-subject {
            color: var(--text-secondary);
        }

        .cycle-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn i {
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #e5315d;
        }

        .no-cycle, .no-cycles {
            text-align: center;
            padding: 30px 0;
        }

        .no-cycle-icon, .no-cycles-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .no-cycle h3, .no-cycles h3 {
            margin-bottom: 10px;
        }

        .no-cycle p, .no-cycles p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .cycles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .cycle-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .cycle-card:hover {
            transform: translateY(-5px);
        }

        .cycle-card-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--success);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .cycle-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .cycle-card-title {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .cycle-card-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .cycle-card-badges {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }

        .cycle-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .cycle-card-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 8px 10px;
            font-size: 0.85rem;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .overlay-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .close-overlay {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--light-gray);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .close-overlay:hover {
            background-color: var(--danger);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .form-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .form-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .form-optional {
            padding-left: 28px;
            margin-top: 10px;
        }

        /* Novo estilo para o card de adicionar matéria */
        .materia-card-form {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .slider-container {
            margin-bottom: 20px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .slider-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .slider-value {
            font-weight: 600;
            color: var(--primary);
            min-width: 40px;
            text-align: right;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--light-gray);
            outline: none;
            -webkit-appearance: none;
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
            transition: var(--transition);
        }

        .slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        .add-materia-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .add-materia-btn:hover {
            background-color: var(--primary-dark);
        }

        /* Novo estilo para os cards de matérias */
        .materia-cards-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            min-height: 200px;
        }

        .materia-cards-title {
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .materia-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .materia-card {
            display: inline-flex;
            align-items: center;
            background-color: var(--primary);
            color: white;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
            gap: 10px;
            box-shadow: var(--shadow);
        }

        .materia-percentage {
            font-weight: 600;
        }

        .delete-card-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            font-size: 0.8rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .delete-card-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .no-subjects {
            color: var(--text-secondary);
            text-align: center;
            padding: 30px 0;
            font-style: italic;
        }

        .no-subjects i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
            color: var(--primary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            background-color: var(--danger);
        }

        /* Footer */
        footer {
            background-color: var(--card-bg);
            padding: 20px 0;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .nav-buttons {
                display: none;
                position: absolute;
                top: 70px;
                left: 0;
                right: 0;
                background-color: var(--card-bg);
                flex-direction: column;
                padding: 10px 20px;
                box-shadow: var(--shadow);
            }
            
            .nav-buttons.show {
                display: flex;
            }
            
            .mobile-menu-btn {
                display: flex;
            }
            
            .progress-container {
                flex-direction: column;
                align-items: center;
            }
            
            .progress-info {
                text-align: center;
            }
            
            .cycle-actions {
                flex-direction: column;
            }
            
            .cycle-actions .btn {
                width: 100%;
            }
        }

        /* ============================================= */
        /* ESTILOS PARA EXPORTAÇÃO/IMPORTAÇÃO - NÃO ALTERAR ESTILOS EXISTENTES */
        /* ============================================= */
        
        /* Botão flutuante */
        .importExport__floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: var(--transition);
        }

        .importExport__floating-btn:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Modal */
        .importExport__modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .importExport__modal.active {
            opacity: 1;
            visibility: visible;
        }

        .importExport__modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .importExport__modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .importExport__modal-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .importExport__close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .importExport__close-btn:hover {
            background-color: var(--light-gray);
            color: var(--danger);
        }

        .importExport__section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .importExport__section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .importExport__btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            justify-content: center;
            margin-bottom: 10px;
        }

        .importExport__btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .importExport__btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .importExport__btn-secondary {
            background-color: var(--light-gray);
            color: var(--text-primary);
        }

        .importExport__btn-secondary:hover {
            background-color: #d1d5db;
        }

        .importExport__btn-success {
            background-color: var(--success);
            color: white;
        }

        .importExport__btn-success:hover {
            background-color: #05b58b;
        }

        .importExport__btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }

        .importExport__btn-warning:hover {
            background-color: #ffc745;
        }

        .importExport__btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .importExport__btn-danger:hover {
            background-color: #e5315d;
        }

        .importExport__file-input {
            width: 100%;
            padding: 15px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background-color: var(--light-gray);
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            transition: var(--transition);
        }

        .importExport__file-input:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .importExport__file-input.drag-over {
            border-color: var(--success);
            background-color: rgba(6, 214, 160, 0.1);
        }

        .importExport__textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 15px;
        }

        .importExport__status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .importExport__status.success {
            background-color: rgba(6, 214, 160, 0.15);
            border: 1px solid var(--success);
            color: #06d6a0;
            display: block;
        }

        .importExport__status.error {
            background-color: rgba(239, 71, 111, 0.15);
            border: 1px solid var(--danger);
            color: var(--danger);
            display: block;
        }

        .importExport__status.warning {
            background-color: rgba(255, 209, 102, 0.15);
            border: 1px solid var(--warning);
            color: var(--warning);
            display: block;
        }

        .importExport__progress {
            width: 100%;
            height: 8px;
            background-color: var(--light-gray);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
            display: none;
        }

        .importExport__progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .importExport__details {
            background-color: var(--light-gray);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .importExport__details-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .importExport__details-list {
            list-style: none;
            font-size: 0.9rem;
        }

        .importExport__details-list li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .importExport__details-list li:last-child {
            border-bottom: none;
        }

        .importExport__summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .importExport__summary-item {
            background-color: var(--light-gray);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .importExport__summary-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .importExport__summary-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .importExport__actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .importExport__actions .importExport__btn {
            flex: 1;
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .importExport__actions {
                flex-direction: column;
            }
            
            .importExport__summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <span>StudyFlow</span>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn active" id="dashboardBtn">
                    <i class="fas fa-home"></i>
                    <span>Ciclo Atual</span>
                </button>
                <button class="nav-btn" id="cyclesBtn">
                    <i class="fas fa-list"></i>
                    <span>Meus Ciclos</span>
                </button>
                <button class="nav-btn" id="createBtn">
                    <i class="fas fa-plus-circle"></i>
                    <span>Criar Novo</span>
                </button>
            </div>
            <div>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <!-- Dashboard -->
            <section id="dashboardSection">
                <h2 class="section-title">
                    <i class="fas fa-home"></i>
                    Ciclo de Estudo Atual
                </h2>
                <div class="card" id="dashboardCard">
                    <div class="no-cycle">
                        <div class="no-cycle-icon">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <h3>Nenhum ciclo ativo</h3>
                        <p>Crie um novo ciclo de estudos para começar</p>
                    </div>
                </div>
            </section>

            <!-- Cycles List -->
            <section id="cyclesSection" style="display: none;">
                <h2 class="section-title">
                    <i class="fas fa-list"></i>
                    Meus Ciclos de Estudo
                </h2>
                <div class="card">
                    <div id="cyclesList">
                        <div class="no-cycles">
                            <div class="no-cycles-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <h3>Nenhum ciclo encontrado</h3>
                            <p>Você ainda não criou nenhum ciclo de estudos</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Create/Edit Cycle Overlay -->
    <div class="overlay" id="cycleFormOverlay">
        <div class="overlay-content">
            <button class="close-overlay" id="closeOverlay">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="section-title" id="formTitle">
                <i class="fas fa-book"></i>
                Criar Novo Ciclo
            </h2>
            <form id="cycleForm">
                <input type="hidden" id="cycleId">
                
                <div class="form-group">
                    <label class="form-label" for="cycleName">Nome do Ciclo</label>
                    <input type="text" class="form-input" id="cycleName" placeholder="Ex: Concurso A, Mestrado..." required>
                </div>
                
                <!-- Campo para número de dias -->
                <div class="form-group">
                    <label class="form-label" for="totalDays">Quantos dias terá seu ciclo de estudos?</label>
                    <input type="number" class="form-input" id="totalDays" min="1" value="30" required>
                </div>
                
                <!-- Seção de matérias com card e lista -->
                <div class="form-group">
                    <label class="form-label">Matérias</label>
                    
                    <!-- Card para adicionar matérias -->
                    <div class="materia-card-form">
                        <div class="form-group">
                            <label class="form-label" for="materiaName">Nome da Matéria</label>
                            <input type="text" class="form-input" id="materiaName" placeholder="Ex: Matemática, Português...">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label">Peso</span>
                                <span class="slider-value" id="weightValue">1.5</span>
                            </div>
                            <input type="range" min="1" max="5" step="0.5" value="1.5" class="slider" id="weightSlider">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label">Dificuldade</span>
                                <span class="slider-value" id="importanceValue">1.5</span>
                            </div>
                            <input type="range" min="1" max="5" step="0.5" value="1.5" class="slider" id="importanceSlider">
                        </div>
                        
                        <button type="button" class="add-materia-btn" id="addMateriaBtn">
                            <i class="fas fa-plus"></i>
                            Adicionar Matéria
                        </button>
                    </div>
                    
                    <!-- Container para as matérias adicionadas -->
                    <div class="materia-cards-container">
                        <div class="materia-cards-title">Matérias Adicionadas</div>
                        <div class="materia-cards" id="materiaCards">
                            <div class="no-subjects">
                                <i class="fas fa-book"></i>
                                <p>Nenhuma matéria adicionada ainda</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-checkbox-label">
                        <input type="checkbox" class="form-checkbox" id="includeRevision">
                        Deseja incluir dia(s) de revisão?
                    </label>
                    <div class="form-optional" id="revisionDaysGroup">
                        <label class="form-label" for="revisionDays">Quantidade de dias de revisão</label>
                        <input type="number" class="form-input" id="revisionDays" min="0" value="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-checkbox-label">
                        <input type="checkbox" class="form-checkbox" id="includeSimulated">
                        Deseja incluir dia(s) de simulado?
                    </label>
                    <div class="form-optional" id="simulatedDaysGroup">
                        <label class="form-label" for="simulatedDays">Quantidade de dias de simulado</label>
                        <input type="number" class="form-input" id="simulatedDays" min="0" value="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save"></i>
                        Salvar Ciclo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Operação realizada com sucesso!</span>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>StudyFlow - Gerenciador de Ciclos de Estudo &copy; 2025</p>
        </div>
    </footer>

    <!-- ============================================= -->
    <!-- ELEMENTOS ADICIONADOS PARA EXPORTAÇÃO/IMPORTAÇÃO -->
    <!-- ============================================= -->
    
    <!-- Botão flutuante para abrir o modal -->
    <button class="importExport__floating-btn" id="importExportBtn" title="Exportar/Importar Dados">
        <i class="fas fa-database"></i>
    </button>

    <!-- Modal de exportação/importação -->
    <div class="importExport__modal" id="importExportModal">
        <div class="importExport__modal-content">
            <div class="importExport__modal-header">
                <h2 class="importExport__modal-title">
                    <i class="fas fa-database"></i>
                    Exportar/Importar Dados
                </h2>
                <button class="importExport__close-btn" id="importExportCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Seção de Exportação -->
            <div class="importExport__section">
                <h3 class="importExport__section-title">
                    <i class="fas fa-file-export"></i>
                    Exportar Dados
                </h3>
                <p style="margin-bottom: 15px; color: var(--text-secondary);">
                    Crie um backup completo de todos os seus dados. O arquivo incluirá todos os ciclos, configurações e progresso.
                </p>
                <button class="importExport__btn importExport__btn-primary" id="exportAllBtn">
                    <i class="fas fa-download"></i>
                    Exportar Todos os Dados
                </button>
                <div class="importExport__status" id="exportStatus"></div>
            </div>

            <!-- Seção de Importação -->
            <div class="importExport__section">
                <h3 class="importExport__section-title">
                    <i class="fas fa-file-import"></i>
                    Importar Dados
                </h3>
                <p style="margin-bottom: 15px; color: var(--text-secondary);">
                    Restaure seus dados a partir de um arquivo de backup. Será criado um backup automático antes da importação.
                </p>
                
                <!-- Área para arrastar e soltar arquivo -->
                <div class="importExport__file-input" id="dropArea">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Arraste e solte seu arquivo JSON aqui</p>
                    <p style="font-size: 0.9rem; margin-top: 5px;">ou clique para selecionar</p>
                    <input type="file" id="fileInput" accept=".json,application/json" style="display: none;">
                </div>
                
                <!-- Alternativa: colar JSON -->
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 500; margin-bottom: 8px; display: block;">Ou cole o JSON diretamente:</label>
                    <textarea class="importExport__textarea" id="jsonInput" placeholder="Cole o conteúdo do arquivo JSON aqui..."></textarea>
                </div>
                
                <!-- Botões de ação -->
                <button class="importExport__btn importExport__btn-secondary" id="validateBtn">
                    <i class="fas fa-search"></i>
                    Verificar Compatibilidade (Simular)
                </button>
                
                <!-- Status e informações -->
                <div class="importExport__progress" id="importProgress">
                    <div class="importExport__progress-bar" id="importProgressBar"></div>
                </div>
                
                <div class="importExport__status" id="importStatus"></div>
                
                <!-- Resumo da validação -->
                <div id="validationSummary" style="display: none;">
                    <div class="importExport__summary" id="summaryGrid"></div>
                    
                    <div class="importExport__details" id="validationDetails" style="display: none;">
                        <div class="importExport__details-title">Detalhes da Validação:</div>
                        <ul class="importExport__details-list" id="validationList"></ul>
                    </div>
                </div>
                
                <!-- Ações após validação -->
                <div class="importExport__actions" id="importActions" style="display: none;">
                    <button class="importExport__btn importExport__btn-warning" id="createBackupBtn">
                        <i class="fas fa-save"></i>
                        Criar Backup e Importar
                    </button>
                    <button class="importExport__btn importExport__btn-danger" id="cancelImportBtn">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                </div>
            </div>
            
            <!-- Informações do sistema -->
            <div class="importExport__section" style="border-bottom: none;">
                <h3 class="importExport__section-title">
                    <i class="fas fa-info-circle"></i>
                    Informações
                </h3>
                <div class="importExport__summary">
                    <div class="importExport__summary-item">
                        <div class="importExport__summary-label">Tipo de Armazenamento</div>
                        <div class="importExport__summary-value" id="storageTypeLabel">LocalStorage</div>
                    </div>
                    <div class="importExport__summary-item">
                        <div class="importExport__summary-label">Chaves no Sistema</div>
                        <div class="importExport__summary-value" id="keyCountLabel">0</div>
                    </div>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 10px;">
                    <i class="fas fa-exclamation-triangle"></i> A importação substituirá todos os dados atuais. Um backup automático será criado antes.
                </p>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // SOLUÇÃO UNIFICADA DE ARMAZENAMENTO
        // =============================================
        // Usamos um prefixo único para evitar conflitos com outras aplicações
        const STORAGE_PREFIX = 'StudyFlow_';
        
        // ======================
        // Variáveis Globais
        // ======================
        const ACTIVE_CYCLE_KEY = 'activeCycle';
        const THEME_PREFERENCE_KEY = 'themePreference';
        const ALL_CYCLES_KEY = 'allCycles';
        
        let activeCycle = null;
        let allCycles = [];
        let isDarkMode = false;
        let currentSubjects = [];

        // ======================
        // Elementos DOM
        // ======================
        const dashboardSection = document.getElementById('dashboardSection');
        const cyclesSection = document.getElementById('cyclesSection');
        const dashboardCard = document.getElementById('dashboardCard');
        const cyclesList = document.getElementById('cyclesList');
        const cycleFormOverlay = document.getElementById('cycleFormOverlay');
        const cycleForm = document.getElementById('cycleForm');
        const cycleNameInput = document.getElementById('cycleName');
        const totalDaysInput = document.getElementById('totalDays');
        const materiaNameInput = document.getElementById('materiaName');
        const weightSlider = document.getElementById('weightSlider');
        const weightValue = document.getElementById('weightValue');
        const importanceSlider = document.getElementById('importanceSlider');
        const importanceValue = document.getElementById('importanceValue');
        const materiaCardsContainer = document.getElementById('materiaCards');
        const addMateriaBtn = document.getElementById('addMateriaBtn');
        const includeRevision = document.getElementById('includeRevision');
        const revisionDaysGroup = document.getElementById('revisionDaysGroup');
        const revisionDays = document.getElementById('revisionDays');
        const includeSimulated = document.getElementById('includeSimulated');
        const simulatedDaysGroup = document.getElementById('simulatedDaysGroup');
        const simulatedDays = document.getElementById('simulatedDays');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const themeToggle = document.getElementById('themeToggle');

        // ======================
        // Inicialização
        // ======================
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar preferências de tema
            loadThemePreference();
            
            // Carregar dados do storage
            loadData();
            
            // Atualizar a interface
            updateUI();
            
            // Configurar eventos
            setupEventListeners();
            
            // Configurar eventos dos sliders
            weightSlider.addEventListener('input', updateSliderValue);
            importanceSlider.addEventListener('input', updateSliderValue);
            
            // Inicializar grupos opcionais como ocultos
            revisionDaysGroup.style.display = 'none';
            simulatedDaysGroup.style.display = 'none';
            
            // Inicializar informações do sistema de exportação/importação
            updateSystemInfo();
        });

        // ======================
        // Funções de Dados
        // ======================
        function loadData() {
            // Carregar ciclo ativo
            const activeCycleData = localStorage.getItem(STORAGE_PREFIX + ACTIVE_CYCLE_KEY);
            activeCycle = activeCycleData ? JSON.parse(activeCycleData) : null;
            
            // Carregar todos os ciclos
            const allCyclesData = localStorage.getItem(STORAGE_PREFIX + ALL_CYCLES_KEY);
            allCycles = allCyclesData ? JSON.parse(allCyclesData) : [];
            
            // Migração: se tivermos um ciclo ativo mas não na lista de todos os ciclos, adicionamos
            if (activeCycle && !allCycles.some(c => c.id === activeCycle.id)) {
                allCycles.push(activeCycle);
                saveData();
            }
        }

        function saveData() {
            // Salvar ciclo ativo
            if (activeCycle) {
                localStorage.setItem(STORAGE_PREFIX + ACTIVE_CYCLE_KEY, JSON.stringify(activeCycle));
            } else {
                localStorage.removeItem(STORAGE_PREFIX + ACTIVE_CYCLE_KEY);
            }
            
            // Salvar todos os ciclos
            localStorage.setItem(STORAGE_PREFIX + ALL_CYCLES_KEY, JSON.stringify(allCycles));
        }

        function loadThemePreference() {
            const savedTheme = localStorage.getItem(STORAGE_PREFIX + THEME_PREFERENCE_KEY);
            isDarkMode = savedTheme === 'dark';
            applyTheme();
        }

        function saveThemePreference() {
            localStorage.setItem(STORAGE_PREFIX + THEME_PREFERENCE_KEY, isDarkMode ? 'dark' : 'light');
        }

        // ======================
        // Funções de Tema
        // ======================
        function applyTheme() {
            document.body.classList.toggle('dark-theme', isDarkMode);
            themeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            saveThemePreference();
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            applyTheme();
        }

        // ======================
        // Funções de UI
        // ======================
        function updateUI() {
            // Atualizar dashboard
            renderDashboard();
            
            // Atualizar lista de ciclos
            renderCyclesList();
        }

        function renderDashboard() {
            if (activeCycle) {
                const currentDay = activeCycle.currentDay || 0;
                const totalDays = activeCycle.generatedCycle.length;
                const todaySubject = activeCycle.generatedCycle[currentDay] || 'Nenhuma matéria hoje';
                const completedSubjects = activeCycle.completedSubjects || {};
                const todayCompleted = completedSubjects[currentDay] || false;
                
                // Calcular progresso geral
                const completedCount = Object.values(completedSubjects).filter(v => v).length;
                let progressPercentage = Math.round((completedCount / totalDays) * 100);
                
                // Verificar se o ciclo foi concluído (100%)
                if (progressPercentage === 100) {
                    resetCycleProgress();
                    progressPercentage = 0; // Reset para 0% após reiniciar
                }
                
                dashboardCard.innerHTML = `
                    <div class="cycle-header">
                        <div>
                            <h2 class="cycle-title">${activeCycle.name}</h2>
                            <p>Ciclo com ${totalDays} dias de estudo</p>
                            ${activeCycle.completedCycles > 0 ? `<p><span class="badge badge-completed">Ciclos concluídos: ${activeCycle.completedCycles}</span></p>` : ''}
                        </div>
                        <div class="cycle-badges">
                            ${activeCycle.revisionDays > 0 ? `<span class="badge badge-review">${activeCycle.revisionDays} revisões</span>` : ''}
                            ${activeCycle.simulatedDays > 0 ? `<span class="badge badge-simulated">${activeCycle.simulatedDays} simulados</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-ring-container">
                            <svg class="progress-ring" viewBox="0 0 100 100">
                                <circle class="progress-ring-bg" cx="50" cy="50" r="45" />
                                <circle class="progress-ring-fill" cx="50" cy="50" r="45" />
                            </svg>
                            <div class="progress-text">
                                <span class="progress-percentage">${progressPercentage}%</span>
                                <span class="progress-label">completo</span>
                            </div>
                        </div>
                        <div class="progress-info">
                            <h3>Dia ${currentDay + 1} de ${totalDays}</h3>
                            <p>Progresso geral do ciclo</p>
                        </div>
                        
                        <div class="current-day-subjects">
                            <h3>Matéria do dia:</h3>
                            <div class="subject-item">
                                <span class="subject-name ${todayCompleted ? 'completed' : ''}">${todaySubject}</span>
                                <button class="complete-btn ${todayCompleted ? 'completed' : ''}" id="completeSubjectBtn">
                                    <i class="fas fa-${todayCompleted ? 'check' : 'check-circle'}"></i>
                                    ${todayCompleted ? 'Concluído' : 'Concluir'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cycle-days">
                        <h3>Plano de Estudo</h3>
                        <ol class="cycle-list">
                            ${activeCycle.generatedCycle.map((subject, index) => {
                                const isCompleted = activeCycle.completedSubjects?.[index] || false;
                                return `
                                    <li class="day-item ${isCompleted ? 'completed' : ''}">
                                        <span class="day-number">Dia ${index + 1}</span>
                                        <span class="day-subject">${subject}</span>
                                        ${isCompleted ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : ''}
                                    </li>
                                `;
                            }).join('')}
                        </ol>
                    </div>
                    
                    <div class="cycle-actions">
                        <button class="btn btn-secondary" id="editCycleBtn">
                            <i class="fas fa-edit"></i> Editar Ciclo
                        </button>
                        <button class="btn btn-danger" id="deleteCycleBtn">
                            <i class="fas fa-trash-alt"></i> Excluir Ciclo
                        </button>
                        <button class="btn btn-primary" id="exportCycleBtn">
                            <i class="fas fa-file-export"></i> Exportar
                        </button>
                    </div>
                `;
                
                // Atualizar a barra de progresso circular
                updateProgressRing(progressPercentage);
                
                // Adicionar eventos aos botões do dashboard
                document.getElementById('editCycleBtn')?.addEventListener('click', () => openCycleForm(activeCycle));
                document.getElementById('deleteCycleBtn')?.addEventListener('click', deleteActiveCycle);
                document.getElementById('exportCycleBtn')?.addEventListener('click', exportCycle);
                document.getElementById('completeSubjectBtn')?.addEventListener('click', toggleSubjectCompletion);
            } else {
                dashboardCard.innerHTML = `
                    <div class="no-cycle">
                        <div class="no-cycle-icon">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <h3>Nenhum ciclo ativo</h3>
                        <p>Crie um novo ciclo de estudos para começar</p>
                    </div>
                `;
            }
        }
        
        // Reiniciar o progresso do ciclo quando atingir 100%
        function resetCycleProgress() {
            if (!activeCycle) return;
            
            // Incrementar contador de ciclos completos
            activeCycle.completedCycles = (activeCycle.completedCycles || 0) + 1;
            
            // Resetar progresso
            activeCycle.currentDay = 0;
            activeCycle.completedSubjects = {};
            
            // Salvar alterações
            saveData();
            
            // Mostrar notificação
            showToast('Ciclo concluído! Progresso reiniciado.');
        }
        
        // Atualizar a barra de progresso circular
        function updateProgressRing(percentage) {
            const progressRingFill = document.querySelector('.progress-ring-fill');
            if (!progressRingFill) return;
            
            // Calcular a circunferência
            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            
            // Calcular o deslocamento com base na porcentagem
            const offset = circumference - (percentage / 100) * circumference;
            
            // Aplicar os valores
            progressRingFill.style.strokeDasharray = `${circumference} ${circumference}`;
            progressRingFill.style.strokeDashoffset = offset;
            
            // Animar
            progressRingFill.style.transition = 'stroke-dashoffset 1s ease-out';
        }

        function renderCyclesList() {
            if (allCycles.length > 0) {
                cyclesList.innerHTML = `
                    <div class="cycles-grid">
                        ${allCycles.map(cycle => `
                            <div class="cycle-card" data-id="${cycle.id}">
                                ${cycle.id === activeCycle?.id ? `<span class="cycle-card-status">Ativo</span>` : ''}
                                <div class="cycle-card-header">
                                    <h3 class="cycle-card-title">${cycle.name}</h3>
                                    <span class="cycle-card-date">${new Date(cycle.createdAt).toLocaleDateString()}</span>
                                </div>
                                <p>${cycle.subjects.length} matérias • ${cycle.generatedCycle.length} dias</p>
                                <div class="cycle-card-badges">
                                    ${cycle.revisionDays > 0 ? `<span class="badge badge-review">${cycle.revisionDays} revisões</span>` : ''}
                                    ${cycle.simulatedDays > 0 ? `<span class="badge badge-simulated">${cycle.simulatedDays} simulados</span>` : ''}
                                    ${cycle.completedCycles > 0 ? `<span class="badge badge-completed">${cycle.completedCycles} ciclos</span>` : ''}
                                </div>
                                <div class="cycle-card-actions">
                                    <button class="btn ${cycle.id === activeCycle?.id ? 'btn-success' : 'btn-secondary'} btn-set-active">
                                        <i class="fas fa-check-circle"></i> ${cycle.id === activeCycle?.id ? 'Ativo' : 'Tornar Ativo'}
                                    </button>
                                    <button class="btn btn-primary btn-edit">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-danger btn-delete">
                                        <i class="fas fa-trash-alt"></i> Excluir
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                cyclesList.innerHTML = `
                    <div class="no-cycles">
                        <div class="no-cycles-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3>Nenhum ciclo encontrado</h3>
                        <p>Você ainda não criou nenhum ciclo de estudos</p>
                    </div>
                `;
            }
        }

        // ======================
        // Funções de Ciclo de Estudos
        // ======================
        function distributeSubjects(subjects, totalDays) {
            if (subjects.length === 0) return [];
            
            // 1. Calcular prioridade para cada matéria
            let totalPriority = 0;
            subjects.forEach(subject => {
                subject.priority = (subject.weight + subject.importance) / 2;
                totalPriority += subject.priority;
            });
            
            // 2. Calcular frequência ideal (número de aparições)
            subjects.forEach(subject => {
                subject.freqIdeal = Math.round((subject.priority / totalPriority) * totalDays);
            });
            
            // 3. Ajustar frequências para soma exata de dias
            const totalFreq = subjects.reduce((sum, subject) => sum + subject.freqIdeal, 0);
            let diff = totalDays - totalFreq;
            
            // Ordenar matérias por prioridade (para ajuste de frequência)
            subjects.sort((a, b) => b.priority - a.priority);
            
            // Ajustar frequências
            let i = 0;
            while (diff !== 0) {
                if (diff > 0) {
                    subjects[i % subjects.length].freqIdeal++;
                    diff--;
                } else {
                    if (subjects[i % subjects.length].freqIdeal > 1) {
                        subjects[i % subjects.length].freqIdeal--;
                        diff++;
                    }
                }
                i++;
            }
            
            // 4. Criar lista expandida
            let expandedList = [];
            subjects.forEach(subject => {
                for (let i = 0; i < subject.freqIdeal; i++) {
                    expandedList.push(subject.name);
                }
            });
            
            // 5. Embaralhar com controle para evitar repetições consecutivas
            let schedule = [];
            let lastSubject = null;
            
            while (expandedList.length > 0) {
                // Encontrar matérias candidatas (diferentes da última)
                let candidates = expandedList.filter(subject => subject !== lastSubject);
                
                // Se não houver candidatos, permitir repetição
                if (candidates.length === 0) candidates = [...expandedList];
                
                // Escolher aleatoriamente um candidato
                const chosen = candidates[Math.floor(Math.random() * candidates.length)];
                
                // Adicionar à agenda
                schedule.push(chosen);
                lastSubject = chosen;
                
                // Remover uma ocorrência da lista expandida
                const index = expandedList.indexOf(chosen);
                if (index > -1) expandedList.splice(index, 1);
            }
            
            return schedule;
        }

        function generateStudyCycle(subjects, revisionDays = 0, simulatedDays = 0, totalDays = 30) {
            let cycle = [];
            
            // Calcular dias disponíveis para matérias
            const subjectDays = totalDays - revisionDays - simulatedDays;
            
            // Gerar distribuição de matérias
            if (subjects.length > 0) {
                cycle = distributeSubjects(subjects, subjectDays);
            } else {
                cycle = Array(subjectDays).fill("Matéria não definida");
            }
            
            // Adicionar dias de revisão
            for (let i = 1; i <= revisionDays; i++) {
                cycle.push(`Revisão ${i}`);
            }
            
            // Adicionar dias de simulado
            for (let i = 1; i <= simulatedDays; i++) {
                cycle.push(`Simulado ${i}`);
            }
            
            return cycle;
        }

        function saveCycle(cycleData) {
            const isNew = !cycleData.id;
            
            if (isNew) {
                // Novo ciclo
                cycleData.id = Date.now().toString();
                cycleData.createdAt = new Date().toISOString();
                cycleData.currentDay = 0;
                cycleData.completedSubjects = {};
                cycleData.completedCycles = 0;
                allCycles.push(cycleData);
            } else {
                // Atualizar ciclo existente
                const index = allCycles.findIndex(c => c.id === cycleData.id);
                if (index !== -1) {
                    // Preservar progresso
                    const oldCycle = allCycles[index];
                    cycleData.currentDay = oldCycle.currentDay || 0;
                    cycleData.completedSubjects = oldCycle.completedSubjects || {};
                    cycleData.completedCycles = oldCycle.completedCycles || 0;
                    allCycles[index] = cycleData;
                }
            }
            
            // Definir como ciclo ativo
            activeCycle = cycleData;
            
            // Salvar dados
            saveData();
            
            // Atualizar UI
            updateUI();
            
            // Fechar formulário
            closeCycleForm();
            
            // Mostrar notificação
            showToast(`Ciclo ${isNew ? 'criado' : 'atualizado'} com sucesso!`);
        }

        function setActiveCycle(cycleId) {
            const cycle = allCycles.find(c => c.id === cycleId);
            if (cycle) {
                activeCycle = cycle;
                saveData();
                updateUI();
                showToast('Ciclo definido como ativo!');
            }
        }

        function deleteActiveCycle() {
            if (!activeCycle) return;
            
            if (confirm('Tem certeza que deseja excluir o ciclo ativo?')) {
                deleteCycle(activeCycle.id);
                activeCycle = null;
                saveData();
                updateUI();
                showToast('Ciclo excluído com sucesso!');
            }
        }

        function deleteCycle(cycleId) {
            if (confirm('Tem certeza que deseja excluir este ciclo?')) {
                // Remover da lista de todos os ciclos
                allCycles = allCycles.filter(c => c.id !== cycleId);
                
                // Se era o ciclo ativo, remover
                if (activeCycle?.id === cycleId) {
                    activeCycle = null;
                }
                
                saveData();
                updateUI();
                showToast('Ciclo excluído com sucesso!');
            }
        }

        function exportCycle() {
            if (!activeCycle) return;
            
            // Formatar dados para exportação
            const exportData = {
                nome: activeCycle.name,
                dataCriacao: new Date(activeCycle.createdAt).toLocaleDateString(),
                ciclosCompletos: activeCycle.completedCycles || 0,
                dias: activeCycle.generatedCycle.map((subject, index) => ({
                    dia: index + 1,
                    atividade: subject,
                    concluido: activeCycle.completedSubjects?.[index] || false
                }))
            };
            
            // Criar e baixar arquivo JSON
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `${activeCycle.name.replace(/\s+/g, '_')}_ciclo_estudos.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            document.body.appendChild(linkElement);
            linkElement.click();
            document.body.removeChild(linkElement);
            
            showToast('Ciclo exportado com sucesso!');
        }
        
        function toggleSubjectCompletion() {
            if (!activeCycle) return;
            
            const currentDay = activeCycle.currentDay || 0;
            
            // Criar objeto se não existir
            if (!activeCycle.completedSubjects) {
                activeCycle.completedSubjects = {};
            }
            
            // Alternar estado de conclusão
            activeCycle.completedSubjects[currentDay] = !activeCycle.completedSubjects[currentDay];
            
            // Avançar para o próximo dia se concluído
            if (activeCycle.completedSubjects[currentDay]) {
                activeCycle.currentDay = Math.min(currentDay + 1, activeCycle.generatedCycle.length - 1);
            }
            
            // Salvar e atualizar
            saveData();
            renderDashboard();
        }

        // ======================
        // Formulário de Ciclo
        // ======================
        function openCycleForm(cycle = null) {
            // Limpar formulário
            cycleForm.reset();
            materiaCardsContainer.innerHTML = '';
            revisionDaysGroup.style.display = 'none';
            simulatedDaysGroup.style.display = 'none';
            
            // Reiniciar currentSubjects
            currentSubjects = [];
            
            // Preencher com dados existentes se for edição
            if (cycle) {
                document.getElementById('formTitle').innerHTML = `
                    <i class="fas fa-edit"></i>
                    Editar Ciclo: ${cycle.name}
                `;
                
                cycleNameInput.value = cycle.name;
                document.getElementById('cycleId').value = cycle.id;
                
                // Preencher total de dias
                totalDaysInput.value = cycle.totalDays || 
                                      (cycle.generatedCycle ? cycle.generatedCycle.length : 30) || 
                                      30;
                
                // Preencher matérias
                currentSubjects = [...cycle.subjects];
                updateMateriaCards();
                
                // Configurar revisões
                if (cycle.revisionDays > 0) {
                    includeRevision.checked = true;
                    revisionDaysGroup.style.display = 'block';
                    revisionDays.value = cycle.revisionDays;
                }
                
                // Configurar simulados
                if (cycle.simulatedDays > 0) {
                    includeSimulated.checked = true;
                    simulatedDaysGroup.style.display = 'block';
                    simulatedDays.value = cycle.simulatedDays;
                }
            } else {
                document.getElementById('formTitle').innerHTML = `
                    <i class="fas fa-book"></i>
                    Criar Novo Ciclo
                `;
                document.getElementById('cycleId').value = '';
                totalDaysInput.value = 30;
            }
            
            // Atualizar valores iniciais dos sliders
            updateSliderValue();
            
            // Mostrar overlay
            cycleFormOverlay.classList.add('active');
        }

        function closeCycleForm() {
            cycleFormOverlay.classList.remove('active');
        }

        // Atualizar os valores dos sliders
        function updateSliderValue() {
            weightValue.textContent = weightSlider.value;
            importanceValue.textContent = importanceSlider.value;
        }

        // Atualizar os cards das matérias
        function updateMateriaCards() {
            materiaCardsContainer.innerHTML = '';
            
            if (currentSubjects.length === 0) {
                materiaCardsContainer.innerHTML = `
                    <div class="no-subjects">
                        <i class="fas fa-book"></i>
                        <p>Nenhuma matéria adicionada ainda</p>
                    </div>
                `;
                return;
            }
            
            // Calcular total de prioridades
            const totalPriority = currentSubjects.reduce((sum, subject) => sum + (subject.weight + subject.importance)/2, 0);
            
            // Adicionar cards para cada matéria
            currentSubjects.forEach((subject, index) => {
                const percentage = totalPriority > 0 
                    ? Math.round(((subject.weight + subject.importance)/2 / totalPriority) * 100) 
                    : 0;
                
                const card = document.createElement('div');
                card.className = 'materia-card';
                card.innerHTML = `
                    <span class="materia-name">${subject.name}</span>
                    <span class="materia-percentage">${percentage}%</span>
                    <button type="button" class="delete-card-btn" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Adicionar evento de remoção
                const deleteBtn = card.querySelector('.delete-card-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentSubjects.splice(index, 1);
                    updateMateriaCards();
                });
                
                materiaCardsContainer.appendChild(card);
            });
        }

        function handleCycleFormSubmit(e) {
            e.preventDefault();
            
            // Validar nome do ciclo
            if (!cycleNameInput.value.trim()) {
                showToast('Por favor, insira um nome para o ciclo', 'error');
                return;
            }
            
            // Validar total de dias
            const totalDays = parseInt(totalDaysInput.value);
            if (isNaN(totalDays) || totalDays <= 0) {
                showToast('Por favor, insira um número válido de dias (maior que 0)', 'error');
                return;
            }
            
            // Validar matérias
            if (currentSubjects.length === 0) {
                showToast('Adicione pelo menos uma matéria', 'error');
                return;
            }
            
            // Coletar revisões e simulados
            const revisionDaysValue = includeRevision.checked ? parseInt(revisionDays.value) || 0 : 0;
            const simulatedDaysValue = includeSimulated.checked ? parseInt(simulatedDays.value) || 0 : 0;
            
            // Validar dias
            if (revisionDaysValue < 0 || simulatedDaysValue < 0) {
                showToast('Dias de revisão/simulado não podem ser negativos', 'error');
                return;
            }
            
            if (revisionDaysValue + simulatedDaysValue >= totalDays) {
                showToast('O número total de dias deve ser maior que a soma de dias de revisão e simulado', 'error');
                return;
            }
            
            // Gerar ciclo de estudos
            const generatedCycle = generateStudyCycle(currentSubjects, revisionDaysValue, simulatedDaysValue, totalDays);
            
            // Criar objeto do ciclo
            const cycleData = {
                id: document.getElementById('cycleId').value || Date.now().toString(),
                name: cycleNameInput.value.trim(),
                subjects: currentSubjects,
                revisionDays: revisionDaysValue,
                simulatedDays: simulatedDaysValue,
                generatedCycle,
                totalDays: totalDays,
                createdAt: document.getElementById('cycleId').value 
                    ? (activeCycle && activeCycle.createdAt) 
                    : new Date().toISOString(),
                completedCycles: document.getElementById('cycleId').value 
                    ? (activeCycle && activeCycle.completedCycles) || 0
                    : 0
            };
            
            // Salvar o ciclo
            saveCycle(cycleData);
        }

        // ======================
        // Funções Auxiliares
        // ======================
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = 'toast show';
            if (type === 'error') {
                toast.classList.add('error');
            } else {
                toast.classList.remove('error');
            }
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        // ======================
        // Configuração de Eventos
        // ======================
        function setupEventListeners() {
            // Navegação
            document.getElementById('dashboardBtn').addEventListener('click', () => {
                dashboardSection.style.display = 'block';
                cyclesSection.style.display = 'none';
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('dashboardBtn').classList.add('active');
            });
            
            document.getElementById('cyclesBtn').addEventListener('click', () => {
                dashboardSection.style.display = 'none';
                cyclesSection.style.display = 'block';
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('cyclesBtn').classList.add('active');
            });
            
            document.getElementById('createBtn').addEventListener('click', () => {
                openCycleForm();
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('createBtn').classList.add('active');
            });
            
            // Formulário
            addMateriaBtn.addEventListener('click', () => {
                const name = materiaNameInput.value.trim();
                const weight = parseFloat(weightSlider.value);
                const importance = parseFloat(importanceSlider.value);
                
                if (!name) {
                    showToast('Por favor, insira um nome para a matéria', 'error');
                    return;
                }
                
                // Adicionar ao array de matérias
                currentSubjects.push({ name, weight, importance });
               
                // Atualizar os cards
                updateMateriaCards();
                
                // Limpar o campo de nome
                materiaNameInput.value = '';
            });
            
            includeRevision.addEventListener('change', () => {
                revisionDaysGroup.style.display = includeRevision.checked ? 'block' : 'none';
            });
            
            includeSimulated.addEventListener('change', () => {
                simulatedDaysGroup.style.display = includeSimulated.checked ? 'block' : 'none';
            });
            
            cycleForm.addEventListener('submit', handleCycleFormSubmit);
            
            document.getElementById('closeOverlay').addEventListener('click', closeCycleForm);
            
            // Tema
            themeToggle.addEventListener('click', toggleTheme);
            
            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                const navButtons = document.querySelector('.nav-buttons');
                navButtons.classList.toggle('show');
            });
            
            // Event delegation para elementos dinâmicos (ciclos)
            document.addEventListener('click', (e) => {
                // Tratar botões na lista de ciclos
                if (e.target.closest('.btn-set-active')) {
                    const card = e.target.closest('.cycle-card');
                    const cycleId = card.dataset.id;
                    setActiveCycle(cycleId);
                    dashboardSection.style.display = 'block';
                    cyclesSection.style.display = 'none';
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('dashboardBtn').classList.add('active');
                }
                
                if (e.target.closest('.btn-edit')) {
                    const card = e.target.closest('.cycle-card');
                    const cycleId = card.dataset.id;
                    const cycle = allCycles.find(c => c.id === cycleId);
                    if (cycle) openCycleForm(cycle);
                }
                
                if (e.target.closest('.btn-delete')) {
                    const card = e.target.closest('.cycle-card');
                    const cycleId = card.dataset.id;
                    deleteCycle(cycleId);
                }
            });
        }

        // =============================================
        // FUNCIONALIDADE DE EXPORTAÇÃO/IMPORTAÇÃO
        // =============================================
        // IIFE para encapsular o código e evitar poluição do escopo global
        (function() {
            'use strict';
            
            // Elementos DOM da funcionalidade de exportação/importação
            const importExportBtn = document.getElementById('importExportBtn');
            const importExportModal = document.getElementById('importExportModal');
            const importExportCloseBtn = document.getElementById('importExportCloseBtn');
            const exportAllBtn = document.getElementById('exportAllBtn');
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const jsonInput = document.getElementById('jsonInput');
            const validateBtn = document.getElementById('validateBtn');
            const importProgress = document.getElementById('importProgress');
            const importProgressBar = document.getElementById('importProgressBar');
            const importStatus = document.getElementById('importStatus');
            const exportStatus = document.getElementById('exportStatus');
            const validationSummary = document.getElementById('validationSummary');
            const summaryGrid = document.getElementById('summaryGrid');
            const validationDetails = document.getElementById('validationDetails');
            const validationList = document.getElementById('validationList');
            const importActions = document.getElementById('importActions');
            const createBackupBtn = document.getElementById('createBackupBtn');
            const cancelImportBtn = document.getElementById('cancelImportBtn');
            const storageTypeLabel = document.getElementById('storageTypeLabel');
            const keyCountLabel = document.getElementById('keyCountLabel');
            
            // Variáveis de estado
            let currentImportData = null;
            let validationResult = null;
            
            // Inicializar eventos
            function initImportExport() {
                // Abrir/fechar modal
                importExportBtn.addEventListener('click', showImportExportModal);
                importExportCloseBtn.addEventListener('click', hideImportExportModal);
                
                // Fechar modal ao clicar fora
                importExportModal.addEventListener('click', function(e) {
                    if (e.target === importExportModal) {
                        hideImportExportModal();
                    }
                });
                
                // Exportar todos os dados
                exportAllBtn.addEventListener('click', exportAllData);
                
                // Área de drag and drop
                dropArea.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileSelect);
                
                // Eventos de drag and drop
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    dropArea.classList.add('drag-over');
                }
                
                function unhighlight() {
                    dropArea.classList.remove('drag-over');
                }
                
                dropArea.addEventListener('drop', handleDrop, false);
                
                // Validar dados
                validateBtn.addEventListener('click', validateImportData);
                
                // Ações de importação
                createBackupBtn.addEventListener('click', executeImportWithBackup);
                cancelImportBtn.addEventListener('click', resetImportUI);
                
                // Atualizar informações do sistema
                updateSystemInfo();
            }
            
            // Atualizar informações do sistema
            function updateSystemInfo() {
                // Detectar tipo de armazenamento (apenas localStorage neste sistema)
                storageTypeLabel.textContent = 'localStorage';
                
                // Contar chaves do StudyFlow
                const keys = Object.keys(localStorage).filter(key => key.startsWith(STORAGE_PREFIX));
                keyCountLabel.textContent = keys.length;
            }
            
            // Mostrar modal
            function showImportExportModal() {
                importExportModal.classList.add('active');
                resetImportUI();
                updateSystemInfo();
            }
            
            // Esconder modal
            function hideImportExportModal() {
                importExportModal.classList.remove('active');
            }
            
            // Exportar todos os dados
            function exportAllData() {
                try {
                    // Coletar todos os dados do localStorage com o prefixo StudyFlow_
                    const allData = {};
                    const keys = Object.keys(localStorage).filter(key => key.startsWith(STORAGE_PREFIX));
                    
                    keys.forEach(key => {
                        try {
                            allData[key] = JSON.parse(localStorage.getItem(key));
                        } catch (e) {
                            // Se não for JSON válido, armazenar como string
                            allData[key] = localStorage.getItem(key);
                        }
                    });
                    
                    // Criar objeto de exportação
                    const exportData = {
                        format_version: 1,
                        exported_at: new Date().toISOString(),
                        storage_type: 'localStorage',
                        data: allData
                    };
                    
                    // Converter para JSON
                    const jsonString = JSON.stringify(exportData, null, 2);
                    
                    // Criar e baixar arquivo
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `studyflow_backup_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Mostrar mensagem de sucesso
                    showExportStatus('Exportação concluída com sucesso! O arquivo foi baixado.', 'success');
                    
                    // Registrar no console para testes
                    console.log('Exportação realizada:', {
                        keys: keys.length,
                        tamanho: jsonString.length,
                        arquivo: a.download
                    });
                } catch (error) {
                    console.error('Erro na exportação:', error);
                    showExportStatus(`Erro na exportação: ${error.message}`, 'error');
                }
            }
            
            // Mostrar status da exportação
            function showExportStatus(message, type) {
                exportStatus.textContent = message;
                exportStatus.className = `importExport__status ${type}`;
                exportStatus.style.display = 'block';
                
                setTimeout(() => {
                    exportStatus.style.display = 'none';
                }, 5000);
            }
            
            // Manipular seleção de arquivo
            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    readFile(file);
                }
            }
            
            // Manipular drop de arquivo
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                if (file) {
                    readFile(file);
                }
            }
            
            // Ler arquivo
            function readFile(file) {
                if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                    showImportStatus('Por favor, selecione um arquivo JSON válido.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        jsonInput.value = content;
                        showImportStatus('Arquivo carregado com sucesso. Clique em "Verificar Compatibilidade".', 'success');
                    } catch (error) {
                        showImportStatus(`Erro ao ler arquivo: ${error.message}`, 'error');
                    }
                };
                reader.onerror = function() {
                    showImportStatus('Erro ao ler o arquivo.', 'error');
                };
                reader.readAsText(file);
            }
            
            // Validar dados de importação
            function validateImportData() {
                let jsonString = '';
                
                // Obter JSON do textarea ou do arquivo
                if (jsonInput.value.trim()) {
                    jsonString = jsonInput.value;
                } else {
                    showImportStatus('Por favor, cole o JSON ou selecione um arquivo.', 'warning');
                    return;
                }
                
                try {
                    // Parse do JSON
                    const importData = JSON.parse(jsonString);
                    
                    // Validar estrutura básica
                    if (!importData.format_version || importData.format_version !== 1) {
                        showImportStatus('Formato de arquivo inválido. Versão não suportada.', 'error');
                        return;
                    }
                    
                    if (!importData.storage_type || importData.storage_type !== 'localStorage') {
                        showImportStatus(`Tipo de armazenamento incompatível. Esperado: localStorage, Recebido: ${importData.storage_type || 'desconhecido'}`, 'error');
                        return;
                    }
                    
                    if (!importData.data || typeof importData.data !== 'object') {
                        showImportStatus('Dados de importação inválidos ou ausentes.', 'error');
                        return;
                    }
                    
                    // Armazenar dados para possível importação
                    currentImportData = importData;
                    
                    // Validar compatibilidade
                    validationResult = validateCompatibility(importData.data);
                    
                    // Mostrar resultados
                    showValidationResult(validationResult, importData);
                    
                } catch (error) {
                    console.error('Erro na validação:', error);
                    showImportStatus(`Erro na validação: ${error.message}`, 'error');
                }
            }
            
            // Validar compatibilidade dos dados
            function validateCompatibility(importData) {
                const result = {
                    compatible: true,
                    differences: [],
                    summary: {
                        importKeys: Object.keys(importData).length,
                        currentKeys: 0,
                        matchingKeys: 0,
                        missingKeys: 0,
                        extraKeys: 0
                    }
                };
                
                // Obter chaves atuais do sistema
                const currentKeys = Object.keys(localStorage).filter(key => key.startsWith(STORAGE_PREFIX));
                result.summary.currentKeys = currentKeys.length;
                
                // Verificar chaves do importData
                const importKeys = Object.keys(importData);
                
                // Encontrar chaves correspondentes
                for (const key of importKeys) {
                    if (currentKeys.includes(key)) {
                        result.summary.matchingKeys++;
                        
                        // Verificar tipo de dados (básico)
                        const importValue = importData[key];
                        const currentValue = localStorage.getItem(key);
                        
                        let importType = typeof importValue;
                        let currentType = 'string';
                        
                        try {
                            JSON.parse(currentValue);
                            currentType = 'object';
                        } catch (e) {
                            // Não é JSON, manter como string
                        }
                        
                        // Para objetos JSON, verificar se a análise é possível
                        if (importType === 'object' && currentType === 'string') {
                            result.compatible = false;
                            result.differences.push(`Chave "${key}": Tipo incompatível (Importação: objeto, Sistema: string)`);
                        } else if (importType !== 'object' && currentType === 'object') {
                            result.compatible = false;
                            result.differences.push(`Chave "${key}": Tipo incompatível (Importação: ${importType}, Sistema: objeto)`);
                        }
                    } else {
                        result.summary.extraKeys++;
                        result.differences.push(`Chave "${key}": Presente na importação mas não no sistema atual`);
                        // Não marcamos como incompatível apenas por ter chaves extras
                    }
                }
                
                // Encontrar chaves faltantes
                for (const key of currentKeys) {
                    if (!importKeys.includes(key)) {
                        result.summary.missingKeys++;
                        result.differences.push(`Chave "${key}": Presente no sistema mas não na importação`);
                        // Chaves faltantes tornam a importação incompatível
                        result.compatible = false;
                    }
                }
                
                return result;
            }
            
            // Mostrar resultado da validação
            function showValidationResult(result, importData) {
                // Atualizar grid de resumo
                summaryGrid.innerHTML = `
                    <div class="importExport__summary-item">
                        <div class="importExport__summary-label">Chaves na Importação</div>
                        <div class="importExport__summary-value">${result.summary.importKeys}</div>
                    </div>
                    <div class="importExport__summary-item">
                        <div class="importExport__summary-label">Chaves Atuais</div>
                        <div class="importExport__summary-value">${result.summary.currentKeys}</div>
                    </div>
                    <div class="importExport__summary-item">
                        <div class="importExport__summary-label">Chaves Correspondentes</div>
                        <div class="importExport__summary-value">${result.summary.matchingKeys}</div>
                    </div>
                    <div class="importExport__summary-item">
                        <div class="importExport__summary-label">Status</div>
                        <div class="importExport__summary-value" style="color: ${result.compatible ? 'var(--success)' : 'var(--danger)'}">
                            ${result.compatible ? 'COMPATÍVEL' : 'INCOMPATÍVEL'}
                        </div>
                    </div>
                `;
                
                // Mostrar detalhes se houver diferenças
                if (result.differences.length > 0) {
                    validationList.innerHTML = '';
                    result.differences.forEach(diff => {
                        const li = document.createElement('li');
                        li.textContent = diff;
                        validationList.appendChild(li);
                    });
                    validationDetails.style.display = 'block';
                } else {
                    validationDetails.style.display = 'none';
                }
                
                // Mostrar seção de resumo
                validationSummary.style.display = 'block';
                
                // Mostrar status
                if (result.compatible) {
                    showImportStatus('✓ Dados compatíveis! Você pode prosseguir com a importação.', 'success');
                    importActions.style.display = 'flex';
                } else {
                    showImportStatus('✗ Dados incompatíveis. Verifique as diferenças listadas abaixo.', 'error');
                    importActions.style.display = 'none';
                }
                
                // Mostrar informações adicionais
                const exportDate = importData.exported_at ? new Date(importData.exported_at).toLocaleString() : 'Desconhecida';
                console.log('Validação concluída:', {
                    compatível: result.compatible,
                    diferenças: result.differences.length,
                    dataExportação: exportDate
                });
            }
            
            // Criar backup e importar
            function executeImportWithBackup() {
                if (!currentImportData || !validationResult || !validationResult.compatible) {
                    showImportStatus('Não é possível importar: dados não validados ou incompatíveis.', 'error');
                    return;
                }
                
                // Confirmar com o usuário
                if (!confirm('ATENÇÃO: Esta ação substituirá todos os seus dados atuais. Um backup automático será criado antes. Deseja continuar?')) {
                    return;
                }
                
                // Criar backup primeiro
                createBackupBeforeImport();
                
                // Executar importação
                executeImport();
            }
            
            // Criar backup antes da importação
            function createBackupBeforeImport() {
                try {
                    // Coletar dados atuais
                    const backupData = {};
                    const keys = Object.keys(localStorage).filter(key => key.startsWith(STORAGE_PREFIX));
                    
                    keys.forEach(key => {
                        try {
                            backupData[key] = JSON.parse(localStorage.getItem(key));
                        } catch (e) {
                            backupData[key] = localStorage.getItem(key);
                        }
                    });
                    
                    // Criar objeto de backup
                    const backup = {
                        format_version: 1,
                        exported_at: new Date().toISOString(),
                        storage_type: 'localStorage',
                        data: backupData
                    };
                    
                    // Converter para JSON
                    const jsonString = JSON.stringify(backup, null, 2);
                    
                    // Criar e baixar arquivo de backup
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `studyflow_backup_pre_import_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    console.log('Backup criado antes da importação:', {
                        chaves: keys.length,
                        arquivo: a.download
                    });
                    
                } catch (error) {
                    console.error('Erro ao criar backup:', error);
                    // Continuar mesmo se o backup falhar (mas informar o usuário)
                    showImportStatus('Aviso: Não foi possível criar o backup automático, mas a importação continuará.', 'warning');
                }
            }
            
            // Executar importação
            function executeImport() {
                try {
                    // Mostrar progresso
                    importProgress.style.display = 'block';
                    importProgressBar.style.width = '0%';
                    
                    // Limpar apenas as chaves do StudyFlow
                    const keysToRemove = Object.keys(localStorage).filter(key => key.startsWith(STORAGE_PREFIX));
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    // Importar novos dados
                    const importKeys = Object.keys(currentImportData.data);
                    let processed = 0;
                    
                    importKeys.forEach(key => {
                        const value = currentImportData.data[key];
                        
                        if (typeof value === 'object' && value !== null) {
                            localStorage.setItem(key, JSON.stringify(value));
                        } else {
                            localStorage.setItem(key, value);
                        }
                        
                        processed++;
                        // Atualizar barra de progresso
                        const percent = Math.round((processed / importKeys.length) * 100);
                        importProgressBar.style.width = `${percent}%`;
                    });
                    
                    // Recarregar dados e atualizar UI
                    setTimeout(() => {
                        loadData();
                        updateUI();
                        updateSystemInfo();
                        
                        // Mostrar mensagem de sucesso
                        showImportStatus('✓ Importação concluída com sucesso! Os dados foram restaurados.', 'success');
                        
                        // Esconder barra de progresso após um tempo
                        setTimeout(() => {
                            importProgress.style.display = 'none';
                            hideImportExportModal();
                            showToast('Importação concluída com sucesso!');
                        }, 2000);
                        
                        console.log('Importação realizada:', {
                            chavesImportadas: importKeys.length,
                            dataExportação: currentImportData.exported_at
                        });
                        
                    }, 500);
                    
                } catch (error) {
                    console.error('Erro na importação:', error);
                    showImportStatus(`Erro na importação: ${error.message}`, 'error');
                    importProgress.style.display = 'none';
                    
                    // Tentar recarregar dados originais (embora o backup já tenha sido feito)
                    loadData();
                    updateUI();
                }
            }
            
            // Redefinir UI de importação
            function resetImportUI() {
                currentImportData = null;
                validationResult = null;
                jsonInput.value = '';
                fileInput.value = '';
                importStatus.style.display = 'none';
                validationSummary.style.display = 'none';
                validationDetails.style.display = 'none';
                importActions.style.display = 'none';
                importProgress.style.display = 'none';
            }
            
            // Mostrar status da importação
            function showImportStatus(message, type) {
                importStatus.textContent = message;
                importStatus.className = `importExport__status ${type}`;
                importStatus.style.display = 'block';
            }
            
            // Inicializar quando o DOM estiver pronto
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initImportExport);
            } else {
                initImportExport();
            }
            
            // =============================================
            // FUNÇÕES DE TESTE PARA CONSOLE
            // =============================================
            window.runImportExportTests = function() {
                console.log('=== INICIANDO TESTES DE EXPORTAÇÃO/IMPORTAÇÃO ===');
                
                // Teste 1: Exportação
                console.log('Teste 1: Exportação de dados...');
                try {
                    const exportData = {
                        format_version: 1,
                        exported_at: new Date().toISOString(),
                        storage_type: 'localStorage',
                        data: {}
                    };
                    
                    // Simular dados
                    const testKeys = Object.keys(localStorage).filter(key => key.startsWith(STORAGE_PREFIX));
                    testKeys.forEach(key => {
                        try {
                            exportData.data[key] = JSON.parse(localStorage.getItem(key));
                        } catch (e) {
                            exportData.data[key] = localStorage.getItem(key);
                        }
                    });
                    
                    const jsonString = JSON.stringify(exportData, null, 2);
                    console.log('✓ Teste de exportação PASSADO');
                    console.log(`  Chaves exportadas: ${testKeys.length}`);
                    console.log(`  Tamanho do JSON: ${jsonString.length} bytes`);
                    
                } catch (error) {
                    console.error('✗ Teste de exportação FALHOU:', error);
                }
                
                // Teste 2: Validação com dados idênticos
                console.log('\nTeste 2: Validação com dados idênticos...');
                try {
                    // Criar dados de teste idênticos
                    const testData = {};
                    const currentKeys = Object.keys(localStorage).filter(key => key.startsWith(STORAGE_PREFIX));
                    
                    currentKeys.forEach(key => {
                        try {
                            testData[key] = JSON.parse(localStorage.getItem(key));
                        } catch (e) {
                            testData[key] = localStorage.getItem(key);
                        }
                    });
                    
                    const validation = validateCompatibility(testData);
                    
                    if (validation.compatible) {
                        console.log('✓ Teste de validação (idêntico) PASSADO');
                        console.log(`  Chaves correspondentes: ${validation.summary.matchingKeys}`);
                    } else {
                        console.log('✗ Teste de validação (idêntico) FALHOU');
                        console.log(`  Diferenças: ${validation.differences.length}`);
                    }
                    
                } catch (error) {
                    console.error('✗ Teste de validação FALHOU:', error);
                }
                
                // Teste 3: Validação com chaves faltantes
                console.log('\nTeste 3: Validação com chaves faltantes...');
                try {
                    // Criar dados de teste com algumas chaves removidas
                    const testData = {};
                    const currentKeys = Object.keys(localStorage).filter(key => key.startsWith(STORAGE_PREFIX));
                    
                    // Remover algumas chaves (se houver pelo menos 2)
                    if (currentKeys.length >= 2) {
                        // Manter apenas a primeira metade das chaves
                        const halfKeys = Math.floor(currentKeys.length / 2);
                        for (let i = 0; i < halfKeys; i++) {
                            const key = currentKeys[i];
                            try {
                                testData[key] = JSON.parse(localStorage.getItem(key));
                            } catch (e) {
                                testData[key] = localStorage.getItem(key);
                            }
                        }
                        
                        const validation = validateCompatibility(testData);
                        
                        if (!validation.compatible && validation.summary.missingKeys > 0) {
                            console.log('✓ Teste de validação (chaves faltantes) PASSADO');
                            console.log(`  Chaves faltantes detectadas: ${validation.summary.missingKeys}`);
                        } else {
                            console.log('✗ Teste de validação (chaves faltantes) FALHOU');
                            console.log(`  Compatível: ${validation.compatible}`);
                        }
                    } else {
                        console.log('⚠ Teste de validação (chaves faltantes) PULADO - não há chaves suficientes');
                    }
                    
                } catch (error) {
                    console.error('✗ Teste de validação FALHOU:', error);
                }
                
                console.log('\n=== TESTES CONCLUÍDOS ===');
                console.log('Instruções para teste manual:');
                console.log('1. Clique no botão de banco de dados no canto inferior direito');
                console.log('2. Use "Exportar Todos os Dados" para criar um backup');
                console.log('3. Tente importar o mesmo arquivo (deve ser compatível)');
                console.log('4. Modifique o arquivo JSON para testar rejeição');
            };
            
            // Expor funções para testes (apenas em desenvolvimento)
            window._importExportUtils = {
                validateCompatibility,
                updateSystemInfo,
                exportAllData
            };
        })();

        // =============================================
        // INSTRUÇÕES DE TESTE (apenas para desenvolvedores)
        // =============================================
        // As seguintes funções estão disponíveis no console do navegador:
        // 1. runImportExportTests() - Executa testes automáticos
        // 2. _importExportUtils - Utilitários para testes avançados
        // 
        // Para testar manualmente:
        // 1. Clique no botão de banco de dados (canto inferior direito)
        // 2. Exporte os dados atuais
        // 3. Tente importar o arquivo exportado (deve funcionar)
        // 4. Modifique o arquivo JSON para testar validação
        // 5. Verifique se o backup automático é criado antes da importação

    </script>
</body>
</html>
