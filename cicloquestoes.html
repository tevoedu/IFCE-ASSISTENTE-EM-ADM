<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>estudo.ciclo ¬∑ di√°rio de quest√µes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        @supports (font-variation-settings: normal) {
            * { font-family: 'Inter var', system-ui, sans-serif; }
        }

        body {
            background-color: #0b0e14;
            color: #eef3fc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            line-height: 1.5;
        }

        .container {
            max-width: 1000px;
            width: 100%;
        }

        .app-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            gap: 1.2rem;
        }

        .logo-area h1 {
            font-size: 2rem;
            font-weight: 500;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #b8d8f0, #9bc9b2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-actions {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .btn {
            background: #20242e;
            border: 1px solid #303845;
            color: #ccd9f0;
            padding: 0.6rem 1.4rem;
            border-radius: 40px;
            font-size: 0.95rem;
            font-weight: 450;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #2d3442;
            border-color: #4d5a70;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
        }

        .btn-primary {
            background: #144a66;
            border-color: #2b6f8f;
            color: white;
        }

        .btn-primary:hover {
            background: #1e6080;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .icon-chart::before { content: "‚ñ¶"; margin-right: 0.3rem; font-size: 1.1rem; }
        .icon-download::before { content: "‚¨á"; margin-right: 0.3rem; }
        .icon-upload::before { content: "‚¨Ü"; margin-right: 0.3rem; }
        .icon-back::before { content: "‚Üê"; margin-right: 0.4rem; }
        .icon-save::before { content: "‚úì"; margin-right: 0.4rem; font-weight: bold; }
        .icon-filter::before { content: "‚åï"; margin-right: 0.3rem; font-size: 1rem; }
        .icon-check::before { content: "‚óè"; color: #6bc9a4; margin-right: 0.3rem; font-size: 1.2rem; }

        .view {
            display: none;
            opacity: 0;
            transition: opacity 0.25s;
        }

        .view.active {
            display: block;
            opacity: 1;
        }

        .card-daily {
            background: #171c26;
            border-radius: 36px;
            padding: 2.4rem 2.4rem 2rem;
            box-shadow: 0 30px 40px -20px #000000e0, 0 0 0 1px #2a3240 inset;
        }

        .daily-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .daily-header h2 {
            font-size: 2.2rem;
            font-weight: 450;
            color: #e0edff;
            letter-spacing: -0.02em;
            border-left: 6px solid #6f9fbf;
            padding-left: 1rem;
        }

        .status-badge {
            background: #1d3846;
            color: #b5e5d0;
            padding: 0.4rem 1.2rem;
            border-radius: 60px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            border: 1px solid #39748f;
        }

        .fields-container {
            display: flex;
            flex-direction: column;
            gap: 1.6rem;
            margin-bottom: 2.2rem;
        }

        .field-line {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.8rem 1rem;
        }

        .field-label {
            width: 140px;
            color: #a5bbd4;
            font-weight: 400;
            font-size: 0.98rem;
            letter-spacing: 0.3px;
        }

        .field-input {
            flex: 1;
            min-width: 200px;
            background: #1f2632;
            border: 1px solid #333d4e;
            border-radius: 26px;
            padding: 0.9rem 1.4rem;
            color: #f2f9ff;
            font-size: 1rem;
            outline: none;
            transition: 0.2s;
        }

        .field-input:focus {
            border-color: #679bb7;
            box-shadow: 0 0 0 3px #1a4055;
        }

        .field-input:disabled {
            background: #1a1f2a;
            color: #7b8aa3;
            border-color: #2f3747;
            opacity: 0.8;
        }

        .btn-save {
            background: #2b7658;
            border: none;
            color: white;
            padding: 1rem 3rem;
            border-radius: 60px;
            font-size: 1.2rem;
            font-weight: 550;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 8px 18px #0f281e;
            width: fit-content;
            margin-left: auto;
        }

        .btn-save:hover:not(:disabled) {
            background: #389b76;
            transform: scale(1.02);
            box-shadow: 0 12px 24px #0f281e;
        }

        .btn-save:disabled {
            background: #354052;
            color: #6f7d99;
            cursor: not-allowed;
            box-shadow: none;
        }

        .filters-area {
            margin-top: 1.5rem;
            border-top: 1px dashed #2d3643;
            padding-top: 1.2rem;
        }

        .filters-toggle {
            background: none;
            border: none;
            color: #9fcfb2;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0;
            border-bottom: 1px dotted #4f6f7a;
        }

        .filters-panel {
            background: #1d2531;
            border-radius: 28px;
            padding: 1.6rem;
            margin-top: 1rem;
            display: none;
            border: 1px solid #384153;
        }

        .filters-panel.show {
            display: block;
        }

        .filters-panel h4 {
            color: #bcd2ea;
            font-weight: 400;
            margin-bottom: 1.2rem;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-items {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }

        .filter-items li {
            color: #cbd8ec;
            padding-left: 1.2rem;
            position: relative;
            font-size: 0.95rem;
        }

        .filter-items li::before {
            content: "‚ñπ";
            color: #7ac9a2;
            position: absolute;
            left: 0;
        }

        .stats-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2.2rem;
        }

        .stats-header h2 {
            font-size: 2rem;
            font-weight: 450;
            color: #dae6f8;
        }

        .cards-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 0.6rem;
        }

        .stat-item-card {
            background: #171f2b;
            border-radius: 28px;
            padding: 1.6rem 2rem;
            border: 1px solid #2f3a48;
            box-shadow: 0 8px 14px #00000040;
        }

        .card-title h3 {
            font-size: 1.4rem;
            font-weight: 470;
            color: #d2e5ff;
        }

        .stat-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            align-items: center;
            margin: 1rem 0 0.5rem;
        }

        .stat-metric .value {
            font-size: 1.8rem;
            font-weight: 450;
            line-height: 1.2;
            color: #c2dcff;
        }

        .stat-metric .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #8da1c0;
            letter-spacing: 0.5px;
        }

        .progress-indicator {
            background: #263040;
            height: 10px;
            border-radius: 20px;
            width: 100%;
            max-width: 300px;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 10px;
            border-radius: 20px;
            background: linear-gradient(90deg, #5f9ea0, #7cc9a4);
        }

        .ultima-questao {
            margin-top: 0.8rem;
            font-size: 0.9rem;
            color: #a8bbd9;
            border-left: 2px solid #557a9a;
            padding-left: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .overview-card {
            background: #17212b;
            border-radius: 28px;
            padding: 1.8rem 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid #31435a;
            display: flex;
            flex-wrap: wrap;
            gap: 2rem 3rem;
        }

        .overview-item {
            display: flex;
            flex-direction: column;
        }

        .overview-item .value {
            font-size: 2.2rem;
            font-weight: 500;
            color: #d9ecff;
        }

        .overview-item .label {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #96abc7;
            letter-spacing: 0.3px;
        }

        .streak-card {
            background: #16222e;
            border-radius: 28px;
            padding: 1.4rem 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid #2d4057;
            display: flex;
            gap: 2.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .streak-item {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .streak-item .value {
            font-size: 2rem;
            font-weight: 500;
            color: #f0e68c;
        }

        .streak-item .label {
            color: #b0c6e0;
            font-size: 0.9rem;
        }

        .critical-section {
            background: #1e1f2c;
            border-radius: 28px;
            padding: 1.4rem 2rem;
            margin-bottom: 1.8rem;
            border: 1px solid #803c3c;
        }

        .critical-title {
            color: #ffb7b7;
            font-size: 1.1rem;
            font-weight: 450;
            margin-bottom: 0.8rem;
            letter-spacing: 0.3px;
        }

        .critical-list {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem 1.5rem;
        }

        .critical-list li {
            background: #2c2f3f;
            padding: 0.4rem 1.2rem;
            border-radius: 40px;
            font-size: 0.9rem;
            border-left: 4px solid #d46b6b;
        }

        .critical-message {
            color: #afc1db;
            font-style: italic;
            padding: 0.3rem 0;
        }

        .neglected-badge {
            color: #faa0a0;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 1rem;
            background: #3e2a2a;
            padding: 0.2rem 0.8rem;
            border-radius: 20px;
            display: inline-block;
            border: 1px solid #a14b4b;
        }

        .ranking-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.6rem;
        }

        .indicator-red { background-color: #d44c4c; box-shadow: 0 0 6px #d44c4c; }
        .indicator-yellow { background-color: #e0b354; box-shadow: 0 0 6px #e0b354; }
        .indicator-green { background-color: #5fb38b; box-shadow: 0 0 6px #5fb38b; }
    </style>
</head>
<body>
<div class="container">
    <div class="app-bar">
        <div class="logo-area">
            <h1>estudo.ciclo</h1>
        </div>
        <div class="nav-actions">
            <button class="btn" id="statsBtnView"><span class="icon-chart"></span>estat√≠sticas</button>
            <button class="btn" id="exportBtn"><span class="icon-download"></span>exportar</button>
            <button class="btn" id="importBtn"><span class="icon-upload"></span>importar</button>
        </div>
    </div>

    <!-- VIEW DI√ÅRIA -->
    <div id="viewDaily" class="view active">
        <div class="card-daily">
            <div class="daily-header">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <h2 id="disciplinaNome">Carregando...</h2>
                    <button class="btn" id="btnDisciplinaAnterior" style="padding: 0.3rem 0.8rem;" title="disciplina anterior">‚Üê</button>
                    <button class="btn" id="btnDisciplinaProxima" style="padding: 0.3rem 0.8rem;" title="pr√≥xima disciplina">‚Üí</button>
                </div>
                <div id="concluidoBadge" class="status-badge hidden"><span class="icon-check"></span> conclu√≠do hoje</div>
            </div>

            <div class="fields-container">
                <div class="field-line">
                    <span class="field-label">quest√µes feitas</span>
                    <input type="number" id="inputFeitas" class="field-input" min="0" value="0">
                </div>
                <div class="field-line">
                    <span class="field-label">acertos</span>
                    <input type="number" id="inputAcertos" class="field-input" min="0" value="0">
                </div>
                <div class="field-line">
                    <span class="field-label">√∫ltima quest√£o</span>
                    <input type="text" id="inputUltima" class="field-input" placeholder="ex: n¬∫ 73, org√£os p√∫blicos">
                </div>
                <div class="field-line">
                    <span class="field-label">tempo (minutos)</span>
                    <input type="number" id="inputTempo" class="field-input" min="0" value="0">
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end;">
                <button class="btn-save" id="btnSalvar"><span class="icon-save"></span>salvar bloco</button>
            </div>

            <div class="filters-area">
                <button class="filters-toggle" id="toggleFiltros"><span class="icon-filter"></span>filtros da disciplina</button>
                <div class="filters-panel" id="filtrosPanel">
                    <h4>t√≥picos para estudo</h4>
                    <ul class="filter-items" id="filtrosLista">
                        <li>carregando...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW ESTAT√çSTICAS -->
    <div id="viewStats" class="view">
        <div class="stats-header">
            <button class="btn" id="voltarDailyBtn"><span class="icon-back"></span>voltar</button>
            <h2>estat√≠sticas por disciplina</h2>
        </div>
        <div id="statsContainer"></div> <!-- substitui cards-grid para layout mais flex√≠vel -->
    </div>

    <input type="file" id="importFile" accept=".json" style="display: none;">
</div>

<script>
(function() {
    // ---------- CONFIGURA√á√ïES ----------
    const DISCIPLINAS = [
        "L√≠ngua Portuguesa",
        "Legisla√ß√£o do Servi√ßo P√∫blico Federal",
        "Racioc√≠nio L√≥gico e Matem√°tica B√°sica",
        "Inform√°tica",
        "Administra√ß√£o Geral e Administra√ß√£o P√∫blica",
        "Gest√£o de Pessoas / Comportamento Organizacional",
        "Administra√ß√£o de Recursos Materiais e Arquivologia",
        "Administra√ß√£o Financeira e Or√ßament√°ria",
        "Reda√ß√£o Oficial e Comunica√ß√£o Administrativa",
        "Atendimento ao P√∫blico e √âtica Profissional",
        "Direito Administrativo"
    ];

    const FILTROS_POR_DISCIPLINA = {
        "L√≠ngua Portuguesa": [],
        "Legisla√ß√£o do Servi√ßo P√∫blico Federal": [
            "Constitui√ß√£o ‚Äî Administra√ß√£o P√∫blica (arts. 37‚Äì41)",
            "Lei 8.112 (Regime Jur√≠dico dos Servidores)",
            "Lei 9.784 (Processo Administrativo Federal)",
            "C√≥digo de √âtica do Servidor P√∫blico",
            "Lei de cria√ß√£o dos Institutos Federais",
            "Plano de Carreira dos TAEs"
        ],
        "Racioc√≠nio L√≥gico e Matem√°tica B√°sica": [
            "Proposi√ß√µes e conectivos",
            "Implica√ß√£o e equival√™ncia l√≥gica",
            "Regras de dedu√ß√£o",
            "Aritm√©tica b√°sica",
            "Conjuntos",
            "An√°lise combinat√≥ria"
        ],
        "Inform√°tica": [
            "Hardware e software",
            "Sistemas operacionais",
            "Pacote Office / LibreOffice",
            "Arquivos e pastas",
            "Banco de dados (no√ß√µes)",
            "Internet, intranet e e-mail",
            "Seguran√ßa da informa√ß√£o",
            "Dispositivos de armazenamento"
        ],
        "Administra√ß√£o Geral e Administra√ß√£o P√∫blica": [
            "Conceitos e fun√ß√µes administrativas",
            "Teoria geral da administra√ß√£o",
            "Teoria dos sistemas",
            "Estrutura organizacional",
            "Organiza√ß√£o do trabalho administrativo",
            "Planejamento e organiza√ß√£o do trabalho",
            "Gest√£o da qualidade e melhoria de processos",
            "Sustentabilidade organizacional"
        ],
        "Gest√£o de Pessoas / Comportamento Organizacional": [
            "Rela√ß√µes humanas no trabalho",
            "Lideran√ßa e motiva√ß√£o",
            "Trabalho em equipe",
            "Recrutamento e sele√ß√£o",
            "Cargos e sal√°rios",
            "Treinamento e desenvolvimento",
            "Avalia√ß√£o de desempenho",
            "Gest√£o por compet√™ncias",
            "Decreto 9.991/2019",
            "Comportamento organizacional (grupos, conflito, negocia√ß√£o)"
        ],
        "Administra√ß√£o de Recursos Materiais e Arquivologia": [
            "Compras p√∫blicas (vis√£o administrativa)",
            "Estoques e patrim√¥nio",
            "Log√≠stica no setor p√∫blico",
            "Arquivologia e gest√£o documental",
            "Classifica√ß√£o e avalia√ß√£o documental",
            "Protocolo e processos administrativos"
        ],
        "Administra√ß√£o Financeira e Or√ßament√°ria": [
            "Or√ßamento p√∫blico",
            "Execu√ß√£o da despesa",
            "Empenho, liquida√ß√£o e pagamento"
        ],
        "Reda√ß√£o Oficial e Comunica√ß√£o Administrativa": [
            "Manual de Reda√ß√£o da Presid√™ncia",
            "Correspond√™ncias oficiais",
            "Formas de tratamento",
            "Comunica√ß√£o administrativa"
        ],
        "Atendimento ao P√∫blico e √âtica Profissional": [
            "Atendimento e postura profissional",
            "Efici√™ncia e cortesia",
            "√âtica geral e √©tica no servi√ßo p√∫blico",
            "Responsabilidade social e ambiental",
            "Conduta do servidor"
        ],
        "Direito Administrativo": [
            "Princ√≠pios da Administra√ß√£o P√∫blica",
            "Atos administrativos",
            "Administra√ß√£o p√∫blica e servidores",
            "Normas constitucionais da Administra√ß√£o P√∫blica",
            "Licita√ß√µes e contratos (Lei 14.133)"
        ]
    };

    // ---------- CHAVE EXCLUSIVA DO CICLO ----------
    const CICLO_STORAGE_KEY = 'estudoCicloData';

    // ---------- FUN√á√ïES DE DATA ----------
    function obterDataStringHoje() {
        const d = new Date();
        return [String(d.getDate()).padStart(2,'0'), String(d.getMonth()+1).padStart(2,'0'), d.getFullYear()].join('-');
    }

    function getCalendarDateString() {
        const d = new Date();
        return `${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;
    }

    // ---------- GERENCIAMENTO DOS DADOS DO CICLO ----------
    function carregarDados() {
        let dados = localStorage.getItem(CICLO_STORAGE_KEY);
        if (dados) {
            try {
                dados = JSON.parse(dados);
                if (!dados.disciplinas || !Array.isArray(dados.disciplinas)) throw new Error();
            } catch {
                dados = null;
            }
        }
        if (!dados) {
            dados = {
                disciplinas: DISCIPLINAS.map(nome => ({
                    nome: nome,
                    feitas: 0,
                    acertos: 0,
                    ultimaQuestao: '',
                    tempo: 0
                })),
                ciclo: {
                    indice: 0,
                    dataUltimoRegistro: obterDataStringHoje(),
                    concluidoHoje: false
                }
            };
        }
        if (!dados.ciclo.streakAtual) dados.ciclo.streakAtual = 0;
        if (!dados.ciclo.maiorStreak) dados.ciclo.maiorStreak = 0;
        return dados;
    }

    function atualizarCiclo(dados) {
        const hoje = obterDataStringHoje();
        if (dados.ciclo.dataUltimoRegistro !== hoje) {
            dados.ciclo.dataUltimoRegistro = hoje;
            dados.ciclo.concluidoHoje = false;
        }
        return dados;
    }

    function registrarNoCalendario(disciplinaNome, minutos) {
        if (!minutos || minutos <= 0) return;
        const calendarDate = getCalendarDateString();
        const sessionKey = `sessions-${calendarDate}`;
        let sessions = [];
        try {
            const raw = localStorage.getItem(sessionKey);
            if (raw) sessions = JSON.parse(raw);
            if (!Array.isArray(sessions)) sessions = [];
        } catch (e) {
            sessions = [];
        }
        const novaSessao = {
            subject: `Quest√µes ‚Äì ${disciplinaNome}`,
            minutes: minutos,
            date: calendarDate,
            timestamp: new Date().toISOString()
        };
        sessions.push(novaSessao);
        localStorage.setItem(sessionKey, JSON.stringify(sessions));
        try {
            let custom = JSON.parse(localStorage.getItem('customSubjects') || '[]');
            if (!Array.isArray(custom)) custom = [];
            if (!custom.includes(disciplinaNome)) {
                custom.push(disciplinaNome);
                localStorage.setItem('customSubjects', JSON.stringify(custom));
            }
        } catch (e) {}
    }

    // ---------- STREAK ----------
    function calcularEAtualizarStreak() {
        const todayStr = getCalendarDateString();
        const [d, m, y] = todayStr.split('-').map(Number);
        const todayDate = new Date(y, m-1, d);
        const sessionDates = new Set();

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('sessions-')) {
                const datePart = key.replace('sessions-', '');
                try {
                    const sessions = JSON.parse(localStorage.getItem(key));
                    if (Array.isArray(sessions) && sessions.length > 0) {
                        sessionDates.add(datePart);
                    }
                } catch (e) {}
            }
        }

        let currentStreak = 0;
        let checkDate = new Date(todayDate);
        while (true) {
            const dateStr = `${checkDate.getDate()}-${checkDate.getMonth()+1}-${checkDate.getFullYear()}`;
            if (sessionDates.has(dateStr)) {
                currentStreak++;
                checkDate.setDate(checkDate.getDate() - 1);
            } else {
                break;
            }
        }

        dadosEstudo.ciclo.streakAtual = currentStreak;
        if (currentStreak > dadosEstudo.ciclo.maiorStreak) {
            dadosEstudo.ciclo.maiorStreak = currentStreak;
        }
        localStorage.setItem(CICLO_STORAGE_KEY, JSON.stringify(dadosEstudo));
    }

    // ---------- NEGLIGENCIADA ----------
    function disciplinaNegligenciada(disciplinaNome) {
        const hoje = new Date();
        hoje.setHours(0,0,0,0);
        const seteDiasAtras = new Date(hoje);
        seteDiasAtras.setDate(hoje.getDate() - 6);
        const datasSet = new Set();

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('sessions-')) {
                const datePart = key.replace('sessions-', '');
                const [d, m, y] = datePart.split('-').map(Number);
                const dataSessao = new Date(y, m-1, d);
                if (dataSessao >= seteDiasAtras && dataSessao <= hoje) {
                    datasSet.add(datePart);
                }
            }
        }

        for (let dataStr of datasSet) {
            const key = `sessions-${dataStr}`;
            try {
                const sessions = JSON.parse(localStorage.getItem(key));
                if (Array.isArray(sessions)) {
                    for (let s of sessions) {
                        if (s.subject && s.subject.includes(disciplinaNome)) {
                            return false;
                        }
                    }
                }
            } catch (e) {}
        }
        return true;
    }

    // ---------- ESTADO GLOBAL ----------
    let dadosEstudo = carregarDados();
    dadosEstudo = atualizarCiclo(dadosEstudo);
    localStorage.setItem(CICLO_STORAGE_KEY, JSON.stringify(dadosEstudo));

    const viewDaily = document.getElementById('viewDaily');
    const viewStats = document.getElementById('viewStats');
    const statsBtn = document.getElementById('statsBtnView');
    const voltarBtn = document.getElementById('voltarDailyBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const btnSalvar = document.getElementById('btnSalvar');
    const toggleFiltros = document.getElementById('toggleFiltros');
    const filtrosPanel = document.getElementById('filtrosPanel');
    const filtrosLista = document.getElementById('filtrosLista');
    const elNomeDisciplina = document.getElementById('disciplinaNome');
    const elConcluidoBadge = document.getElementById('concluidoBadge');
    const inputFeitas = document.getElementById('inputFeitas');
    const inputAcertos = document.getElementById('inputAcertos');
    const inputUltima = document.getElementById('inputUltima');
    const inputTempo = document.getElementById('inputTempo');
    const statsContainer = document.getElementById('statsContainer');
    const btnAnterior = document.getElementById('btnDisciplinaAnterior');
    const btnProxima = document.getElementById('btnDisciplinaProxima');

    function avancarDisciplina() {
        if (dadosEstudo.ciclo.concluidoHoje) {
            alert('Conclua o bloco de hoje antes de mudar de disciplina.');
            return;
        }
        const total = DISCIPLINAS.length;
        dadosEstudo.ciclo.indice = (dadosEstudo.ciclo.indice + 1) % total;
        localStorage.setItem(CICLO_STORAGE_KEY, JSON.stringify(dadosEstudo));
        carregarInterfaceDaily();
    }

    function voltarDisciplina() {
        if (dadosEstudo.ciclo.concluidoHoje) {
            alert('Conclua o bloco de hoje antes de mudar de disciplina.');
            return;
        }
        const total = DISCIPLINAS.length;
        dadosEstudo.ciclo.indice = (dadosEstudo.ciclo.indice - 1 + total) % total;
        localStorage.setItem(CICLO_STORAGE_KEY, JSON.stringify(dadosEstudo));
        carregarInterfaceDaily();
    }

    function carregarInterfaceDaily() {
        const indice = dadosEstudo.ciclo.indice;
        const disciplina = DISCIPLINAS[indice];
        elNomeDisciplina.textContent = disciplina;

        const dadosDisc = dadosEstudo.disciplinas.find(d => d.nome === disciplina);
        inputUltima.value = (dadosDisc && dadosDisc.ultimaQuestao) || '';

        inputFeitas.value = 0;
        inputAcertos.value = 0;
        inputTempo.value = 0;

        const concluido = dadosEstudo.ciclo.concluidoHoje;
        if (concluido) {
            elConcluidoBadge.classList.remove('hidden');
            [inputFeitas, inputAcertos, inputUltima, inputTempo].forEach(i => i.disabled = true);
            btnSalvar.disabled = true;
            if (btnAnterior) btnAnterior.disabled = true;
            if (btnProxima) btnProxima.disabled = true;
        } else {
            elConcluidoBadge.classList.add('hidden');
            [inputFeitas, inputAcertos, inputUltima, inputTempo].forEach(i => i.disabled = false);
            btnSalvar.disabled = false;
            if (btnAnterior) btnAnterior.disabled = false;
            if (btnProxima) btnProxima.disabled = false;
        }

        const filtros = FILTROS_POR_DISCIPLINA[disciplina] || [];
        filtrosLista.innerHTML = '';
        if (filtros.length === 0) {
            filtrosLista.innerHTML = '<li>sem t√≥picos espec√≠ficos</li>';
        } else {
            filtros.forEach(f => {
                const li = document.createElement('li');
                li.textContent = f;
                filtrosLista.appendChild(li);
            });
        }
        filtrosPanel.classList.remove('show');
    }

    function atualizarStats() {
        calcularEAtualizarStreak();
        const disciplinas = dadosEstudo.disciplinas;
        const totalQuestoes = disciplinas.reduce((acc, d) => acc + d.feitas, 0);
        const totalAcertos = disciplinas.reduce((acc, d) => acc + d.acertos, 0);
        const totalTempo = disciplinas.reduce((acc, d) => acc + d.tempo, 0);
        const percGeral = totalQuestoes > 0 ? (totalAcertos / totalQuestoes * 100).toFixed(1) : '0.0';
        const tempoMedioGeral = totalQuestoes > 0 ? (totalTempo / totalQuestoes).toFixed(1) : '0.0';

        let html = `
            <div class="overview-card">
                <div class="overview-item"><span class="value">${totalQuestoes}</span><span class="label">quest√µes totais</span></div>
                <div class="overview-item"><span class="value">${totalAcertos}</span><span class="label">acertos totais</span></div>
                <div class="overview-item"><span class="value">${percGeral}%</span><span class="label">aproveitamento geral</span></div>
                <div class="overview-item"><span class="value">${Math.floor(totalTempo/60)}h ${totalTempo%60}m</span><span class="label">tempo acumulado</span></div>
                <div class="overview-item"><span class="value">${tempoMedioGeral} min</span><span class="label">m√©dio por quest√£o</span></div>
            </div>
            <div class="streak-card">
                <div class="streak-item"><span class="value">${dadosEstudo.ciclo.streakAtual}</span><span class="label">dias consecutivos</span></div>
                <div class="streak-item"><span class="value">${dadosEstudo.ciclo.maiorStreak}</span><span class="label">maior streak</span></div>
            </div>
        `;

        const disciplinasComPerc = disciplinas.map(d => {
            const perc = d.feitas > 0 ? (d.acertos / d.feitas * 100) : 0;
            return { ...d, perc };
        });

        const criticas = disciplinasComPerc.filter(d => d.perc < 70);
        html += `<div class="critical-section"><div class="critical-title">üìå disciplinas cr√≠ticas (&lt;70%)</div>`;
        if (criticas.length === 0) {
            html += `<div class="critical-message">Nenhuma disciplina cr√≠tica no momento</div>`;
        } else {
            html += `<ul class="critical-list">`;
            criticas.forEach(c => {
                html += `<li>${c.nome} (${c.perc.toFixed(1)}%)</li>`;
            });
            html += `</ul>`;
        }
        html += `</div>`;

        const ordenadas = disciplinasComPerc.sort((a, b) => a.perc - b.perc);

        ordenadas.forEach(d => {
            const total = d.feitas;
            const acertos = d.acertos;
            const perc = d.perc.toFixed(1);
            const tempoHoras = Math.floor(d.tempo / 60);
            const tempoMin = d.tempo % 60;
            const tempoStr = tempoHoras > 0 ? `${tempoHoras}h ${tempoMin}m` : `${tempoMin}m`;
            const tempoMedio = d.feitas > 0 ? (d.tempo / d.feitas).toFixed(1) : '0.0';
            const negligenciada = disciplinaNegligenciada(d.nome);
            let indicadorCor = '';
            if (d.perc < 60) indicadorCor = 'indicator-red';
            else if (d.perc < 80) indicadorCor = 'indicator-yellow';
            else indicadorCor = 'indicator-green';

            html += `
                <div class="stat-item-card">
                    <div class="card-title">
                        <h3><span class="ranking-indicator ${indicadorCor}"></span>${d.nome}
                        ${negligenciada ? '<span class="neglected-badge">‚ö† negligenciada</span>' : ''}
                        </h3>
                    </div>
                    <div class="stat-metrics">
                        <div class="stat-metric"><span class="value">${perc}%</span><span class="label">aproveitamento</span></div>
                        <div class="stat-metric"><span class="value">${total}</span><span class="label">quest√µes</span></div>
                        <div class="stat-metric"><span class="value">${tempoStr}</span><span class="label">tempo</span></div>
                        <div class="stat-metric"><span class="value">${tempoMedio} min</span><span class="label">m√©dio/q</span></div>
                    </div>
                    <div class="progress-indicator"><div class="progress-fill" style="width:${d.perc}%"></div></div>
                    <div class="ultima-questao">√∫ltima: ${d.ultimaQuestao || '‚Äî'}</div>
                </div>
            `;
        });

        statsContainer.innerHTML = html;
    }

    function abrirStats() {
        atualizarStats();
        viewDaily.classList.remove('active');
        viewStats.classList.add('active');
    }

    function fecharStats() {
        viewStats.classList.remove('active');
        viewDaily.classList.add('active');
        carregarInterfaceDaily();
    }

    function salvarHandler() {
        if (dadosEstudo.ciclo.concluidoHoje) {
            alert('Voc√™ j√° concluiu o bloco de hoje.');
            return;
        }

        const feitas = parseInt(inputFeitas.value, 10);
        const acertos = parseInt(inputAcertos.value, 10);
        const ultima = inputUltima.value.trim();
        const tempo = parseInt(inputTempo.value, 10);

        if (isNaN(feitas) || feitas < 0 || isNaN(acertos) || acertos < 0 || isNaN(tempo) || tempo < 0) {
            alert('Preencha valores v√°lidos.');
            return;
        }
        if (acertos > feitas) {
            alert('Acertos n√£o podem ser maiores que quest√µes feitas.');
            return;
        }

        const indice = dadosEstudo.ciclo.indice;
        const disciplina = DISCIPLINAS[indice];
        const dadosDisc = dadosEstudo.disciplinas.find(d => d.nome === disciplina);
        if (dadosDisc) {
            dadosDisc.feitas += feitas;
            dadosDisc.acertos += acertos;
            if (ultima) dadosDisc.ultimaQuestao = ultima;
            dadosDisc.tempo += tempo;
        }

        dadosEstudo.ciclo.concluidoHoje = true;
        dadosEstudo.ciclo.dataUltimoRegistro = obterDataStringHoje();
        localStorage.setItem(CICLO_STORAGE_KEY, JSON.stringify(dadosEstudo));

        if (tempo > 0) {
            registrarNoCalendario(disciplina, tempo);
        }

        calcularEAtualizarStreak();
        carregarInterfaceDaily();
    }

    function exportarDados() {
        const cicloData = localStorage.getItem(CICLO_STORAGE_KEY);
        if (!cicloData) return;
        const blob = new Blob([JSON.stringify({ [CICLO_STORAGE_KEY]: cicloData }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ciclo-backup-${obterDataStringHoje()}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importarDados(arquivo) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (imported[CICLO_STORAGE_KEY]) {
                    localStorage.setItem(CICLO_STORAGE_KEY, imported[CICLO_STORAGE_KEY]);
                    alert('Dados do ciclo importados. Recarregue a p√°gina.');
                    location.reload();
                } else {
                    alert('Arquivo inv√°lido: n√£o cont√©m dados do ciclo.');
                }
            } catch {
                alert('Arquivo corrompido.');
            }
        };
        reader.readAsText(arquivo);
    }

    statsBtn.addEventListener('click', abrirStats);
    voltarBtn.addEventListener('click', fecharStats);
    exportBtn.addEventListener('click', exportarDados);
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', (e) => {
        if (e.target.files[0]) importarDados(e.target.files[0]);
        importFile.value = '';
    });
    btnSalvar.addEventListener('click', salvarHandler);
    toggleFiltros.addEventListener('click', (e) => {
        e.preventDefault();
        filtrosPanel.classList.toggle('show');
    });

    if (btnAnterior) btnAnterior.addEventListener('click', voltarDisciplina);
    if (btnProxima) btnProxima.addEventListener('click', avancarDisciplina);

    carregarInterfaceDaily();

    window.addEventListener('storage', (e) => {
        if (e.key === CICLO_STORAGE_KEY) {
            dadosEstudo = JSON.parse(e.newValue);
            carregarInterfaceDaily();
        }
    });
})();
</script>
</body>
</html>
