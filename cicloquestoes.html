<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>estudo.ciclo · diário de questões</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        @supports (font-variation-settings: normal) {
            * { font-family: 'Inter var', system-ui, sans-serif; }
        }

        body {
            background-color: #0b0e14;
            color: #eef3fc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            line-height: 1.5;
        }

        .container {
            max-width: 1000px;
            width: 100%;
        }

        .app-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            gap: 1.2rem;
        }

        .logo-area h1 {
            font-size: 2rem;
            font-weight: 500;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #b8d8f0, #9bc9b2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-actions {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .btn {
            background: #20242e;
            border: 1px solid #303845;
            color: #ccd9f0;
            padding: 0.6rem 1.4rem;
            border-radius: 40px;
            font-size: 0.95rem;
            font-weight: 450;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #2d3442;
            border-color: #4d5a70;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
        }

        .btn-primary {
            background: #144a66;
            border-color: #2b6f8f;
            color: white;
        }

        .btn-primary:hover {
            background: #1e6080;
        }

        .icon-chart::before { content: "▦"; margin-right: 0.3rem; font-size: 1.1rem; }
        .icon-download::before { content: "⬇"; margin-right: 0.3rem; }
        .icon-upload::before { content: "⬆"; margin-right: 0.3rem; }
        .icon-back::before { content: "←"; margin-right: 0.4rem; }
        .icon-save::before { content: "✓"; margin-right: 0.4rem; font-weight: bold; }
        .icon-filter::before { content: "⌕"; margin-right: 0.3rem; font-size: 1rem; }
        .icon-check::before { content: "●"; color: #6bc9a4; margin-right: 0.3rem; font-size: 1.2rem; }

        .view {
            display: none;
            opacity: 0;
            transition: opacity 0.25s;
        }

        .view.active {
            display: block;
            opacity: 1;
        }

        .card-daily {
            background: #171c26;
            border-radius: 36px;
            padding: 2.4rem 2.4rem 2rem;
            box-shadow: 0 30px 40px -20px #000000e0, 0 0 0 1px #2a3240 inset;
        }

        .daily-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .daily-header h2 {
            font-size: 2.2rem;
            font-weight: 450;
            color: #e0edff;
            letter-spacing: -0.02em;
            border-left: 6px solid #6f9fbf;
            padding-left: 1rem;
        }

        .status-badge {
            background: #1d3846;
            color: #b5e5d0;
            padding: 0.4rem 1.2rem;
            border-radius: 60px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            border: 1px solid #39748f;
        }

        .fields-container {
            display: flex;
            flex-direction: column;
            gap: 1.6rem;
            margin-bottom: 2.2rem;
        }

        .field-line {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.8rem 1rem;
        }

        .field-label {
            width: 140px;
            color: #a5bbd4;
            font-weight: 400;
            font-size: 0.98rem;
            letter-spacing: 0.3px;
        }

        .field-input {
            flex: 1;
            min-width: 200px;
            background: #1f2632;
            border: 1px solid #333d4e;
            border-radius: 26px;
            padding: 0.9rem 1.4rem;
            color: #f2f9ff;
            font-size: 1rem;
            outline: none;
            transition: 0.2s;
        }

        .field-input:focus {
            border-color: #679bb7;
            box-shadow: 0 0 0 3px #1a4055;
        }

        .field-input:disabled {
            background: #1a1f2a;
            color: #7b8aa3;
            border-color: #2f3747;
            opacity: 0.8;
        }

        .btn-save {
            background: #2b7658;
            border: none;
            color: white;
            padding: 1rem 3rem;
            border-radius: 60px;
            font-size: 1.2rem;
            font-weight: 550;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 8px 18px #0f281e;
            width: fit-content;
            margin-left: auto;
        }

        .btn-save:hover:not(:disabled) {
            background: #389b76;
            transform: scale(1.02);
            box-shadow: 0 12px 24px #0f281e;
        }

        .btn-save:disabled {
            background: #354052;
            color: #6f7d99;
            cursor: not-allowed;
            box-shadow: none;
        }

        .filters-area {
            margin-top: 1.5rem;
            border-top: 1px dashed #2d3643;
            padding-top: 1.2rem;
        }

        .filters-toggle {
            background: none;
            border: none;
            color: #9fcfb2;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0;
            border-bottom: 1px dotted #4f6f7a;
        }

        .filters-panel {
            background: #1d2531;
            border-radius: 28px;
            padding: 1.6rem;
            margin-top: 1rem;
            display: none;
            border: 1px solid #384153;
        }

        .filters-panel.show {
            display: block;
        }

        .filters-panel h4 {
            color: #bcd2ea;
            font-weight: 400;
            margin-bottom: 1.2rem;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-items {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }

        .filter-items li {
            color: #cbd8ec;
            padding-left: 1.2rem;
            position: relative;
            font-size: 0.95rem;
        }

        .filter-items li::before {
            content: "▹";
            color: #7ac9a2;
            position: absolute;
            left: 0;
        }

        .stats-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2.2rem;
        }

        .stats-header h2 {
            font-size: 2rem;
            font-weight: 450;
            color: #dae6f8;
        }

        .cards-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 0.6rem;
        }

        .stat-item-card {
            background: #171f2b;
            border-radius: 28px;
            padding: 1.6rem 2rem;
            border: 1px solid #2f3a48;
            box-shadow: 0 8px 14px #00000040;
        }

        .card-title h3 {
            font-size: 1.4rem;
            font-weight: 470;
            color: #d2e5ff;
        }

        .stat-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            align-items: center;
            margin: 1rem 0 0.5rem;
        }

        .stat-metric .value {
            font-size: 1.8rem;
            font-weight: 450;
            line-height: 1.2;
            color: #c2dcff;
        }

        .stat-metric .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #8da1c0;
            letter-spacing: 0.5px;
        }

        .progress-indicator {
            background: #263040;
            height: 10px;
            border-radius: 20px;
            width: 100%;
            max-width: 300px;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 10px;
            border-radius: 20px;
            background: linear-gradient(90deg, #5f9ea0, #7cc9a4);
        }

        .ultima-questao {
            margin-top: 0.8rem;
            font-size: 0.9rem;
            color: #a8bbd9;
            border-left: 2px solid #557a9a;
            padding-left: 1rem;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="app-bar">
        <div class="logo-area">
            <h1>estudo.ciclo</h1>
        </div>
        <div class="nav-actions">
            <button class="btn" id="statsBtnView"><span class="icon-chart"></span>estatísticas</button>
            <button class="btn" id="exportBtn"><span class="icon-download"></span>exportar</button>
            <button class="btn" id="importBtn"><span class="icon-upload"></span>importar</button>
        </div>
    </div>

    <!-- VIEW DIÁRIA -->
    <div id="viewDaily" class="view active">
        <div class="card-daily">
            <div class="daily-header">
                <h2 id="disciplinaNome">Carregando...</h2>
                <div id="concluidoBadge" class="status-badge hidden"><span class="icon-check"></span> concluído hoje</div>
            </div>

            <div class="fields-container">
                <div class="field-line">
                    <span class="field-label">questões feitas</span>
                    <input type="number" id="inputFeitas" class="field-input" min="0" value="0">
                </div>
                <div class="field-line">
                    <span class="field-label">acertos</span>
                    <input type="number" id="inputAcertos" class="field-input" min="0" value="0">
                </div>
                <div class="field-line">
                    <span class="field-label">última questão</span>
                    <input type="text" id="inputUltima" class="field-input" placeholder="ex: nº 73, orgãos públicos">
                </div>
                <div class="field-line">
                    <span class="field-label">tempo (minutos)</span>
                    <input type="number" id="inputTempo" class="field-input" min="0" value="0">
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end;">
                <button class="btn-save" id="btnSalvar"><span class="icon-save"></span>salvar bloco</button>
            </div>

            <div class="filters-area">
                <button class="filters-toggle" id="toggleFiltros"><span class="icon-filter"></span>filtros da disciplina</button>
                <div class="filters-panel" id="filtrosPanel">
                    <h4>tópicos para estudo</h4>
                    <ul class="filter-items" id="filtrosLista">
                        <li>carregando...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW ESTATÍSTICAS -->
    <div id="viewStats" class="view">
        <div class="stats-header">
            <button class="btn" id="voltarDailyBtn"><span class="icon-back"></span>voltar</button>
            <h2>estatísticas por disciplina</h2>
        </div>
        <div class="cards-grid" id="statsCardsContainer"></div>
    </div>

    <input type="file" id="importFile" accept=".json" style="display: none;">
</div>

<script>
(function() {
    // ---------- CONFIGURAÇÕES ----------
    const DISCIPLINAS = [
        "Língua Portuguesa",
        "Legislação do Serviço Público Federal",
        "Raciocínio Lógico e Matemática Básica",
        "Informática",
        "Administração Geral e Administração Pública",
        "Gestão de Pessoas / Comportamento Organizacional",
        "Administração de Recursos Materiais e Arquivologia",
        "Administração Financeira e Orçamentária",
        "Redação Oficial e Comunicação Administrativa",
        "Atendimento ao Público e Ética Profissional",
        "Direito Administrativo"
    ];

    const FILTROS_POR_DISCIPLINA = {
        "Língua Portuguesa": [],
        "Legislação do Serviço Público Federal": [
            "Constituição — Administração Pública (arts. 37–41)",
            "Lei 8.112 (Regime Jurídico dos Servidores)",
            "Lei 9.784 (Processo Administrativo Federal)",
            "Código de Ética do Servidor Público",
            "Lei de criação dos Institutos Federais",
            "Plano de Carreira dos TAEs"
        ],
        "Raciocínio Lógico e Matemática Básica": [
            "Proposições e conectivos",
            "Implicação e equivalência lógica",
            "Regras de dedução",
            "Aritmética básica",
            "Conjuntos",
            "Análise combinatória"
        ],
        "Informática": [
            "Hardware e software",
            "Sistemas operacionais",
            "Pacote Office / LibreOffice",
            "Arquivos e pastas",
            "Banco de dados (noções)",
            "Internet, intranet e e-mail",
            "Segurança da informação",
            "Dispositivos de armazenamento"
        ],
        "Administração Geral e Administração Pública": [
            "Conceitos e funções administrativas",
            "Teoria geral da administração",
            "Teoria dos sistemas",
            "Estrutura organizacional",
            "Organização do trabalho administrativo",
            "Planejamento e organização do trabalho",
            "Gestão da qualidade e melhoria de processos",
            "Sustentabilidade organizacional"
        ],
        "Gestão de Pessoas / Comportamento Organizacional": [
            "Relações humanas no trabalho",
            "Liderança e motivação",
            "Trabalho em equipe",
            "Recrutamento e seleção",
            "Cargos e salários",
            "Treinamento e desenvolvimento",
            "Avaliação de desempenho",
            "Gestão por competências",
            "Decreto 9.991/2019",
            "Comportamento organizacional (grupos, conflito, negociação)"
        ],
        "Administração de Recursos Materiais e Arquivologia": [
            "Compras públicas (visão administrativa)",
            "Estoques e patrimônio",
            "Logística no setor público",
            "Arquivologia e gestão documental",
            "Classificação e avaliação documental",
            "Protocolo e processos administrativos"
        ],
        "Administração Financeira e Orçamentária": [
            "Orçamento público",
            "Execução da despesa",
            "Empenho, liquidação e pagamento"
        ],
        "Redação Oficial e Comunicação Administrativa": [
            "Manual de Redação da Presidência",
            "Correspondências oficiais",
            "Formas de tratamento",
            "Comunicação administrativa"
        ],
        "Atendimento ao Público e Ética Profissional": [
            "Atendimento e postura profissional",
            "Eficiência e cortesia",
            "Ética geral e ética no serviço público",
            "Responsabilidade social e ambiental",
            "Conduta do servidor"
        ],
        "Direito Administrativo": [
            "Princípios da Administração Pública",
            "Atos administrativos",
            "Administração pública e servidores",
            "Normas constitucionais da Administração Pública",
            "Licitações e contratos (Lei 14.133)"
        ]
    };

    // ---------- CHAVE EXCLUSIVA DO CICLO ----------
    const CICLO_STORAGE_KEY = 'estudoCicloData';

    // ---------- FUNÇÕES DE DATA ----------
    function obterDataStringHoje() {
        const d = new Date();
        // Formato para o ciclo (com zeros, pode ser qualquer um, só não interfere)
        return [String(d.getDate()).padStart(2,'0'), String(d.getMonth()+1).padStart(2,'0'), d.getFullYear()].join('-');
    }

    // Formato EXATO usado pelo calendário: sem zeros (ex: 14-2-2026)
    function getCalendarDateString() {
        const d = new Date();
        return `${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;
    }

    function diferencaDias(dataStr1, dataStr2) {
        const [d1,m1,a1] = dataStr1.split('-').map(Number);
        const [d2,m2,a2] = dataStr2.split('-').map(Number);
        const date1 = new Date(a1,m1-1,d1);
        const date2 = new Date(a2,m2-1,d2);
        return Math.floor((date2 - date1) / 86400000);
    }

    // ---------- GERENCIAMENTO DOS DADOS DO CICLO ----------
    function carregarDados() {
        let dados = localStorage.getItem(CICLO_STORAGE_KEY);
        if (dados) {
            try {
                dados = JSON.parse(dados);
                if (!dados.disciplinas || !Array.isArray(dados.disciplinas)) throw new Error();
            } catch {
                dados = null;
            }
        }
        if (!dados) {
            dados = {
                disciplinas: DISCIPLINAS.map(nome => ({
                    nome: nome,
                    feitas: 0,
                    acertos: 0,
                    ultimaQuestao: '',
                    tempo: 0
                })),
                ciclo: {
                    indice: 0,
                    dataUltimoRegistro: obterDataStringHoje(),
                    concluidoHoje: false
                }
            };
            localStorage.setItem(CICLO_STORAGE_KEY, JSON.stringify(dados));
        }
        return dados;
    }

    function atualizarCiclo(dados) {
        const hoje = obterDataStringHoje();
        if (dados.ciclo.dataUltimoRegistro !== hoje) {
            const dias = diferencaDias(dados.ciclo.dataUltimoRegistro, hoje);
            if (dias > 0) {
                dados.ciclo.indice = (dados.ciclo.indice + dias) % DISCIPLINAS.length;
            }
            dados.ciclo.dataUltimoRegistro = hoje;
            dados.ciclo.concluidoHoje = false;
        }
        return dados;
    }

    // ---------- INTEGRAÇÃO CORRETA COM O CALENDÁRIO (APPEND SEGURO) ----------
    function registrarNoCalendario(disciplinaNome, minutos) {
        if (!minutos || minutos <= 0) return;

        const calendarDate = getCalendarDateString();          // ex: "14-2-2026"
        const sessionKey = `sessions-${calendarDate}`;

        // 1. Ler array existente (se houver)
        let sessions = [];
        try {
            const raw = localStorage.getItem(sessionKey);
            if (raw) sessions = JSON.parse(raw);
            if (!Array.isArray(sessions)) sessions = [];      // segurança
        } catch (e) {
            sessions = [];
        }

        // 2. Criar nova sessão exatamente como o calendário espera
        const novaSessao = {
            subject: `Questões – ${disciplinaNome}`,
            minutes: minutos,
            date: calendarDate,
            timestamp: new Date().toISOString()
        };

        // 3. Adicionar ao array (append)
        sessions.push(novaSessao);

        // 4. Salvar de volta (sem tocar em outras chaves)
        localStorage.setItem(sessionKey, JSON.stringify(sessions));

        // 5. Manter a lista de matérias personalizadas do calendário (customSubjects)
        try {
            let custom = JSON.parse(localStorage.getItem('customSubjects') || '[]');
            if (!Array.isArray(custom)) custom = [];
            if (!custom.includes(disciplinaNome)) {
                custom.push(disciplinaNome);
                localStorage.setItem('customSubjects', JSON.stringify(custom));
            }
        } catch (e) {}
    }

    // ---------- ESTADO GLOBAL ----------
    let dadosEstudo = carregarDados();
    dadosEstudo = atualizarCiclo(dadosEstudo);
    localStorage.setItem(CICLO_STORAGE_KEY, JSON.stringify(dadosEstudo));

    // Elementos DOM
    const viewDaily = document.getElementById('viewDaily');
    const viewStats = document.getElementById('viewStats');
    const statsBtn = document.getElementById('statsBtnView');
    const voltarBtn = document.getElementById('voltarDailyBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const btnSalvar = document.getElementById('btnSalvar');
    const toggleFiltros = document.getElementById('toggleFiltros');
    const filtrosPanel = document.getElementById('filtrosPanel');
    const filtrosLista = document.getElementById('filtrosLista');
    const elNomeDisciplina = document.getElementById('disciplinaNome');
    const elConcluidoBadge = document.getElementById('concluidoBadge');
    const inputFeitas = document.getElementById('inputFeitas');
    const inputAcertos = document.getElementById('inputAcertos');
    const inputUltima = document.getElementById('inputUltima');
    const inputTempo = document.getElementById('inputTempo');
    const statsContainer = document.getElementById('statsCardsContainer');

    // ---------- INTERFACE DIÁRIA ----------
    function carregarInterfaceDaily() {
        const indice = dadosEstudo.ciclo.indice;
        const disciplina = DISCIPLINAS[indice];
        elNomeDisciplina.textContent = disciplina;

        const dadosDisc = dadosEstudo.disciplinas.find(d => d.nome === disciplina);
        inputUltima.value = (dadosDisc && dadosDisc.ultimaQuestao) || '';

        inputFeitas.value = 0;
        inputAcertos.value = 0;
        inputTempo.value = 0;

        const concluido = dadosEstudo.ciclo.concluidoHoje;
        if (concluido) {
            elConcluidoBadge.classList.remove('hidden');
            [inputFeitas, inputAcertos, inputUltima, inputTempo].forEach(i => i.disabled = true);
            btnSalvar.disabled = true;
        } else {
            elConcluidoBadge.classList.add('hidden');
            [inputFeitas, inputAcertos, inputUltima, inputTempo].forEach(i => i.disabled = false);
            btnSalvar.disabled = false;
        }

        // Filtros
        const filtros = FILTROS_POR_DISCIPLINA[disciplina] || [];
        filtrosLista.innerHTML = '';
        if (filtros.length === 0) {
            filtrosLista.innerHTML = '<li>sem tópicos específicos</li>';
        } else {
            filtros.forEach(f => {
                const li = document.createElement('li');
                li.textContent = f;
                filtrosLista.appendChild(li);
            });
        }
        filtrosPanel.classList.remove('show');
    }

    // ---------- ESTATÍSTICAS ----------
    function atualizarStats() {
        const disciplinas = dadosEstudo.disciplinas;
        let html = '';
        disciplinas.forEach(d => {
            const total = d.feitas;
            const acertos = d.acertos;
            const perc = total > 0 ? ((acertos / total) * 100).toFixed(1) : '0.0';
            const tempoHoras = Math.floor(d.tempo / 60);
            const tempoMin = d.tempo % 60;
            const tempoStr = tempoHoras > 0 ? `${tempoHoras}h ${tempoMin}m` : `${tempoMin}m`;
            html += `
                <div class="stat-item-card">
                    <div class="card-title"><h3>${d.nome}</h3></div>
                    <div class="stat-metrics">
                        <div class="stat-metric"><span class="value">${perc}%</span><span class="label">aproveitamento</span></div>
                        <div class="stat-metric"><span class="value">${total}</span><span class="label">questões</span></div>
                        <div class="stat-metric"><span class="value">${tempoStr}</span><span class="label">tempo</span></div>
                    </div>
                    <div class="progress-indicator"><div class="progress-fill" style="width:${perc}%"></div></div>
                    <div class="ultima-questao">última: ${d.ultimaQuestao || '—'}</div>
                </div>
            `;
        });
        statsContainer.innerHTML = html;
    }

    function abrirStats() {
        atualizarStats();
        viewDaily.classList.remove('active');
        viewStats.classList.add('active');
    }

    function fecharStats() {
        viewStats.classList.remove('active');
        viewDaily.classList.add('active');
        carregarInterfaceDaily();
    }

    // ---------- SALVAR (COM INTEGRAÇÃO CORRIGIDA) ----------
    function salvarHandler() {
        if (dadosEstudo.ciclo.concluidoHoje) {
            alert('Você já concluiu o bloco de hoje.');
            return;
        }

        const feitas = parseInt(inputFeitas.value, 10);
        const acertos = parseInt(inputAcertos.value, 10);
        const ultima = inputUltima.value.trim();
        const tempo = parseInt(inputTempo.value, 10);

        if (isNaN(feitas) || feitas < 0 || isNaN(acertos) || acertos < 0 || isNaN(tempo) || tempo < 0) {
            alert('Preencha valores válidos.');
            return;
        }
        if (acertos > feitas) {
            alert('Acertos não podem ser maiores que questões feitas.');
            return;
        }

        const indice = dadosEstudo.ciclo.indice;
        const disciplina = DISCIPLINAS[indice];
        const dadosDisc = dadosEstudo.disciplinas.find(d => d.nome === disciplina);
        if (dadosDisc) {
            dadosDisc.feitas += feitas;
            dadosDisc.acertos += acertos;
            if (ultima) dadosDisc.ultimaQuestao = ultima;
            dadosDisc.tempo += tempo;
        }

        dadosEstudo.ciclo.concluidoHoje = true;
        dadosEstudo.ciclo.dataUltimoRegistro = obterDataStringHoje();
        localStorage.setItem(CICLO_STORAGE_KEY, JSON.stringify(dadosEstudo));

        // INTEGRAÇÃO COM CALENDÁRIO (agora com o formato de chave correto)
        if (tempo > 0) {
            registrarNoCalendario(disciplina, tempo);
        }

        carregarInterfaceDaily();
    }

    // ---------- EXPORTAÇÃO (APENAS DADOS DO CICLO) ----------
    function exportarDados() {
        const cicloData = localStorage.getItem(CICLO_STORAGE_KEY);
        if (!cicloData) return;
        const blob = new Blob([JSON.stringify({ [CICLO_STORAGE_KEY]: cicloData }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ciclo-backup-${obterDataStringHoje()}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importarDados(arquivo) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (imported[CICLO_STORAGE_KEY]) {
                    localStorage.setItem(CICLO_STORAGE_KEY, imported[CICLO_STORAGE_KEY]);
                    alert('Dados do ciclo importados. Recarregue a página.');
                    location.reload();
                } else {
                    alert('Arquivo inválido: não contém dados do ciclo.');
                }
            } catch {
                alert('Arquivo corrompido.');
            }
        };
        reader.readAsText(arquivo);
    }

    // ---------- EVENTOS ----------
    statsBtn.addEventListener('click', abrirStats);
    voltarBtn.addEventListener('click', fecharStats);
    exportBtn.addEventListener('click', exportarDados);
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', (e) => {
        if (e.target.files[0]) importarDados(e.target.files[0]);
        importFile.value = '';
    });
    btnSalvar.addEventListener('click', salvarHandler);
    toggleFiltros.addEventListener('click', (e) => {
        e.preventDefault();
        filtrosPanel.classList.toggle('show');
    });

    // Inicialização
    carregarInterfaceDaily();

    // Atualizar caso outro contexto mude o ciclo (ex: import)
    window.addEventListener('storage', (e) => {
        if (e.key === CICLO_STORAGE_KEY) {
            dadosEstudo = JSON.parse(e.newValue);
            carregarInterfaceDaily();
        }
    });
})();
</script>
</body>
</html>
