<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyFlow - ChatBot Central</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #25D366;
      --primary-dark: #128C7E;
      --secondary: #34B7F1;
      --success: #4CAF50;
      --warning: #FF9800;
      --danger: #F44336;
      --light: #FFFFFF;
      --dark: #1F2C34;
      --gray: #667781;
      --light-gray: #F0F0F0;
      --chat-bg: #E5DDD5;
      --user-bubble: #DCF8C6;
      --bot-bubble: #FFFFFF;
      --border-radius: 18px;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .dark-theme {
      --primary: #00A884;
      --primary-dark: #008069;
      --secondary: #53BDEB;
      --light: #111B21;
      --dark: #E9EDEF;
      --gray: #8696A0;
      --light-gray: #202C33;
      --chat-bg: #0B141A;
      --user-bubble: #005C4B;
      --bot-bubble: #202C33;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    body {
      background-color: var(--light);
      color: var(--dark);
      height: 100vh;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      overflow: hidden;
    }
    
    .chatbot-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
      background-color: var(--chat-bg);
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
      overflow: hidden;
      position: relative;
    }
    
    .chatbot-header {
      background-color: var(--light);
      color: var(--dark);
      padding: 0.8rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      z-index: 10;
      position: relative;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .bot-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .header-info h1 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .header-info p {
      font-size: 0.8rem;
      opacity: 0.7;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--success);
      display: inline-block;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
    }
    
    .header-btn {
      background: transparent;
      border: none;
      color: var(--gray);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .header-btn:hover {
      background-color: var(--light-gray);
    }
    
    .chat-messages {
      display: flex;
      flex-direction: column;
      padding: 1rem;
      overflow-y: auto;
      flex: 1;
      gap: 8px;
      scroll-behavior: smooth;
    }
    
    .message-container {
      display: flex;
      margin-bottom: 4px;
      animation: messageAppear 0.3s ease-out;
    }
    
    .bot-container {
      justify-content: flex-start;
    }
    
    .user-container {
      justify-content: flex-end;
    }
    
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 8px;
      flex-shrink: 0;
      align-self: flex-end;
      margin-bottom: 4px;
    }
    
    .bot-avatar-small {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-size: 0.9rem;
    }
    
    .user-avatar-small {
      background: var(--secondary);
      color: white;
      font-size: 0.9rem;
    }
    
    .message-bubble {
      position: relative;
      padding: 12px 16px;
      border-radius: var(--border-radius);
      max-width: 80%;
      margin-bottom: 2px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      box-shadow: var(--shadow);
      line-height: 1.4;
    }
    
    @keyframes messageAppear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .bot-bubble {
      background: var(--bot-bubble);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      color: var(--dark);
    }
    
    .user-bubble {
      background: var(--user-bubble);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      color: #111B21;
    }
    
    .bubble-time {
      font-size: 0.65rem;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }
    
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 12px 16px;
      background-color: var(--bot-bubble);
      border-radius: var(--border-radius);
      border-bottom-left-radius: 4px;
      align-self: flex-start;
      width: fit-content;
      margin-bottom: 8px;
      box-shadow: var(--shadow);
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--gray);
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) {
      animation-delay: -0.32s;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: -0.16s;
    }
    
    @keyframes typingAnimation {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .chatbot-input {
      display: flex;
      padding: 0.8rem 1.5rem;
      background-color: var(--light);
      border-top: 1px solid var(--light-gray);
      gap: 8px;
      align-items: center;
    }
    
    .chatbot-input input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 24px;
      border: none;
      background-color: var(--light-gray);
      color: var(--dark);
      font-size: 0.95rem;
      outline: none;
      transition: var(--transition);
    }
    
    .chatbot-input input:focus {
      background-color: var(--light);
      box-shadow: 0 0 0 1.5px var(--primary);
    }
    
    .input-actions {
      display: flex;
      gap: 5px;
    }
    
    .input-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--gray);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .input-btn:hover {
      background-color: var(--light-gray);
    }
    
    .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .send-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }
    
    .message-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .message-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      font-size: 0.7rem;
    }
    
    .message-title {
      font-weight: 600;
      font-size: 1rem;
      color: var(--dark);
    }
    
    .message-subtitle {
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--dark);
      margin-bottom: 4px;
    }
    
    .message-text {
      font-size: 0.9rem;
      line-height: 1.4;
      color: var(--dark);
    }
    
    .message-divider {
      height: 1px;
      background-color: var(--light-gray);
      margin: 8px 0;
    }
    
    .message-section {
      margin: 8px 0;
    }
    
    .message-section-title {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 6px;
      color: var(--gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .message-list {
      list-style-type: none;
      margin: 8px 0;
      padding-left: 0;
    }
    
    .message-list-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .message-list-item:last-child {
      border-bottom: none;
    }
    
    .message-list-icon {
      width: 16px;
      text-align: center;
      color: var(--primary);
      margin-top: 2px;
      flex-shrink: 0;
    }
    
    .message-list-content {
      flex: 1;
    }
    
    .message-list-title {
      font-weight: 500;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }
    
    .message-list-description {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .message-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 12px 0;
    }
    
    .message-stat {
      background-color: var(--light-gray);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }
    
    .message-stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 3px 0;
    }
    
    .message-stat-label {
      font-size: 0.75rem;
      color: var(--gray);
    }
    
    .message-progress {
      margin: 10px 0;
    }
    
    .message-progress-bar {
      height: 6px;
      background-color: var(--light-gray);
      border-radius: 3px;
      margin: 8px 0;
      overflow: hidden;
    }
    
    .message-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--primary));
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    
    .message-progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .message-alert {
      padding: 10px 12px;
      border-radius: 8px;
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      box-shadow: var(--shadow);
    }
    
    .message-alert-warning {
      background-color: rgba(255, 152, 0, 0.1);
      border-left: 4px solid var(--warning);
    }
    
    .message-alert-danger {
      background-color: rgba(244, 67, 54, 0.1);
      border-left: 4px solid var(--danger);
    }
    
    .message-alert-success {
      background-color: rgba(76, 175, 80, 0.1);
      border-left: 4px solid var(--success);
    }
    
    .message-alert-info {
      background-color: rgba(52, 183, 241, 0.1);
      border-left: 4px solid var(--secondary);
    }
    
    .message-card {
      background-color: var(--bot-bubble);
      border-radius: 12px;
      padding: 16px;
      margin: 10px 0;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--primary);
    }
    
    .message-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .message-card-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--dark);
    }
    
    .message-card-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .message-muted {
      font-size: 0.8rem;
      color: var(--gray);
      margin-top: 4px;
    }
    
    .message-badge {
      display: inline-block;
      padding: 2px 8px;
      background-color: var(--primary);
      color: white;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 6px;
    }
    
    .message-badge-warning {
      background-color: var(--warning);
    }
    
    .message-badge-danger {
      background-color: var(--danger);
    }
    
    .message-badge-success {
      background-color: var(--success);
    }
    
    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
      justify-content: center;
    }
    
    .action-btn {
      padding: 10px 16px;
      background-color: var(--bot-bubble);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      transition: var(--transition);
      color: var(--dark);
      box-shadow: var(--shadow);
      font-weight: 500;
    }
    
    .action-btn:hover {
      background-color: var(--primary);
      color: white;
      transform: translateY(-2px);
    }
    
    .action-btn.primary {
      background-color: var(--primary);
      color: white;
    }
    
    .action-btn.secondary {
      background-color: var(--secondary);
      color: white;
    }
    
    .action-btn.info {
      background-color: var(--light-gray);
      color: var(--dark);
    }
    
    .action-btn.reset {
      background-color: var(--danger);
      color: white;
    }
    
    .chat-date {
      text-align: center;
      color: var(--gray);
      font-size: 0.8rem;
      margin: 10px 0;
      position: relative;
    }
    
    .chat-date::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background-color: var(--light-gray);
      z-index: 1;
    }
    
    .chat-date span {
      background-color: var(--chat-bg);
      padding: 0 10px;
      position: relative;
      z-index: 2;
    }
    
    .message-reaction {
      display: flex;
      justify-content: flex-end;
      margin-top: 2px;
    }
    
    .reaction-icon {
      font-size: 0.7rem;
      color: var(--gray);
    }
    
    @media (max-width: 768px) {
      .chatbot-container {
        height: 100vh;
      }
      .message-bubble {
        max-width: 85%;
      }
      .message-stats {
        grid-template-columns: 1fr;
      }
    }
    
    .typing-text {
      overflow: hidden;
      white-space: nowrap;
      animation: typing 3.5s steps(40, end);
    }
    
    @keyframes typing {
      from { width: 0 }
      to { width: 100% }
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
      animation: modalFadeIn 0.3s;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background-color: var(--light);
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.3s;
    }
    
    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .modal-header {
      padding: 1.2rem 1.5rem;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
    }
    
    .close-modal:hover {
      color: var(--dark);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .tasks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .task-card {
      background-color: var(--light-gray);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid var(--light-gray);
      transition: var(--transition);
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .task-card.disabled {
      opacity: 0.6;
    }
    
    .task-card.active {
      opacity: 1;
      border-color: var(--primary);
      background-color: var(--light);
    }
    
    .task-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    
    .task-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 1rem;
    }
    
    .task-icon-large {
      font-size: 1.5rem;
    }
    
    .task-title {
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .task-description {
      color: var(--gray);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    
    .task-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .form-group {
      margin-bottom: 0;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--light-gray);
      background-color: var(--light);
      color: var(--dark);
      font-size: 0.9rem;
      transition: var(--transition);
    }
    
    .form-group input:focus, .form-group select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
    }
    
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--gray);
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .modal-footer {
      padding: 1.2rem 1.5rem;
      border-top: 1px solid var(--light-gray);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .btn-secondary {
      background-color: var(--light-gray);
      color: var(--dark);
    }
    
    .btn-secondary:hover {
      background-color: var(--gray);
      color: white;
    }
    
    .activate-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-left: auto;
      transition: var(--transition);
    }
    
    .activate-btn:hover {
      background-color: var(--primary-dark);
    }
    
    .task-card.disabled .activate-btn {
      display: block;
    }
    
    .task-card.active .activate-btn {
      display: none;
    }
    
    .task-card.disabled .activate-btn {
      pointer-events: all !important;
    }
    
    .task-card.disabled input {
      pointer-events: none;
      background-color: rgba(255, 255, 255, 0.5);
    }
    
    .task-card.active input {
      pointer-events: all;
      background-color: var(--light);
    }
    
    .yesterday-modal .modal-header {
      background-color: rgba(244, 67, 54, 0.1);
      border-bottom: 4px solid var(--danger);
    }
    
    .yesterday-modal .modal-header h3 {
      color: var(--danger);
    }
    
    .yesterday-modal .modal-footer .btn-primary {
      background-color: var(--danger);
    }
    
    .yesterday-modal .modal-footer .btn-primary:hover {
      background-color: #d32f2f;
    }
    
    .task-card.registered {
      opacity: 0.7;
      background-color: rgba(76, 175, 80, 0.1);
      border-color: var(--success);
    }
    
    .task-card.registered .activate-btn {
      display: none;
    }
    
    .task-card.registered .task-header {
      opacity: 0.8;
    }
    
    .registration-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 10px;
      background-color: var(--light-gray);
      border-radius: 8px;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .status-badge.pending {
      background-color: rgba(255, 152, 0, 0.2);
      color: var(--warning);
    }
    
    .status-badge.registered {
      background-color: rgba(76, 175, 80, 0.2);
      color: var(--success);
    }
    
    .status-badge.completed {
      background-color: rgba(37, 211, 102, 0.2);
      color: var(--primary);
    }
    
    .task-header .task-status {
      margin-left: auto;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 10px;
      margin-right: 8px;
      background-color: var(--success);
      color: white;
    }
    
    .post-save-modal .modal-content {
      max-width: 400px;
    }
    
    .post-save-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    
    .post-save-btn {
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 1rem;
    }
    
    .post-save-btn.add {
      background-color: var(--secondary);
      color: white;
    }
    
    .post-save-btn.add:hover {
      background-color: #2a9cd8;
    }
    
    .post-save-btn.finish {
      background-color: var(--success);
      color: white;
    }
    
    .post-save-btn.finish:hover {
      background-color: #3d8b40;
    }
    
    .post-save-btn.later {
      background-color: var(--gray);
      color: white;
    }
    
    .post-save-btn.later:hover {
      background-color: #5a6268;
    }
    
    .progress-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--light-gray);
    }
    
    .progress-dot.active {
      background-color: var(--primary);
    }
    
    .progress-dot.completed {
      background-color: var(--success);
    }
    
    .day-finished-banner {
      background-color: rgba(76, 175, 80, 0.2);
      border-left: 4px solid var(--success);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .day-finished-banner i {
      color: var(--success);
    }
    
    .progress-visual {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }
    
    .progress-bar-container {
      flex: 1;
      height: 8px;
      background-color: var(--light-gray);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      background-color: var(--primary);
      transition: width 0.5s ease;
    }
    
    .task-card.registered {
      border: 2px solid var(--success) !important;
      background-color: rgba(76, 175, 80, 0.05) !important;
      opacity: 0.8 !important;
    }

    .task-card.registered .task-header {
      color: var(--success) !important;
    }

    .task-card.registered .task-title {
      color: var(--success) !important;
      font-weight: 600 !important;
    }

    .task-card.registered .task-description {
      color: var(--success) !important;
      opacity: 0.8 !important;
    }

    .task-card.registered .task-icon-large {
      color: var(--success) !important;
    }

    .task-card.registered .task-status {
      background-color: var(--success) !important;
      color: white !important;
      border-radius: 12px !important;
      padding: 4px 10px !important;
      font-size: 0.8rem !important;
      display: flex !important;
      align-items: center !important;
      gap: 4px !important;
    }

    .task-card.registered input:disabled {
      background-color: rgba(76, 175, 80, 0.1) !important;
      border-color: var(--success) !important;
      color: var(--success) !important;
      opacity: 0.8 !important;
    }

    .task-card.registered label {
      color: var(--success) !important;
      opacity: 0.8 !important;
    }

    /* UI ENHANCEMENTS START */
    
    /* Painel Lateral - Resumo do Dia */
    .side-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 28%;
      min-width: 320px;
      max-width: 400px;
      height: 100vh;
      background-color: var(--light);
      color: var(--dark);
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      transform: translateX(0);
    }
    
    .side-panel.collapsed {
      transform: translateX(100%);
    }
    
    .side-panel-header {
      padding: 1.2rem 1.5rem;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--primary);
      color: white;
    }
    
    .side-panel-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }
    
    .side-panel-toggle {
      background: transparent;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .side-panel-toggle:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .side-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .side-panel-date {
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary);
      text-align: center;
      padding: 0.5rem;
      background-color: rgba(37, 211, 102, 0.1);
      border-radius: 8px;
      border-left: 4px solid var(--primary);
    }
    
    .side-panel-progress {
      background-color: var(--bot-bubble);
      border-radius: 12px;
      padding: 1.2rem;
      box-shadow: var(--shadow);
    }
    
    .side-panel-progress h4 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .progress-bar {
      height: 10px;
      background-color: var(--light-gray);
      border-radius: 5px;
      overflow: hidden;
      margin: 0.8rem 0;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 5px;
      transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background-image: linear-gradient(
        -45deg,
        rgba(255, 255, 255, 0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 20px 20px;
      animation: progressStripes 1s linear infinite;
    }
    
    @keyframes progressStripes {
      0% { background-position: 0 0; }
      100% { background-position: 20px 0; }
    }
    
    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .side-panel-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.8rem;
    }
    
    .stat-card {
      background-color: var(--bot-bubble);
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid transparent;
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      border-color: var(--primary);
    }
    
    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0.3rem 0;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--gray);
    }
    
    .side-panel-activities {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    
    .side-panel-activities h4 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .activity-card {
      background-color: var(--bot-bubble);
      border-radius: 10px;
      padding: 1rem;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border-left: 3px solid var(--primary);
      position: relative;
      overflow: hidden;
    }
    
    .activity-card:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .activity-card.completed {
      border-left-color: var(--success);
      background-color: rgba(76, 175, 80, 0.05);
    }
    
    .activity-card.pending {
      border-left-color: var(--warning);
    }
    
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .activity-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .activity-status {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }
    
    .status-completed {
      background-color: rgba(76, 175, 80, 0.2);
      color: var(--success);
    }
    
    .status-pending {
      background-color: rgba(255, 152, 0, 0.2);
      color: var(--warning);
    }
    
    .activity-details {
      font-size: 0.8rem;
      color: var(--gray);
      line-height: 1.4;
    }
    
    .check-animation {
      position: absolute;
      right: -20px;
      top: -20px;
      width: 40px;
      height: 40px;
      background-color: var(--success);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s ease;
    }
    
    .activity-card.completed .check-animation {
      animation: checkPop 0.5s ease forwards;
    }
    
    @keyframes checkPop {
      0% { opacity: 0; transform: scale(0); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .side-panel-status {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid var(--light-gray);
    }
    
    .day-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem;
      border-radius: 8px;
      background-color: var(--bot-bubble);
      box-shadow: var(--shadow);
    }
    
    .day-status.completed {
      background-color: rgba(76, 175, 80, 0.1);
      border-left: 4px solid var(--success);
    }
    
    .day-status.pending {
      background-color: rgba(255, 152, 0, 0.1);
      border-left: 4px solid var(--warning);
    }
    
    .day-status-text {
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Botão FAB para reabrir painel */
    .panel-fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 99;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
      transition: var(--transition);
      font-size: 1.2rem;
    }
    
    .panel-fab:hover {
      transform: scale(1.1);
      background-color: var(--primary-dark);
      box-shadow: 0 6px 16px rgba(37, 211, 102, 0.4);
    }
    
    .panel-fab:active {
      transform: scale(0.95);
    }
    
    .panel-fab.hidden {
      opacity: 0;
      visibility: hidden;
      transform: scale(0.8);
    }
    
    .mobile-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      border: none;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 99;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
      transition: var(--transition);
    }
    
    .mobile-toggle:hover {
      transform: scale(1.1);
      background-color: var(--primary-dark);
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: var(--dark);
      color: var(--light);
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.75rem;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    @media (max-width: 900px) {
      .side-panel {
        width: 100%;
        max-width: 100%;
        transform: translateX(100%);
      }
      
      .side-panel.collapsed {
        transform: translateX(100%);
      }
      
      .side-panel:not(.collapsed) {
        transform: translateX(0);
      }
      
      .mobile-toggle {
        display: flex;
      }
      
      .panel-fab {
        display: none;
      }
      
      .chatbot-container {
        width: 100%;
      }
    }
    
    /* Botão Finalizar Dia - Verde */
    .action-btn.finalizar-dia {
      background-color: var(--success) !important;
      color: white !important;
      border: none;
    }
    
    .action-btn.finalizar-dia:hover {
      background-color: #3d8b40 !important;
      transform: translateY(-2px);
    }
    
    .action-btn.finalizar-dia-success {
      animation: pulseSuccess 0.5s ease;
    }
    
    @keyframes pulseSuccess {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    /* Remover botão "Marcar como concluído" dos cards pendentes */
    .complete-btn {
      display: none !important;
    }
    
    /* UI ENHANCEMENTS END */
  </style>
</head>
<body>
  <button class="panel-fab" id="panelFab" aria-label="Abrir painel de resumo" title="Abrir painel de resumo">
    <i class="fas fa-chart-bar"></i>
  </button>
  
  <button class="mobile-toggle" id="mobilePanelToggle" aria-label="Abrir painel de resumo">
    <i class="fas fa-chart-bar"></i>
  </button>
  
  <aside id="sidePanel" class="side-panel" aria-label="Resumo do dia" role="complementary">
    <header class="side-panel-header">
      <h3><i class="fas fa-calendar-day"></i> Resumo do Dia</h3>
      <button class="side-panel-toggle" id="sidePanelToggle" aria-label="Fechar painel" aria-expanded="true">
        <i class="fas fa-chevron-right"></i>
      </button>
    </header>
    <div class="side-panel-content">
      <div class="side-panel-date" id="sidePanelDate">Carregando...</div>
      
      <div class="side-panel-progress">
        <h4><i class="fas fa-chart-line"></i> Progresso Diário</h4>
        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="progress-text">
          <span id="progressCompleted">0 atividades</span>
          <span id="progressTotal">0 de 0</span>
        </div>
      </div>
      
      <div class="side-panel-stats" id="sidePanelStats">
        <!-- Dinamicamente preenchido -->
      </div>
      
      <div class="side-panel-activities">
        <h4><i class="fas fa-tasks"></i> Atividades de Hoje</h4>
        <div id="sidePanelActivities">
          <!-- Dinamicamente preenchido -->
        </div>
      </div>
      
      <div class="side-panel-status">
        <div class="day-status pending" id="dayStatus">
          <div class="day-status-text">
            <i class="fas fa-clock"></i>
            <span>Dia em andamento</span>
          </div>
          <div class="tooltip">
            <i class="fas fa-info-circle" style="color: var(--gray)"></i>
            <span class="tooltip-text">Clique em "Finalizar Dia" para concluir</span>
          </div>
        </div>
      </div>
    </div>
  </aside>
  
  <div class="chatbot-container">
    <div class="chatbot-header">
      <div class="header-left">
        <div class="bot-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="header-info">
          <h1>StudyFlow Assistant</h1>
          <p><span class="status-dot"></span> Online • Seu assistente de estudos</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" id="themeToggle">
          <i class="fas fa-moon"></i>
        </button>
        <button class="header-btn" id="infoBtn">
          <i class="fas fa-info"></i>
        </button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages">
    </div>
    <div class="chatbot-input">
      <div class="input-actions">
        <button class="input-btn" id="attachBtn">
          <i class="fas fa-paperclip"></i>
        </button>
        <button class="input-btn" id="emojiBtn">
          <i class="far fa-smile"></i>
        </button>
      </div>
      <input type="text" id="messageInput" placeholder="Digite uma mensagem...">
      <button class="send-btn" id="sendMessage">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
  
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-plus-circle"></i> Registrar Atividades</h3>
        <button class="close-modal" id="closeRegisterModal">&times;</button>
      </div>
      <div class="modal-body" id="registerModalBody">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelRegister">Cancelar</button>
        <button class="btn btn-primary" id="saveRegister">Salvar Atividade Selecionada</button>
      </div>
    </div>
  </div>
  
  <div class="modal yesterday-modal" id="yesterdayModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-history"></i> Registrar Atividades de Ontem</h3>
        <button class="close-modal" id="closeYesterdayModal">&times;</button>
      </div>
      <div class="modal-body" id="yesterdayModalBody">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelYesterday">Cancelar</button>
        <button class="btn btn-primary" id="saveYesterday">Salvar Atividades de Ontem</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="configModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-cog"></i> Configurar Matérias por Dia</h3>
        <button class="close-modal" id="closeConfigModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="materiasPorDia">Quantidade de matérias por dia:</label>
          <input type="number" id="materiasPorDia" min="1" max="5" value="1">
        </div>
        <div class="message-muted">
          Esta configuração define quantas matérias serão mostradas no resumo diário.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelConfig">Cancelar</button>
        <button class="btn btn-primary" id="saveConfig">Salvar</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="simuladoModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-calendar-alt"></i> Programar Simulado</h3>
        <button class="close-modal" id="closeSimuladoModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="simuladoInterval">Intervalo entre simulados:</label>
          <select id="simuladoInterval">
            <option value="0">Nenhum (não programar)</option>
            <option value="7">7 dias</option>
            <option value="10">10 dias</option>
            <option value="15">15 dias</option>
            <option value="30">30 dias</option>
          </select>
        </div>
        <div class="message-muted">
          Quando chegar o dia do simulado, o chatbot irá alertar.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelSimulado">Cancelar</button>
        <button class="btn btn-primary" id="saveSimulado">Salvar</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="relatorioModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-chart-bar"></i> Relatório Periódico</h3>
        <button class="close-modal" id="closeRelatorioModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="relatorioPeriodo">Período do relatório:</label>
          <select id="relatorioPeriodo">
            <option value="7">7 dias</option>
            <option value="15">15 dias</option>
            <option value="30">30 dias</option>
          </select>
        </div>
        <div class="message-muted">
          O relatório somará todos os dados do período selecionado e comparará com o período anterior.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelRelatorio">Cancelar</button>
        <button class="btn btn-primary" id="generateRelatorio">Gerar Relatório</button>
      </div>
    </div>
  </div>

  <div class="modal post-save-modal" id="postSaveModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-check-circle"></i> Atividade Registrada!</h3>
      </div>
      <div class="modal-body">
        <p>Sua atividade foi registrada com sucesso!</p>
        <div class="post-save-options">
          <button class="post-save-btn add" id="addAnotherActivity">
            <i class="fas fa-plus"></i> Adicionar nova atividade
          </button>
          <button class="post-save-btn finish" id="finishDay">
            <i class="fas fa-check"></i> Finalizar o dia de hoje
          </button>
          <button class="post-save-btn later" id="closeWithoutAction">
            <i class="fas fa-clock"></i> Vou adicionar depois
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    class StudyFlowChatBot {
      constructor() {
        this.currentTheme = localStorage.getItem('theme') || 'light';
        this.chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        if (this.chatHistory.length > 3) {
          this.chatHistory = this.chatHistory.slice(-3);
        }
        this.messageIds = new Set();
        
        this.materiasPorDia = parseInt(localStorage.getItem('studyFlow_materiasPorDia')) || 1;
        
        this.today = new Date().toISOString().split('T')[0];
        
        this.yesterdayMemory = JSON.parse(localStorage.getItem('studyFlow_yesterdayMemory')) || {
          activities: {},
          date: null
        };
        
        this.partialRegistration = JSON.parse(localStorage.getItem('studyFlow_partialRegistration')) || {
          date: null,
          activities: {},
          completed: false
        };
        
        this.init();
      }
      
      formatTime(date) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
      }
      
      init() {
        this.initTheme();
        this.initChat();
        this.initEventListeners();
        this.showWelcomeMessage();
        
        this.updateYesterdayMemory();
        
        this.checkPartialRegistration();
        
        // Inicializar painel lateral
        if (window.UI_ENHANCER && window.UI_ENHANCER.init) {
          window.UI_ENHANCER.init();
        }
      }
      
      initTheme() {
        if (this.currentTheme === 'dark') {
          document.body.classList.add('dark-theme');
          document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
        }
      }
      
      initChat() {
        if (this.chatHistory.length > 0) {
          this.chatHistory.forEach(msg => {
            this.addMessageToChat(msg.content, msg.isUser, msg.timestamp);
          });
        }
      }
      
      initEventListeners() {
        document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
        
        document.getElementById('infoBtn').addEventListener('click', () => this.showInfo());
        
        document.getElementById('sendMessage').addEventListener('click', () => this.sendMessage());
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.sendMessage();
          }
        });
        
        document.getElementById('attachBtn').addEventListener('click', () => this.showQuickActions());
        document.getElementById('emojiBtn').addEventListener('click', () => this.toggleEmojiPicker());
        
        document.getElementById('closeRegisterModal').addEventListener('click', () => this.closeRegisterModal());
        document.getElementById('cancelRegister').addEventListener('click', () => this.closeRegisterModal());
        document.getElementById('saveRegister').addEventListener('click', () => this.saveSelectedTask());
        
        document.getElementById('closeYesterdayModal').addEventListener('click', () => this.closeYesterdayModal());
        document.getElementById('cancelYesterday').addEventListener('click', () => this.closeYesterdayModal());
        document.getElementById('saveYesterday').addEventListener('click', () => this.saveYesterdayTasks());
        
        document.getElementById('closeConfigModal').addEventListener('click', () => this.closeConfigModal());
        document.getElementById('cancelConfig').addEventListener('click', () => this.closeConfigModal());
        document.getElementById('saveConfig').addEventListener('click', () => this.saveConfig());
        
        document.getElementById('closeSimuladoModal').addEventListener('click', () => this.closeSimuladoModal());
        document.getElementById('cancelSimulado').addEventListener('click', () => this.closeSimuladoModal());
        document.getElementById('saveSimulado').addEventListener('click', () => this.saveSimuladoConfig());
        
        document.getElementById('closeRelatorioModal').addEventListener('click', () => this.closeRelatorioModal());
        document.getElementById('cancelRelatorio').addEventListener('click', () => this.closeRelatorioModal());
        document.getElementById('generateRelatorio').addEventListener('click', () => this.generateRelatorio());
        
        document.getElementById('addAnotherActivity').addEventListener('click', () => {
          document.getElementById('postSaveModal').style.display = 'none';
          this.openRegisterModal();
        });
        
        document.getElementById('finishDay').addEventListener('click', () => {
          document.getElementById('postSaveModal').style.display = 'none';
          this.finalizeDay();
        });
        
        document.getElementById('closeWithoutAction').addEventListener('click', () => {
          document.getElementById('postSaveModal').style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
          const registerModal = document.getElementById('registerModal');
          const yesterdayModal = document.getElementById('yesterdayModal');
          const configModal = document.getElementById('configModal');
          const simuladoModal = document.getElementById('simuladoModal');
          const relatorioModal = document.getElementById('relatorioModal');
          const postSaveModal = document.getElementById('postSaveModal');
          
          if (e.target === registerModal) {
            this.closeRegisterModal();
          }
          if (e.target === yesterdayModal) {
            this.closeYesterdayModal();
          }
          if (e.target === configModal) {
            this.closeConfigModal();
          }
          if (e.target === simuladoModal) {
            this.closeSimuladoModal();
          }
          if (e.target === relatorioModal) {
            this.closeRelatorioModal();
          }
          if (e.target === postSaveModal) {
            document.getElementById('postSaveModal').style.display = 'none';
          }
        });
      }
      
      showWelcomeMessage() {
        if (this.chatHistory.length === 0) {
          this.addDateDivider();
          this.typeMessage("...", () => {
            setTimeout(() => {
              this.typeMessage("Posso te ajudar a gerenciar seu ciclo de estudos, mostrar tarefas diárias, registrar progresso e muito mais!", () => {
                setTimeout(() => {
                  this.addQuickActions();
                }, 500);
              });
            }, 500);
          });
        }
      }
      
      addQuickActions() {
        const quickActionsHTML = `
          <div class="quick-actions">
            <button class="action-btn secondary" onclick="chatBot.openRegisterModal()">
              <i class="fas fa-plus-circle"></i> Registrar Atividade
            </button>
            <button class="action-btn info" onclick="chatBot.openYesterdayModal()">
              <i class="fas fa-history"></i> Registrar Atividades de Ontem
            </button>
            <button class="action-btn info" onclick="chatBot.showEditalMenu()">
              <i class="fas fa-file-alt"></i> Edital
            </button>
            <button class="action-btn info" onclick="chatBot.showSimuladosMenu()">
              <i class="fas fa-chart-line"></i> Simulados
            </button>
            <button class="action-btn info" onclick="chatBot.showSimuladoModal()">
              <i class="fas fa-calendar-alt"></i> Programar Simulado
            </button>
            <button class="action-btn info" onclick="chatBot.showRelatorioModal()">
              <i class="fas fa-chart-bar"></i> Relatório
            </button>
            <button class="action-btn info" onclick="chatBot.trocarBaralhos()">
              <i class="fas fa-sync-alt"></i> Trocar Baralhos
            </button>
            <button class="action-btn info" onclick="chatBot.showConfigModal()">
              <i class="fas fa-cog"></i> Configurar
            </button>
            <button class="action-btn info" onclick="chatBot.showHelp()">
              <i class="fas fa-question-circle"></i> Ajuda
            </button>
            <button class="action-btn reset" onclick="chatBot.showResetConfirmation()">
              <i class="fas fa-exclamation-triangle"></i> Reset
            </button>
          </div>
        `;
        this.addBotMessage(quickActionsHTML, false);
      }
      
      getQuestoesRegistradasHoje(dateStr = null) {
        const hojeStr = dateStr || this.getDynamicDateString();
        const registradas = [];
        
        if (this.partialRegistration.date === hojeStr && 
            this.partialRegistration.activities.questoes) {
          this.partialRegistration.activities.questoes.forEach(q => {
            registradas.push({
              id: q.assunto,
              nome: q.assunto,
              disciplina: this.getDisciplinaPorAssunto(q.assunto) || 'Questões',
              registeredData: q
            });
          });
        }
        
        const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
        if (dailyActivities.activities.questoes) {
          dailyActivities.activities.questoes.forEach(q => {
            if (!registradas.some(r => r.id === q.assunto)) {
              registradas.push({
                id: q.assunto,
                nome: q.assunto,
                disciplina: this.getDisciplinaPorAssunto(q.assunto) || 'Questões',
                registeredData: q
              });
            }
          });
        }
        
        return registradas;
      }
      
      getAnkiRegistradosHoje(dateStr = null) {
        const hojeStr = dateStr || this.getDynamicDateString();
        const registrados = [];
        
        if (this.partialRegistration.date === hojeStr && 
            this.partialRegistration.activities.anki) {
          this.partialRegistration.activities.anki.forEach(a => {
            registrados.push({
              id: a.deck,
              nome: a.deck,
              emoji: '🔁',
              registeredData: a
            });
          });
        }
        
        const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
        if (dailyActivities.activities.anki) {
          dailyActivities.activities.anki.forEach(a => {
            if (!registrados.some(r => r.id === a.deck)) {
              registrados.push({
                id: a.deck,
                nome: a.deck,
                emoji: '🔁',
                registeredData: a
              });
            }
          });
        }
        
        return registrados;
      }
      
      getTeoriaRegistradaHoje(dateStr = null) {
        const hojeStr = dateStr || this.getDynamicDateString();
        const registradas = [];
        
        if (this.partialRegistration.date === hojeStr && 
            this.partialRegistration.activities.teoria) {
          this.partialRegistration.activities.teoria.forEach(t => {
            registradas.push(t.materia);
          });
        }
        
        const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
        if (dailyActivities.activities.teoria) {
          dailyActivities.activities.teoria.forEach(t => {
            if (!registradas.includes(t.materia)) {
              registradas.push(t.materia);
            }
          });
        }
        
        return registradas;
      }
      
      getDisciplinaPorAssunto(assuntoNome) {
        const disciplines = this.getModuleData('disciplines') || [];
        for (const disciplina of disciplines) {
          if (disciplina.assuntos && Array.isArray(disciplina.assuntos)) {
            for (const assunto of disciplina.assuntos) {
              if (assunto.nome === assuntoNome) {
                return disciplina.name;
              }
            }
          }
        }
        return null;
      }
      
      isQuestaoRegistered(questaoId, dateStr = null) {
        const hojeStr = dateStr || this.getDynamicDateString();
        
        if (this.partialRegistration.date === hojeStr && 
            this.partialRegistration.activities.questoes) {
          if (this.partialRegistration.activities.questoes.some(q => q.assunto === questaoId)) {
            return true;
          }
        }
        
        const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
        if (dailyActivities.activities.questoes) {
          if (dailyActivities.activities.questoes.some(q => q.assunto === questaoId)) {
            return true;
          }
        }
        
        return false;
      }
      
      isTeoriaRegistered(materiaId) {
        const hojeStr = this.getDynamicDateString();
        
        if (this.hasPartialRegistration()) {
          const partialReg = this.partialRegistration.activities.teoria || [];
          if (partialReg.some(t => t.materia === materiaId)) {
            return true;
          }
        }
        
        const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
        const dailyTeoria = dailyActivities.activities.teoria || [];
        
        return dailyTeoria.some(t => t.materia === materiaId);
      }
      
      isAnkiRegistered(deckId) {
        const hojeStr = this.getDynamicDateString();
        
        if (this.hasPartialRegistration()) {
          const partialReg = this.partialRegistration.activities.anki || [];
          if (partialReg.some(a => a.deck === deckId)) {
            return true;
          }
        }
        
        const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
        const dailyAnki = dailyActivities.activities.anki || [];
        
        return dailyAnki.some(a => a.deck === deckId);
      }
      
      checkPartialRegistration() {
        const hojeStr = this.getDynamicDateString();
        if (this.partialRegistration.date === hojeStr && 
            this.partialRegistration.activities && 
            Object.keys(this.partialRegistration.activities).length > 0) {
        }
      }
      
      hasPartialRegistration() {
        const hojeStr = this.getDynamicDateString();
        return this.partialRegistration.date === hojeStr && 
               this.partialRegistration.activities && 
               (this.partialRegistration.activities.questoes?.length > 0 ||
                this.partialRegistration.activities.anki?.length > 0 ||
                this.partialRegistration.activities.teoria?.length > 0);
      }
      
      isDayFinished() {
        const hojeStr = this.getDynamicDateString();
        const dayData = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || {};
        return dayData.completed === true || this.partialRegistration.completed === true;
      }
      
      updateYesterdayMemory() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        const yesterdayActivities = JSON.parse(localStorage.getItem(`dailyActivities_${yesterdayStr}`)) || { activities: {} };
        
        if (!yesterdayActivities.activities || Object.keys(yesterdayActivities.activities).length === 0) {
          if (!this.yesterdayMemory.date || this.yesterdayMemory.date !== yesterdayStr) {
            const yesterdayTasks = this.getTodayTasks(yesterdayStr);
            this.yesterdayMemory = {
              activities: yesterdayTasks,
              date: yesterdayStr
            };
            localStorage.setItem('studyFlow_yesterdayMemory', JSON.stringify(this.yesterdayMemory));
          }
        } else {
          this.yesterdayMemory = {
            activities: {},
            date: null
          };
          localStorage.setItem('studyFlow_yesterdayMemory', JSON.stringify(this.yesterdayMemory));
        }
      }
      
      openYesterdayModal() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        const yesterdayActivities = JSON.parse(localStorage.getItem(`dailyActivities_${yesterdayStr}`)) || { activities: {} };
        if (yesterdayActivities.activities && Object.keys(yesterdayActivities.activities).length > 0) {
          this.typeMessage("Você já registrou atividades para ontem! 😊");
          return;
        }
        
        if (!this.yesterdayMemory.activities || 
            (this.yesterdayMemory.activities.questoes.length === 0 && 
             this.yesterdayMemory.activities.anki.length === 0 && 
             this.yesterdayMemory.activities.teoria.length === 0)) {
          this.typeMessage("Não há atividades pendentes para ontem. 😊");
          return;
        }
        
        document.getElementById('yesterdayModal').style.display = 'flex';
        this.loadYesterdayTasks();
      }
      
      loadYesterdayTasks() {
        const modalBody = document.getElementById('yesterdayModalBody');
        modalBody.innerHTML = '';
        
        if (!this.yesterdayMemory.activities || 
            (this.yesterdayMemory.activities.questoes.length === 0 && 
             this.yesterdayMemory.activities.anki.length === 0 && 
             this.yesterdayMemory.activities.teoria.length === 0)) {
          modalBody.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-check-circle"></i>
              <h3>Não há tarefas pendentes para ontem!</h3>
              <p>Não foram encontradas atividades não registradas de ontem.</p>
            </div>
          `;
          return;
        }
        
        let tasksHTML = '<div class="tasks-grid">';
        
        this.yesterdayMemory.activities.questoes.forEach(questao => {
          tasksHTML += this.createQuestaoCard(questao, false, true);
        });
        
        this.yesterdayMemory.activities.anki.forEach(deck => {
          tasksHTML += this.createAnkiCard(deck, false, true);
        });
        
        this.yesterdayMemory.activities.teoria.forEach(materia => {
          tasksHTML += this.createTeoriaCard(materia, false, true);
        });
        
        tasksHTML += '</div>';
        modalBody.innerHTML = tasksHTML;
      }
      
      saveYesterdayTasks() {
        const activeCards = document.querySelectorAll('#yesterdayModal .task-card.active');
        let hasError = false;
        let savedCount = 0;
        let totalTime = 0;
        let activities = {
          questoes: [],
          anki: [],
          teoria: []
        };
        
        if (activeCards.length === 0) {
          alert('Por favor, selecione pelo menos uma atividade para registrar.');
          return;
        }
        
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        activeCards.forEach(card => {
          const type = card.getAttribute('data-type');
          const id = card.getAttribute('data-id');
          
          if (type === 'questoes') {
            const feitas = document.getElementById(`questoes-feitas-${id}`).value;
            const erradas = document.getElementById(`questoes-erradas-${id}`).value;
            const tempo = document.getElementById(`questoes-tempo-${id}`).value;
            
            if (!feitas || !tempo) {
              hasError = true;
              card.style.border = '1px solid red';
            } else {
              card.style.border = '';
              this.saveQuestoes(id, feitas, erradas, tempo, yesterdayStr);
              savedCount++;
              totalTime += parseInt(tempo);
              activities.questoes.push({
                assunto: id,
                feitas: parseInt(feitas),
                erradas: parseInt(erradas),
                tempo: parseInt(tempo)
              });
            }
          } else if (type === 'anki') {
            const tempo = document.getElementById(`anki-tempo-${id}`).value;
            const cards = document.getElementById(`anki-cards-${id}`).value;
            
            if (!tempo || !cards) {
              hasError = true;
              card.style.border = '1px solid red';
            } else {
              card.style.border = '';
              this.saveAnki(id, tempo, cards, yesterdayStr);
              savedCount++;
              totalTime += parseInt(tempo);
              activities.anki.push({
                deck: id,
                tempo: parseInt(tempo),
                cards: parseInt(cards)
              });
            }
          } else if (type === 'teoria') {
            const conteudo = document.getElementById(`teoria-conteudo-${id}`).value;
            const pagina = document.getElementById(`teoria-pagina-${id}`).value;
            const tempo = document.getElementById(`teoria-tempo-${id}`).value;
            
            if (!tempo) {
              hasError = true;
              card.style.border = '1px solid red';
            } else {
              card.style.border = '';
              this.saveTeoria(id, conteudo, pagina, tempo, yesterdayStr);
              savedCount++;
              totalTime += parseInt(tempo);
              activities.teoria.push({
                materia: id,
                conteudo: conteudo,
                pagina: pagina,
                tempo: parseInt(tempo)
              });
            }
          }
        });
        
        if (hasError) {
          alert('Preencha todos os campos obrigatórios das atividades selecionadas!');
          return;
        }
        
        const dailyActivities = {
          date: yesterdayStr,
          activities: activities
        };
        localStorage.setItem(`dailyActivities_${yesterdayStr}`, JSON.stringify(dailyActivities));
        
        this.yesterdayMemory = {
          activities: {},
          date: null
        };
        localStorage.setItem('studyFlow_yesterdayMemory', JSON.stringify(this.yesterdayMemory));
        
        this.closeYesterdayModal();
        
        if (savedCount > 0) {
          this.showRegistrationSummary(savedCount, totalTime, activities, true);
        }
      }
      
      closeYesterdayModal() {
        document.getElementById('yesterdayModal').style.display = 'none';
      }
      
      getTodayTasks(dateStr = null) {
        const date = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
        const dateKey = dateStr || this.getDynamicDateString();
        
        const tasks = {
          questoes: [],
          anki: [],
          teoria: []
        };
        
        tasks.questoes = this.calculateTodayReviews(date);
        
        tasks.anki = this.getTodayDecks().map(deckName => ({
          id: deckName,
          nome: deckName,
          emoji: '🔁'
        }));
        
        const activeCycle = this.getActiveCycle();
        if (activeCycle && activeCycle.generatedCycle) {
          tasks.teoria = this.getTodaySubjects(date);
        }
        
        return tasks;
      }
      
      showDailySummary() {
        const hoje = this.getDynamicDateObject();
        const hojeStr = this.getDynamicDateString();
        
        this.checkSimuladoDay();
        
        this.updateAnkiProgress();
        
        if (this.isDayFinished()) {
          this.showTodaySummary(hojeStr);
        } else if (this.hasPartialRegistration()) {
          this.showPartialSummary(hojeStr, true);
        } else {
          const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
          const hasRegistered = dailyActivities.activities && 
                               (dailyActivities.activities.questoes?.length > 0 ||
                                dailyActivities.activities.anki?.length > 0 ||
                                dailyActivities.activities.teoria?.length > 0);
          
          if (hasRegistered) {
            this.showPartialSummary(hojeStr, false);
          } else {
            this.showPendingTasks(hojeStr);
          }
        }
        
        this.addYesterdayButtonIfNeeded();
        
        // Atualizar painel lateral
        if (window.UI_ENHANCER && window.UI_ENHANCER.updateSidePanel) {
          window.UI_ENHANCER.updateSidePanel();
        }
      }
      
      addYesterdayButtonIfNeeded() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        const yesterdayActivities = JSON.parse(localStorage.getItem(`dailyActivities_${yesterdayStr}`)) || { activities: {} };
        
        if (!yesterdayActivities.activities || Object.keys(yesterdayActivities.activities).length === 0) {
          if (this.yesterdayMemory.activities && 
              (this.yesterdayMemory.activities.questoes.length > 0 || 
               this.yesterdayMemory.activities.anki.length > 0 || 
               this.yesterdayMemory.activities.teoria.length > 0)) {
            
            setTimeout(() => {
              this.addBotMessage(`
                <div class="message-alert message-alert-warning">
                  <i class="fas fa-history"></i>
                  <div><strong>Você tem atividades não registradas de ontem!</strong></div>
                </div>
                <div class="quick-actions">
                  <button class="action-btn info" onclick="chatBot.openYesterdayModal()">
                    <i class="fas fa-history"></i> Registrar Atividades de Ontem
                  </button>
                </div>
              `, false);
            }, 1000);
          }
        }
      }
      
      saveQuestoes(assuntoId, feitas, erradas, tempo, specificDate = null) {
        const corretas = parseInt(feitas) - parseInt(erradas);
        const dificuldade = 2;
        
        const revisaoAtualizada = this.updateReviewModule(assuntoId, feitas, corretas, tempo, dificuldade, specificDate);
        
        if (revisaoAtualizada) {
          let dailyCompletedReviews = this.getModuleData('dailyCompletedReviews') || 0;
          dailyCompletedReviews += 1;
          this.setModuleData('dailyCompletedReviews', dailyCompletedReviews);
          
          const hoje = specificDate ? new Date(specificDate + 'T00:00:00') : new Date();
          this.setModuleData('lastReviewDate', hoje.toISOString().split('T')[0]);
          
          this.registerHomeSession(`Questões - ${assuntoId}`, parseInt(tempo), specificDate);
          localStorage.setItem('ultimoEstudo', new Date().toISOString());
          
          // Atualizar painel lateral
          if (window.UI_ENHANCER && window.UI_ENHANCER.updateSidePanel) {
            window.UI_ENHANCER.updateSidePanel();
          }
        }
      }
      
      saveTeoria(materiaId, conteudo, pagina, tempo, specificDate = null) {
        const hojeStr = specificDate || this.getDynamicDateString();
        
        const cicloAtualizado = this.updateStudyCycle(materiaId, tempo, specificDate);
        
        if (cicloAtualizado) {
          const teoriaProgress = this.getModuleData('teoriaProgress') || {};
          
          teoriaProgress[materiaId] = {
            conteudo: conteudo || '',
            pagina: pagina || '',
            ultimaAtualizacao: new Date().toISOString(),
            tempoEstudado: parseInt(tempo)
          };
          
          this.setModuleData('teoriaProgress', teoriaProgress);
          
          localStorage.setItem('ultimoEstudo', new Date().toISOString());
          
          // Atualizar painel lateral
          if (window.UI_ENHANCER && window.UI_ENHANCER.updateSidePanel) {
            window.UI_ENHANCER.updateSidePanel();
          }
        }
        
        return cicloAtualizado;
      }
      
      saveAnki(deckId, tempo, cards, specificDate = null) {
        const ankiData = this.getModuleData('ciclos_focus_v1');
        const deck = ankiData && ankiData.decks ? ankiData.decks.find(d => d.id === deckId) : null;
        const deckNome = deck ? deck.name : deckId;
        
        this.registerHomeSession(`Anki - ${deckNome}`, parseInt(tempo), specificDate);
        
        localStorage.setItem('ultimoEstudo', new Date().toISOString());
        
        // Atualizar painel lateral
        if (window.UI_ENHANCER && window.UI_ENHANCER.updateSidePanel) {
          window.UI_ENHANCER.updateSidePanel();
        }
      }
      
      registerHomeSession(subject, minutes, specificDate = null) {
        const date = specificDate ? new Date(specificDate + 'T00:00:00') : new Date();
        const dateKey = `sessions-${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}`;
        
        let sessions = this.getModuleData(dateKey) || [];
        
        const existingSessionIndex = sessions.findIndex(session => 
          session.subject === subject && 
          session.date === `${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}`
        );
        
        if (existingSessionIndex === -1) {
          sessions.push({
            subject: subject,
            minutes: minutes,
            date: `${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}`,
            timestamp: date.toISOString()
          });
        } else {
          sessions[existingSessionIndex].minutes = minutes;
          sessions[existingSessionIndex].timestamp = date.toISOString();
        }
        
        this.setModuleData(dateKey, sessions);
      }
      
      updateReviewModule(assuntoId, feitas, corretas, tempo, dificuldade, specificDate = null) {
        const disciplines = this.getModuleData('disciplines') || [];
        const reviewDate = specificDate ? new Date(specificDate + 'T00:00:00') : new Date();
        const reviewTimestamp = reviewDate.getTime();
        
        let assuntoEncontrado = null;
        let disciplinaEncontrada = null;
        
        for (const disciplina of disciplines) {
          if (disciplina.assuntos && Array.isArray(disciplina.assuntos)) {
            for (const assunto of disciplina.assuntos) {
              if (assunto.nome === assuntoId) {
                assuntoEncontrado = assunto;
                disciplinaEncontrada = disciplina;
                break;
              }
            }
            if (assuntoEncontrado) break;
          }
        }
        
        if (assuntoEncontrado) {
          assuntoEncontrado.questions = (assuntoEncontrado.questions || 0) + parseInt(feitas);
          assuntoEncontrado.correct = (assuntoEncontrado.correct || 0) + parseInt(corretas);
          assuntoEncontrado.incorrect = (assuntoEncontrado.incorrect || 0) + (parseInt(feitas) - parseInt(corretas));
          
          if (!assuntoEncontrado.difficultyHistory) {
            assuntoEncontrado.difficultyHistory = [];
          }
          assuntoEncontrado.difficultyHistory.push(parseInt(dificuldade));
          
          const accuracy = (parseInt(corretas) / parseInt(feitas)) * 100;
          
          if (assuntoEncontrado.reviewMethod === 'fixed') {
            const interval = this.getPerformanceBasedInterval(accuracy);
            assuntoEncontrado.interval = interval;
            assuntoEncontrado.repetitions = (assuntoEncontrado.repetitions || 0) + 1;
          } else {
            const result = this.calculateNextReviewSM2(
              parseInt(dificuldade),
              assuntoEncontrado.easeFactor || 2.5,
              assuntoEncontrado.interval || 1,
              assuntoEncontrado.repetitions || 0
            );
            assuntoEncontrado.easeFactor = result.newEF;
            assuntoEncontrado.interval = result.newInterval;
            assuntoEncontrado.repetitions = result.repetitions;
          }
          
          assuntoEncontrado.lastReviewed = reviewTimestamp;
          
          const nextReviewDate = new Date(reviewTimestamp);
          nextReviewDate.setDate(nextReviewDate.getDate() + assuntoEncontrado.interval);
          assuntoEncontrado.nextReviewDate = nextReviewDate.getTime();
          
          assuntoEncontrado.memoryStrength = this.calculateMemoryStrength(assuntoEncontrado);
          
          this.setModuleData('disciplines', disciplines);
          return true;
        } else {
          return false;
        }
      }
      
      updateStudyCycle(materiaId, tempo, specificDate = null) {
        const activeCycle = this.getActiveCycle();
        const studyDate = specificDate || new Date().toISOString().split('T')[0];
        
        if (activeCycle && activeCycle.generatedCycle) {
          const todayIndex = activeCycle.currentDay || 0;
          const cycleLength = activeCycle.generatedCycle.length;
          
          let materiaEncontrada = false;
          
          for (let i = 0; i < cycleLength; i++) {
            let cicloDia = activeCycle.generatedCycle[i];
            
            if (Array.isArray(cicloDia)) {
              if (cicloDia.includes(materiaId)) {
                materiaEncontrada = true;
                break;
              }
            } else {
              if (cicloDia === materiaId) {
                materiaEncontrada = true;
                break;
              }
            }
          }
          
          if (materiaEncontrada) {
            if (!activeCycle.completedSubjects) {
              activeCycle.completedSubjects = {};
            }
            
            if (!activeCycle.completedSubjects[studyDate]) {
              activeCycle.completedSubjects[studyDate] = [];
            }
            
            if (!activeCycle.completedSubjects[studyDate].includes(materiaId)) {
              activeCycle.completedSubjects[studyDate].push(materiaId);
            }
            
            if (!activeCycle.studyTime) {
              activeCycle.studyTime = {};
            }
            
            activeCycle.studyTime[studyDate] = (activeCycle.studyTime[studyDate] || 0) + parseInt(tempo);
            
            this.registerHomeSession(`Teoria - ${materiaId}`, parseInt(tempo), studyDate);
            
            const teoriaProgress = this.getModuleData('teoriaProgress') || {};
            
            teoriaProgress[materiaId] = {
              conteudo: '',
              pagina: '',
              ultimaAtualizacao: new Date().toISOString(),
              tempoEstudado: parseInt(tempo)
            };
            
            this.setModuleData('teoriaProgress', teoriaProgress);
            
            this.setModuleData('StudyFlow_activeCycle', activeCycle);
            
            this.syncWithPlansModule(activeCycle);
            
            return true;
          }
        }
        return false;
      }
      
      syncWithPlansModule(activeCycle) {
        try {
          const planosData = JSON.parse(localStorage.getItem('StudyFlow_planos')) || {};
          
          if (planosData.ciclos && Array.isArray(planosData.ciclos)) {
            const cicloPlano = planosData.ciclos.find(c => c.id === activeCycle.id);
            
            if (cicloPlano) {
              if (!cicloPlano.completedSubjects) {
                cicloPlano.completedSubjects = {};
              }
              
              Object.keys(activeCycle.completedSubjects || {}).forEach(date => {
                if (!cicloPlano.completedSubjects[date]) {
                  cicloPlano.completedSubjects[date] = [];
                }
                
                activeCycle.completedSubjects[date].forEach(materia => {
                  if (!cicloPlano.completedSubjects[date].includes(materia)) {
                    cicloPlano.completedSubjects[date].push(materia);
                  }
                });
              });
              
              if (!cicloPlano.studyTime) {
                cicloPlano.studyTime = {};
              }
              
              Object.keys(activeCycle.studyTime || {}).forEach(date => {
                cicloPlano.studyTime[date] = (cicloPlano.studyTime[date] || 0) + activeCycle.studyTime[date];
              });
              
              if (activeCycle.currentDay !== undefined) {
                cicloPlano.currentDay = activeCycle.currentDay;
              }
              
              localStorage.setItem('StudyFlow_planos', JSON.stringify(planosData));
            }
          }
        } catch (e) {
        }
      }
      
      showResetConfirmation() { 
        const confirmationHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-exclamation-triangle" style="color: var(--danger)"></i> 
              <div class="message-card-title">Reset Temporário</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-alert message-alert-danger"> 
                <i class="fas fa-exclamation-circle"></i> 
                <div><strong>Atenção!</strong> Esta função executa um reset temporário do módulo do Chatbot, útil para corrigir travamentos ou inconsistências nos dados do dia. Nenhum outro módulo será afetado. Deseja continuar?</div> 
              </div> 
              <div class="quick-actions"> 
                <button class="action-btn reset" onclick="chatBot.resetChatbotData()"> 
                  <i class="fas fa-sync-alt"></i> Confirmar Reset 
                </button> 
                <button class="action-btn info" onclick="chatBot.addBotMessage('Reset cancelado. O sistema permanece inalterado.', false)"> 
                  <i class="fas fa-times"></i> Cancelar 
                </button> 
              </div> 
            </div> 
          </div> 
        `; 
        this.addBotMessage(confirmationHTML, false); 
      } 
      
      resetChatbotData() { 
        const hoje = new Date(); 
        const hojeStr = hoje.toLocaleDateString('pt-BR'); 
        
        localStorage.removeItem('lastRegisterDate'); 
        localStorage.removeItem('dailyActivities'); 
        
        this.partialRegistration = {
          date: null,
          activities: {},
          completed: false
        };
        localStorage.removeItem('studyFlow_partialRegistration');
        
        const successHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-check-circle" style="color: var(--success)"></i> 
              <div class="message-card-title">Reset Concluído</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-alert message-alert-success"> 
                <i class="fas fa-check-circle"></i> 
                <div><strong>Reset realizado com sucesso!</strong> Dados do módulo Chatbot reiniciados em ${hojeStr}.</div> 
              </div> 
              <div class="message-text"> 
                Agora você pode visualizar e registrar as atividades reais do dia. O sistema voltará a funcionar normalmente a partir de amanhã. 
              </div> 
              <div class="quick-actions"> 
                <button class="action-btn primary" onclick="chatBot.showDailySummary()"> 
                  <i class="fas fa-calendar-day"></i> Ver Resumo do Dia 
                </button> 
                <button class="action-btn secondary" onclick="chatBot.openRegisterModal()"> 
                  <i class="fas fa-plus-circle"></i> Registrar Atividades 
                </button> 
              </div> 
            </div> 
          </div> 
        `; 
        this.addBotMessage(successHTML, false); 
      } 
      
      getDynamicDateString() { 
        const hoje = new Date(); 
        const year = hoje.getFullYear(); 
        const month = String(hoje.getMonth() + 1).padStart(2, '0'); 
        const day = String(hoje.getDate()).padStart(2, '0'); 
        return `${year}-${month}-${day}`; 
      } 
      
      getDynamicDateObject() { 
        return new Date(); 
      } 
      
      formatDynamicDate(date) { 
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; 
        return date.toLocaleDateString('pt-BR', options); 
      } 
      
      isToday(dateString) { 
        const hoje = this.getDynamicDateString(); 
        return dateString === hoje; 
      } 
      
      hasStudiedToday() { 
        const hojeStr = this.getDynamicDateString();
        const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} }; 
        return dailyActivities.activities && 
               (dailyActivities.activities.questoes?.length > 0 ||
                dailyActivities.activities.anki?.length > 0 ||
                dailyActivities.activities.teoria?.length > 0);
      } 
      
      showDailySummary() { 
        const hoje = this.getDynamicDateObject();
        const hojeStr = this.getDynamicDateString();
        
        this.checkSimuladoDay();
        
        this.updateAnkiProgress(); 
        
        if (this.isDayFinished()) {
          this.showTodaySummary(hojeStr);
          return;
        }
        
        if (this.hasPartialRegistration()) {
          this.showPartialSummary(hojeStr, true);
          return;
        }
        
        if (this.hasStudiedToday()) { 
          this.showTodaySummary(hojeStr); 
        } else { 
          this.showPendingTasks(hojeStr); 
        } 
        
        // Atualizar painel lateral
        if (window.UI_ENHANCER && window.UI_ENHANCER.updateSidePanel) {
          window.UI_ENHANCER.updateSidePanel();
        }
      } 
      
      checkSimuladoDay() {
        const simuladoConfig = JSON.parse(localStorage.getItem('studyFlow_simuladoConfig')) || {};
        
        if (simuladoConfig.interval && simuladoConfig.nextSimulado) {
          const hoje = new Date();
          const nextSimulado = new Date(simuladoConfig.nextSimulado);
          
          if (hoje.toDateString() === nextSimulado.toDateString()) {
            this.addBotMessage(`
              <div class="message-alert message-alert-warning">
                <i class="fas fa-bullhorn"></i>
                <div><strong>Hoje é dia de simulado!</strong> Faça o simulado como se fosse o dia da prova real.</div>
              </div>
            `, false);
          }
        }
      }
      
      updateAnkiProgress() { 
        const ankiData = this.getModuleData('ciclos_focus_v1'); 
        if (!ankiData) return; 
        
        const today = new Date().toDateString(); 
        if (ankiData.lastUpdated !== today) { 
          const totalDecks = ankiData.decks.length; 
          const perDay = ankiData.perDay; 
          const totalBlocks = Math.ceil(totalDecks / perDay); 
          
          const startDate = new Date(ankiData.startDate || new Date()); 
          const diffTime = new Date() - startDate; 
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
          
          ankiData.blockIndex = diffDays % totalBlocks; 
          ankiData.lastUpdated = today; 
          this.setModuleData('ciclos_focus_v1', ankiData); 
        } 
      } 
      
      showPendingTasks(hojeStr) { 
        const hoje = new Date(hojeStr + 'T00:00:00');
        const dataFormatada = this.formatDynamicDate(hoje);
        
        const dailyReviewGoal = this.getModuleData('dailyReviewGoal') || 5; 
        const dailyCompletedReviews = this.getModuleData('dailyCompletedReviews') || 0; 
        
        const revisoesHoje = this.calculateTodayReviews(); 
        
        const progressoMeta = Math.min((dailyCompletedReviews / dailyReviewGoal) * 100, 100); 
        
        const alertas = this.checkAlerts(); 
        
        const materiasCiclo = this.getTodaySubjects(); 
        
        const baralhosAnki = this.getTodayDecks(); 
        
        const todayTasks = this.getTodayTasks();
        const totalTasks = this.countPendingTasks(todayTasks, {}, true);
        
        let summaryHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-calendar-day"></i> 
              <div class="message-card-title">Resumo do Dia - ${dataFormatada}</div> 
            </div> 
            <div class="message-card-content"> 
              <div class="message-text"> 
                <strong>Olá! Aqui estão suas tarefas para hoje:</strong> 
              </div> 
        `; 
        
        if (revisoesHoje.length > 0) { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Revisões Pendentes</div> 
              <div class="message-list"> 
          `; 
          revisoesHoje.forEach(revisao => { 
            summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-book"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${revisao.nome}</div> 
                    <div class="message-list-description">${revisao.disciplina}</div> 
                  </div> 
                </div> 
            `; 
          }); 
          summaryHTML += ` 
              </div> 
            </div> 
          `; 
        } else { 
          const questoesRegistradasHoje = this.getQuestoesRegistradasHoje(hojeStr);
          if (questoesRegistradasHoje.length > 0) {
            summaryHTML += ` 
              <div class="message-alert message-alert-success">
                <i class="fas fa-check-circle"></i>
                <div><strong>Carga diária de questões completa!</strong> Você já registrou ${questoesRegistradasHoje.length} bloco(s) de questões hoje.</div>
              </div>
            `;
          } else {
            summaryHTML += ` 
              <div class="message-section"> 
                <div class="message-section-title">Revisões Pendentes</div> 
                <div class="message-alert message-alert-info"> 
                  <i class="fas fa-info-circle"></i> 
                  <div>Nenhuma revisão pendente para hoje</div> 
                </div> 
              </div> 
            `; 
          }
        } 
        
        summaryHTML += ` 
          <div class="message-section"> 
            <div class="message-section-title">Matérias de Hoje</div> 
        `; 
        
        if (materiasCiclo.length > 0) { 
          summaryHTML += `<div class="message-list">`; 
          materiasCiclo.forEach(materia => { 
            const teoriaProgress = this.getModuleData('teoriaProgress'); 
            const ultimoEstudo = teoriaProgress && teoriaProgress[materia]; 
            
            summaryHTML += ` 
              <div class="message-list-item"> 
                <div class="message-list-icon"><i class="fas fa-book"></i></div> 
                <div class="message-list-content"> 
                  <div class="message-list-title">${materia}</div> 
                  ${ultimoEstudo ? ` 
                    <div class="message-list-description"> 
                      Último estudo: ${ultimoEstudo.conteudo} ${ultimoEstudo.pagina ? `(${ultimoEstudo.pagina})` : ''} 
                    </div>` : ` 
                    <div class="message-list-description">Nenhum registro anterior</div>` 
                  } 
                </div> 
              </div> 
            `; 
          }); 
          summaryHTML += `</div>`; 
        } else { 
          summaryHTML += ` 
            <div class="message-alert message-alert-warning"> 
              <i class="fas fa-exclamation-triangle"></i> 
              <div>Nenhuma matéria encontrada no ciclo de estudos ativo</div> 
            </div> 
          `; 
        } 
        
        summaryHTML += `</div>`; 
        
        summaryHTML += ` 
          <div class="message-section"> 
            <div class="message-section-title">Baralhos Anki</div> 
            <div class="message-list"> 
        `; 
        
        if (baralhosAnki.length > 0) { 
          baralhosAnki.forEach(deck => { 
            summaryHTML += ` 
              <div class="message-list-item"> 
                <div class="message-list-icon"><i class="fas fa-layer-group"></i></div> 
                <div class="message-list-content"> 
                  <div class="message-list-title">${deck}</div> 
                </div> 
              </div> 
            `; 
          }); 
        } else { 
          summaryHTML += ` 
            <div class="message-alert message-alert-info"> 
              <i class="fas fa-info-circle"></i> 
              <div>Nenhum baralho programado para hoje</div> 
            </div> 
          `; 
        } 
        
        summaryHTML += ` 
            </div> 
          </div> 
        `; 
        
        if (alertas.length > 0) { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Alertas</div> 
          `; 
          alertas.forEach(alerta => { 
            const alertClass = `message-alert-${alerta.tipo === 'alert-danger' ? 'danger' : alerta.tipo === 'alert-warning' ? 'warning' : 'info'}`; 
            summaryHTML += ` 
              <div class="message-alert ${alertClass}"> 
                <i class="fas fa-${alerta.icone}"></i> 
                <div>${alerta.mensagem}</div> 
              </div> 
            `; 
          }); 
          summaryHTML += `</div>`; 
        } 
        
        summaryHTML += ` 
            </div> 
          </div> 
        `; 
        
        this.addBotMessage(summaryHTML, true, 'pending-summary'); 
        
        setTimeout(() => { 
          this.addBotMessage(` 
            <div class="quick-actions"> 
              <button class="action-btn primary" onclick="chatBot.openRegisterModal()"> 
                <i class="fas fa-plus-circle"></i> Registrar Atividades 
              </button> 
              <button class="action-btn info" onclick="chatBot.trocarBaralhos()"> 
                <i class="fas fa-sync-alt"></i> Trocar Baralhos 
              </button> 
              <button class="action-btn info" onclick="chatBot.showHelp()"> 
                <i class="fas fa-question-circle"></i> Preciso de Ajuda 
              </button> 
            </div> 
          `, false); 
        }, 500); 
      } 
      
      showTodaySummary(hojeStr) { 
        const hoje = new Date(hojeStr + 'T00:00:00');
        const dataFormatada = this.formatDynamicDate(hoje);
        
        const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
        const atividades = dailyActivities.activities; 
        
        let totalTime = 0; 
        let totalAnkiDecks = 0; 
        let totalQuestoes = 0;
        let totalTeoria = 0;
        
        if (atividades.questoes && atividades.questoes.length > 0) { 
          atividades.questoes.forEach(q => {
            totalTime += q.tempo;
            totalQuestoes++;
          }); 
        } 
        
        if (atividades.anki && atividades.anki.length > 0) { 
          atividades.anki.forEach(a => { 
            totalTime += a.tempo; 
            totalAnkiDecks++; 
          }); 
        } 
        
        if (atividades.teoria && atividades.teoria.length > 0) { 
          atividades.teoria.forEach(t => {
            totalTime += t.tempo;
            totalTeoria++;
          }); 
        } 
        
        const hours = Math.floor(totalTime / 60); 
        const minutes = totalTime % 60; 
        
        let summaryHTML = ` 
          <div class="message-card"> 
            <div class="message-card-header"> 
              <i class="fas fa-calendar-day"></i> 
              <div class="message-card-title">Resumo do Dia - ${dataFormatada}</div> 
            </div> 
            <div class="message-card-content"> 
        `;
        
        if (dailyActivities.completed === true || this.isDayFinished()) {
          summaryHTML += `
            <div class="day-finished-banner">
              <i class="fas fa-check-circle"></i>
              <div><strong>Dia finalizado!</strong> Você não pode mais registrar atividades para hoje.</div>
            </div>
          `;
        } else {
          summaryHTML += `
            <div class="message-alert message-alert-success">
              <i class="fas fa-check-circle"></i>
              <div><strong>Parabéns! Você já estudou hoje.</strong></div>
            </div>
          `;
        }
        
        if (atividades.questoes && atividades.questoes.length > 0) { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Questões Realizadas</div> 
              <div class="message-list"> 
          `; 
          atividades.questoes.forEach(q => { 
            const acertos = q.feitas - q.erradas; 
            const taxaAcerto = q.feitas > 0 ? Math.round((acertos / q.feitas) * 100) : 0; 
            
            summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${q.assunto}</div> 
                    <div class="message-list-description">${q.feitas} questões • ${taxaAcerto}% de acerto • ${q.tempo} min</div> 
                  </div> 
                </div> 
            `; 
          }); 
          summaryHTML += ` 
              </div> 
            </div> 
          `; 
        } 
        
        if (atividades.anki && atividades.anki.length > 0) { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Revisões Anki</div> 
              <div class="message-list"> 
          `; 
          atividades.anki.forEach(a => { 
            summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${a.deck}</div> 
                    <div class="message-list-description">${a.cards} cards revisados • ${a.tempo} min</div> 
                  </div> 
                </div> 
            `; 
          }); 
          summaryHTML += ` 
              </div> 
            </div> 
          `; 
        } 
        
        if (atividades.teoria && atividades.teoria.length > 0) { 
          summaryHTML += ` 
            <div class="message-section"> 
              <div class="message-section-title">Estudo Teórico</div> 
              <div class="message-list"> 
          `; 
          atividades.teoria.forEach(t => { 
            summaryHTML += ` 
                <div class="message-list-item"> 
                  <div class="message-list-icon"><i class="fas fa-check"></i></div> 
                  <div class="message-list-content"> 
                    <div class="message-list-title">${t.materia}</div> 
                    <div class="message-list-description">${t.conteudo || t.pagina || 'Estudo concluído'} • ${t.tempo} min</div> 
                  </div> 
                </div> 
            `; 
          }); 
          summaryHTML += ` 
              </div> 
            </div> 
          `; 
        } 
        
        summaryHTML += ` 
              <div class="message-divider"></div> 
              <div class="message-stats"> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${hours}h ${minutes}m</div> 
                  <div class="message-stat-label">Tempo Total</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${totalAnkiDecks}</div> 
                  <div class="message-stat-label">Baralhos Revisados</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${totalQuestoes}</div> 
                  <div class="message-stat-label">Blocos de Questões</div> 
                </div> 
                <div class="message-stat"> 
                  <div class="message-stat-value">${totalTeoria}</div> 
                  <div class="message-stat-label">Estudos Teóricos</div> 
                </div> 
              </div> 
        `;
        
        const comparacaoHTML = this.generateComparacaoComOntem(hojeStr, atividades, totalTime);
        summaryHTML += comparacaoHTML;
        
        summaryHTML += ` 
              <div class="message-alert message-alert-info"> 
                <i class="fas fa-info-circle"></i> 
                <div><strong>Volte amanhã para novas atividades!</strong></div> 
              </div> 
        `; 
        
        summaryHTML += ` 
            </div> 
          </div> 
        `; 
        
        this.addBotMessage(summaryHTML, true, 'today-summary'); 
        
        setTimeout(() => { 
          this.addBotMessage(` 
            <div class="quick-actions"> 
              <button class="action-btn info" onclick="chatBot.showHelp()"> 
                <i class="fas fa-question-circle"></i> Preciso de Ajuda 
              </button> 
            </div> 
          `, false); 
        }, 500); 
      } 
      
      showPartialSummary(hojeStr, fromPartial = false) {
        const hoje = new Date(hojeStr + 'T00:00:00');
        const dataFormatada = this.formatDynamicDate(hoje);
        
        let atividades;
        let isPartial = fromPartial;
        
        if (fromPartial) {
          atividades = this.partialRegistration.activities;
        } else {
          const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
          atividades = dailyActivities.activities;
          isPartial = false;
        }
        
        let totalTime = 0;
        let totalActivities = 0;
        
        if (atividades.questoes && atividades.questoes.length > 0) {
          totalActivities += atividades.questoes.length;
          atividades.questoes.forEach(q => totalTime += q.tempo);
        }
        
        if (atividades.anki && atividades.anki.length > 0) {
          totalActivities += atividades.anki.length;
          atividades.anki.forEach(a => totalTime += a.tempo);
        }
        
        if (atividades.teoria && atividades.teoria.length > 0) {
          totalActivities += atividades.teoria.length;
          atividades.teoria.forEach(t => totalTime += t.tempo);
        }
        
        const todayTasks = this.getTodayTasks();
        const pendingCount = this.countPendingTasks(todayTasks, atividades, true);
        
        let summaryHTML = `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-calendar-day"></i>
              <div class="message-card-title">Resumo do Dia - ${dataFormatada}</div>
            </div>
            <div class="message-card-content">
              <div class="message-alert ${isPartial ? 'message-alert-warning' : 'message-alert-info'}">
                <i class="fas fa-info-circle"></i>
                <div><strong>Você já registrou ${totalActivities} atividade(s) hoje${isPartial ? ' (registro parcial)' : ''}</strong></div>
              </div>
              
              <div class="message-stats">
                <div class="message-stat">
                  <div class="message-stat-value">${totalTime}m</div>
                  <div class="message-stat-label">Tempo Total</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${totalActivities}</div>
                  <div class="message-stat-label">Atividades</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${pendingCount}</div>
                  <div class="message-stat-label">Pendentes</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${isPartial ? '⏳' : '✅'}</div>
                  <div class="message-stat-label">${isPartial ? 'Parcial' : 'Salvo'}</div>
                </div>
              </div>
              
              <div class="progress-visual">
                <div class="progress-bar-container">
                  <div class="progress-bar-fill" style="width: ${(totalActivities / (totalActivities + pendingCount)) * 100}%"></div>
                </div>
                <span>${totalActivities}/${totalActivities + pendingCount}</span>
              </div>
        `;
        
        if (atividades.questoes && atividades.questoes.length > 0) {
          summaryHTML += `
            <div class="message-section">
              <div class="message-section-title">Questões Realizadas</div>
              <div class="message-list">
          `;
          atividades.questoes.forEach(q => {
            const acertos = q.feitas - q.erradas;
            const taxaAcerto = q.feitas > 0 ? Math.round((acertos / q.feitas) * 100) : 0;
            summaryHTML += `
              <div class="message-list-item">
                <div class="message-list-icon"><i class="fas fa-check"></i></div>
                <div class="message-list-content">
                  <div class="message-list-title">${q.assunto}</div>
                  <div class="message-list-description">${q.feitas} questões • ${taxaAcerto}% acerto • ${q.tempo} min</div>
                </div>
              </div>
            `;
          });
          summaryHTML += `</div></div>`;
        }
        
        if (atividades.anki && atividades.anki.length > 0) {
          summaryHTML += `
            <div class="message-section">
              <div class="message-section-title">Revisões Anki</div>
              <div class="message-list">
          `;
          atividades.anki.forEach(a => {
            summaryHTML += `
              <div class="message-list-item">
                <div class="message-list-icon"><i class="fas fa-check"></i></div>
                <div class="message-list-content">
                  <div class="message-list-title">${a.deck}</div>
                  <div class="message-list-description">${a.cards} cards • ${a.tempo} min</div>
                </div>
              </div>
            `;
          });
          summaryHTML += `</div></div>`;
        }
        
        if (atividades.teoria && atividades.teoria.length > 0) {
          summaryHTML += `
            <div class="message-section">
              <div class="message-section-title">Estudo Teórico</div>
              <div class="message-list">
          `;
          atividades.teoria.forEach(t => {
            summaryHTML += `
              <div class="message-list-item">
                <div class="message-list-icon"><i class="fas fa-check"></i></div>
                <div class="message-list-content">
                  <div class="message-list-title">${t.materia}</div>
                  <div class="message-list-description">${t.conteudo || t.pagina || 'Estudo'} • ${t.tempo} min</div>
                </div>
              </div>
            `;
          });
          summaryHTML += `</div></div>`;
        }
        
        if (pendingCount > 0) {
          summaryHTML += `
              <div class="message-alert message-alert-warning">
                <i class="fas fa-clock"></i>
                <div><strong>${pendingCount} atividade(s) pendente(s)</strong> - continue registrando ou finalize o dia.</div>
              </div>
            </div>
          </div>
          `;
        } else {
          summaryHTML += `
              <div class="message-alert message-alert-success">
                <i class="fas fa-check-circle"></i>
                <div><strong>Todas as atividades registradas!</strong> O dia será finalizado automaticamente.</div>
              </div>
            </div>
          </div>
          `;
          
          setTimeout(() => {
            this.finalizeDay();
          }, 1000);
        }
        
        this.addBotMessage(summaryHTML, true, 'partial-summary');
        
        if (pendingCount > 0) {
          setTimeout(() => {
            this.addBotMessage(`
              <div class="quick-actions">
                <button class="action-btn primary" onclick="chatBot.openRegisterModal()">
                  <i class="fas fa-plus-circle"></i> Registrar Mais Atividades
                </button>
                <button class="action-btn secondary" onclick="chatBot.finalizeDay()">
                  <i class="fas fa-check"></i> Finalizar Dia
                </button>
                <button class="action-btn info" onclick="chatBot.showHelp()">
                  <i class="fas fa-question-circle"></i> Ajuda
                </button>
              </div>
            `, false);
          }, 500);
        }
      }
      
      countPendingTasks(todayTasks, registeredActivities, checkAllSources = false) {
        let count = 0;
        
        todayTasks.questoes.forEach(questao => {
          if (checkAllSources) {
            if (!this.isQuestaoRegistered(questao.id)) count++;
          } else {
            const registeredQuestoes = registeredActivities.questoes?.map(q => q.assunto) || [];
            if (!registeredQuestoes.includes(questao.id)) count++;
          }
        });
        
        todayTasks.anki.forEach(deck => {
          if (checkAllSources) {
            if (!this.isAnkiRegistered(deck.id)) count++;
          } else {
            const registeredAnki = registeredActivities.anki?.map(a => a.deck) || [];
            if (!registeredAnki.includes(deck.id)) count++;
          }
        });
        
        todayTasks.teoria.forEach(materia => {
          if (checkAllSources) {
            if (!this.isTeoriaRegistered(materia)) count++;
          } else {
            const registeredTeoria = registeredActivities.teoria?.map(t => t.materia) || [];
            if (!registeredTeoria.includes(materia)) count++;
          }
        });
        
        return count;
      }
      
      generateComparacaoComOntem(hojeStr, atividades, totalTime) {
        const ontem = new Date();
        ontem.setDate(ontem.getDate() - 1);
        const ontemStr = ontem.toISOString().split('T')[0];
        const ontemActivities = JSON.parse(localStorage.getItem(`dailyActivities_${ontemStr}`)) || { activities: {} };
        
        if (!ontemActivities.activities || Object.keys(ontemActivities.activities).length === 0) {
          return '';
        }
        
        let ontemTotalTime = 0;
        let ontemTotalQuestoes = 0;
        let ontemTotalAcertos = 0;
        let ontemTotalAnkiDecks = 0;
        
        if (ontemActivities.activities.questoes && ontemActivities.activities.questoes.length > 0) {
          ontemActivities.activities.questoes.forEach(q => {
            ontemTotalTime += q.tempo;
            ontemTotalQuestoes += q.feitas;
            ontemTotalAcertos += (q.feitas - q.erradas);
          });
        }
        
        if (ontemActivities.activities.anki && ontemActivities.activities.anki.length > 0) {
          ontemTotalAnkiDecks += ontemActivities.activities.anki.length;
          ontemActivities.activities.anki.forEach(a => {
            ontemTotalTime += a.tempo;
          });
        }
        
        if (ontemActivities.activities.teoria && ontemActivities.activities.teoria.length > 0) {
          ontemActivities.activities.teoria.forEach(t => {
            ontemTotalTime += t.tempo;
          });
        }
        
        let hojeTotalQuestoes = 0;
        let hojeTotalAcertos = 0;
        
        if (atividades.questoes && atividades.questoes.length > 0) {
          atividades.questoes.forEach(q => {
            hojeTotalQuestoes += q.feitas;
            hojeTotalAcertos += (q.feitas - q.erradas);
          });
        }
        
        const diffTime = totalTime - ontemTotalTime;
        const diffQuestoes = hojeTotalQuestoes - ontemTotalQuestoes;
        const diffAnkiDecks = (atividades.anki ? atividades.anki.length : 0) - ontemTotalAnkiDecks;
        
        const hojeAcertosPercent = hojeTotalQuestoes > 0 ? (hojeTotalAcertos / hojeTotalQuestoes) * 100 : 0;
        const ontemAcertosPercent = ontemTotalQuestoes > 0 ? (ontemTotalAcertos / ontemTotalQuestoes) * 100 : 0;
        const diffAcertosPercent = hojeAcertosPercent - ontemAcertosPercent;
        
        let comparacaoHTML = `
          <div class="message-section">
            <div class="message-section-title">Comparação com Ontem</div>
            <div class="message-list">
        `;
        
        let timeIcon = '⏱️';
        let timeText = '';
        if (diffTime > 0) {
          timeText = `<span style="color: var(--success)">+${diffTime} min</span> em relação a ontem`;
        } else if (diffTime < 0) {
          timeText = `<span style="color: var(--danger)">${diffTime} min</span> em relação a ontem`;
        } else {
          timeText = `Mesmo tempo de estudo que ontem`;
        }
        comparacaoHTML += `
          <div class="message-list-item">
            <div class="message-list-icon">${timeIcon}</div>
            <div class="message-list-content">
              <div class="message-list-title">Horas estudadas</div>
              <div class="message-list-description">${timeText}</div>
            </div>
          </div>
        `;
        
        let questoesIcon = '🧩';
        let questoesText = '';
        if (diffQuestoes > 0) {
          questoesText = `<span style="color: var(--success)">+${diffQuestoes} questões</span> em relação a ontem`;
        } else if (diffQuestoes < 0) {
          questoesText = `<span style="color: var(--danger)">${diffQuestoes} questões</span> em relação a ontem`;
        } else {
          questoesText = `Mesma quantidade de questões que ontem`;
        }
        comparacaoHTML += `
          <div class="message-list-item">
            <div class="message-list-icon">${questoesIcon}</div>
            <div class="message-list-content">
              <div class="message-list-title">Questões resolvidas</div>
              <div class="message-list-description">${questoesText}</div>
            </div>
          </div>
        `;
        
        let acertosIcon = '📊';
        let acertosText = '';
        if (diffAcertosPercent > 0) {
          acertosText = `<span style="color: var(--success)">+${diffAcertosPercent.toFixed(1)}%</span> em relação a ontem`;
        } else if (diffAcertosPercent < 0) {
          acertosText = `<span style="color: var(--danger)">${diffAcertosPercent.toFixed(1)}%</span> em relação a ontem`;
        } else {
          acertosText = `Mesma porcentagem de acertos que ontem`;
        }
        comparacaoHTML += `
          <div class="message-list-item">
            <div class="message-list-icon">${acertosIcon}</div>
            <div class="message-list-content">
              <div class="message-list-title">Porcentagem de acertos</div>
              <div class="message-list-description">${acertosText}</div>
            </div>
          </div>
        `;
        
        let flashcardsIcon = '🔁';
        let flashcardsText = '';
        if (diffAnkiDecks > 0) {
          flashcardsText = `<span style="color: var(--success)">+${diffAnkiDecks} baralhos</span> em relação a ontem`;
        } else if (diffAnkiDecks < 0) {
          flashcardsText = `<span style="color: var(--danger)">${diffAnkiDecks} baralhos</span> em relação a ontem`;
        } else {
          flashcardsText = `Mesma quantidade de baralhos que ontem`;
        }
        comparacaoHTML += `
          <div class="message-list-item">
            <div class="message-list-icon">${flashcardsIcon}</div>
            <div class="message-list-content">
              <div class="message-list-title">Flashcards revisados</div>
              <div class="message-list-description">${flashcardsText}</div>
            </div>
          </div>
        `;
        
        comparacaoHTML += `
            </div>
          </div>
        `;
        
        return comparacaoHTML;
      }
      
      openRegisterModal() {
        const hojeStr = this.getDynamicDateString();
        
        if (this.isDayFinished()) {
          this.typeMessage("O dia de hoje já foi finalizado! Você não pode mais registrar atividades para hoje.");
          return;
        }
        
        document.getElementById('registerModal').style.display = 'flex';
        document.getElementById('saveRegister').textContent = 'Salvar Atividade';
        this.loadTodayTasksWithStatus();
      }
      
      loadTodayTasksWithStatus() {
        const modalBody = document.getElementById('registerModalBody');
        modalBody.innerHTML = '';
        
        const hojeStr = this.getDynamicDateString();
        const todayTasks = this.getTodayTasks();
        
        const questoesRegistradas = this.getQuestoesRegistradasHoje(hojeStr);
        const ankiRegistrados = this.getAnkiRegistradosHoje(hojeStr);
        const teoriaRegistrada = this.getTeoriaRegistradaHoje(hojeStr);
        
        const totalTasks = todayTasks.questoes.length + todayTasks.anki.length + todayTasks.teoria.length;
        
        if (totalTasks === 0) {
          modalBody.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-check-circle"></i>
              <h3>Não há tarefas pendentes para hoje!</h3>
              <p>Parabéns! Você já concluiu todas as tarefas de hoje ou não há atividades programadas.</p>
            </div>
          `;
          return;
        }
        
        let registeredCount = 0;
        
        registeredCount += questoesRegistradas.length;
        registeredCount += ankiRegistrados.length;
        registeredCount += teoriaRegistrada.length;
        
        modalBody.innerHTML = `
          <div class="registration-status">
            <div>
              <strong>Registro Progressivo</strong>
              <div class="progress-indicator">
                <div class="progress-dot ${registeredCount > 0 ? 'completed' : 'active'}"></div>
                <div class="progress-dot ${registeredCount >= totalTasks ? 'completed' : 'active'}"></div>
              </div>
            </div>
            <div class="status-badge ${registeredCount >= totalTasks ? 'completed' : registeredCount > 0 ? 'registered' : 'pending'}">
              ${registeredCount}/${totalTasks} atividades
            </div>
          </div>
        `;
        
        let tasksHTML = '<div class="tasks-grid">';
        
        questoesRegistradas.forEach(questao => {
          tasksHTML += this.createQuestaoCard(questao, true, false);
        });
        
        todayTasks.questoes.forEach(questao => {
          const isRegistered = questoesRegistradas.some(q => q.id === questao.id);
          if (!isRegistered) {
            tasksHTML += this.createQuestaoCard(questao, false, false);
          }
        });
        
        ankiRegistrados.forEach(deck => {
          tasksHTML += this.createAnkiCard(deck, true, false);
        });
        
        todayTasks.anki.forEach(deck => {
          const isRegistered = ankiRegistrados.some(a => a.id === deck.id);
          if (!isRegistered) {
            tasksHTML += this.createAnkiCard(deck, false, false);
          }
        });
        
        teoriaRegistrada.forEach(materia => {
          tasksHTML += this.createTeoriaCard(materia, true, false);
        });
        
        todayTasks.teoria.forEach(materia => {
          const isRegistered = teoriaRegistrada.includes(materia);
          if (!isRegistered) {
            tasksHTML += this.createTeoriaCard(materia, false, false);
          }
        });
        
        tasksHTML += '</div>';
        modalBody.innerHTML += tasksHTML;
      }
      
      createQuestaoCard(questao, isRegistered = false, isYesterday = false) {
        const modalId = isYesterday ? 'yesterdayModal' : 'registerModal';
        
        let registeredData = null;
        if (isRegistered && questao.registeredData) {
          registeredData = questao.registeredData;
        } else if (isRegistered) {
          const hojeStr = this.getDynamicDateString();
          
          if (this.hasPartialRegistration()) {
            const partialQuestoes = this.partialRegistration.activities.questoes || [];
            registeredData = partialQuestoes.find(q => q.assunto === questao.id);
          }
          
          if (!registeredData) {
            const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
            const dailyQuestoes = dailyActivities.activities.questoes || [];
            registeredData = dailyQuestoes.find(q => q.assunto === questao.id);
          }
        }
        
        return `
          <div class="task-card ${isRegistered ? 'registered disabled' : 'disabled'}" 
               data-type="questoes" data-id="${questao.id}">
            <div class="task-header">
              <div class="task-icon-large">🧩</div>
              <div class="task-title">Questões: ${questao.disciplina || 'Revisão'}</div>
              ${isRegistered ? 
                '<span class="task-status"><i class="fas fa-check"></i> Registrado</span>' : 
                '<button class="activate-btn" onclick="chatBot.activateTask(this, \'' + modalId + '\')">Ativar</button>'}
            </div>
            <div class="task-description">
              <strong>Assunto:</strong> ${questao.nome}
              ${isRegistered && registeredData ? 
                `<br><small style="color: var(--success); font-weight: 600;">
                  ✅ ${registeredData.feitas} questões • ${registeredData.feitas - registeredData.erradas} acertos • ${registeredData.tempo} min
                </small>` : ''}
            </div>
            <div class="task-form">
              <div class="form-group">
                <label for="questoes-feitas-${questao.id}">Quantidade de questões feitas</label>
                <input type="number" id="questoes-feitas-${questao.id}" min="0" placeholder="Ex: 20" 
                       ${isRegistered ? 'disabled' : 'disabled'} 
                       value="${isRegistered && registeredData ? registeredData.feitas || '' : ''}">
              </div>
              <div class="form-group">
                <label for="questoes-erradas-${questao.id}">Quantidade de questões erradas</label>
                <input type="number" id="questoes-erradas-${questao.id}" min="0" placeholder="Ex: 5" 
                       ${isRegistered ? 'disabled' : 'disabled'}
                       value="${isRegistered && registeredData ? registeredData.erradas || '' : ''}">
              </div>
              <div class="form-group">
                <label for="questoes-tempo-${questao.id}">Tempo total gasto (minutos)</label>
                <input type="number" id="questoes-tempo-${questao.id}" min="0" placeholder="Ex: 45" 
                       ${isRegistered ? 'disabled' : 'disabled'}
                       value="${isRegistered && registeredData ? registeredData.tempo || '' : ''}">
              </div>
            </div>
          </div>
        `;
      }
      
      createAnkiCard(deck, isRegistered = false, isYesterday = false) {
        const modalId = isYesterday ? 'yesterdayModal' : 'registerModal';
        
        let registeredData = null;
        if (isRegistered && deck.registeredData) {
          registeredData = deck.registeredData;
        } else if (isRegistered) {
          const hojeStr = this.getDynamicDateString();
          
          if (this.hasPartialRegistration()) {
            const partialAnki = this.partialRegistration.activities.anki || [];
            registeredData = partialAnki.find(a => a.deck === deck.id);
          }
          
          if (!registeredData) {
            const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
            const dailyAnki = dailyActivities.activities.anki || [];
            registeredData = dailyAnki.find(a => a.deck === deck.id);
          }
        }
        
        return `
          <div class="task-card ${isRegistered ? 'registered disabled' : 'disabled'}" 
               data-type="anki" data-id="${deck.id}">
            <div class="task-header">
              <div class="task-icon-large">${deck.emoji}</div>
              <div class="task-title">Revisão Anki</div>
              ${isRegistered ? 
                '<span class="task-status"><i class="fas fa-check"></i> Registrado</span>' : 
                '<button class="activate-btn" onclick="chatBot.activateTask(this, \'' + modalId + '\')">Ativar</button>'}
            </div>
            <div class="task-description">
              <strong>Baralho:</strong> ${deck.nome}
              ${isRegistered && registeredData ? 
                `<br><small style="color: var(--success); font-weight: 600;">
                  ✅ ${registeredData.cards} cards • ${registeredData.tempo} min
                </small>` : ''}
            </div>
            <div class="task-form">
              <div class="form-group">
                <label for="anki-tempo-${deck.id}">Tempo de estudo (minutos)</label>
                <input type="number" id="anki-tempo-${deck.id}" min="0" placeholder="Ex: 30" 
                       ${isRegistered ? 'disabled' : 'disabled'} 
                       value="${isRegistered && registeredData ? registeredData.tempo || '' : ''}">
              </div>
              <div class="form-group">
                <label for="anki-cards-${deck.id}">Quantidade de cards revisados</label>
                <input type="number" id="anki-cards-${deck.id}" min="0" placeholder="Ex: 50" 
                       ${isRegistered ? 'disabled' : 'disabled'}
                       value="${isRegistered && registeredData ? registeredData.cards || '' : ''}">
              </div>
            </div>
          </div>
        `;
      }
      
      createTeoriaCard(materia, isRegistered = false, isYesterday = false) {
        const modalId = isYesterday ? 'yesterdayModal' : 'registerModal';
        
        let registeredData = null;
        if (isRegistered) {
          const hojeStr = this.getDynamicDateString();
          
          if (this.hasPartialRegistration()) {
            const partialTeoria = this.partialRegistration.activities.teoria || [];
            registeredData = partialTeoria.find(t => t.materia === materia);
          }
          
          if (!registeredData) {
            const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
            const dailyTeoria = dailyActivities.activities.teoria || [];
            registeredData = dailyTeoria.find(t => t.materia === materia);
          }
        }
        
        return `
          <div class="task-card ${isRegistered ? 'registered disabled' : 'disabled'}" 
               data-type="teoria" data-id="${materia}">
            <div class="task-header">
              <div class="task-icon-large">📚</div>
              <div class="task-title">Estudo Teórico</div>
              ${isRegistered ? 
                '<span class="task-status"><i class="fas fa-check"></i> Registrado</span>' : 
                '<button class="activate-btn" onclick="chatBot.activateTask(this, \'' + modalId + '\')">Ativar</button>'}
            </div>
            <div class="task-description">
              <strong>Matéria:</strong> ${materia}
              ${isRegistered && registeredData ? 
                `<br><small style="color: var(--success); font-weight: 600;">
                  ✅ ${registeredData.conteudo || registeredData.pagina || 'Estudo'} • ${registeredData.tempo} min
                </small>` : ''}
            </div>
            <div class="task-form">
              <div class="form-group">
                <label for="teoria-conteudo-${materia}">Conteúdo estudado (PDF/Aula)</label>
                <input type="text" id="teoria-conteudo-${materia}" placeholder="Ex: PDF Aula 1, Video Aula 2" 
                       ${isRegistered ? 'disabled' : 'disabled'}
                       value="${isRegistered && registeredData ? registeredData.conteudo || '' : ''}">
              </div>
              <div class="form-group">
                <label for="teoria-pagina-${materia}">Página/Progresso</label>
                <input type="text" id="teoria-pagina-${materia}" placeholder="Ex: Página 42, 50% concluído" 
                       ${isRegistered ? 'disabled' : 'disabled'}
                       value="${isRegistered && registeredData ? registeredData.pagina || '' : ''}">
              </div>
              <div class="form-group">
                <label for="teoria-tempo-${materia}">Tempo de estudo (minutos)</label>
                <input type="number" id="teoria-tempo-${materia}" min="0" placeholder="Ex: 60" 
                       ${isRegistered ? 'disabled' : 'disabled'}
                       value="${isRegistered && registeredData ? registeredData.tempo || '' : ''}">
              </div>
            </div>
          </div>
        `;
      }
      
      activateTask(button, modalId = 'registerModal') {
        const card = button.closest('.task-card');
        const modal = document.getElementById(modalId);
        
        if (card.classList.contains('active')) {
          card.classList.remove('active');
          card.classList.add('disabled');
          button.textContent = 'Ativar';
          
          const inputs = card.querySelectorAll('input');
          inputs.forEach(input => input.disabled = true);
        } else {
          card.classList.remove('disabled');
          card.classList.add('active');
          button.textContent = 'Desativar';
          
          const inputs = card.querySelectorAll('input');
          inputs.forEach(input => input.disabled = false);
        }
        
        const activeCards = modal.querySelectorAll('.task-card.active:not(.registered)');
        const saveButton = document.getElementById('saveRegister');
        if (activeCards.length > 1) {
          saveButton.textContent = `Salvar ${activeCards.length} Atividades`;
        } else if (activeCards.length === 1) {
          saveButton.textContent = 'Salvar Atividade';
        } else {
          saveButton.textContent = 'Salvar Atividade';
        }
      }
      
      saveSelectedTask() {
        const activeCards = document.querySelectorAll('#registerModal .task-card.active:not(.registered)');
        
        if (activeCards.length === 0) {
          alert('Por favor, selecione pelo menos uma atividade para registrar.');
          return;
        }
        
        let hasError = false;
        let savedCount = 0;
        let totalTime = 0;
        let activities = {
          questoes: [],
          anki: [],
          teoria: []
        };
        
        activeCards.forEach(card => {
          const type = card.getAttribute('data-type');
          const id = card.getAttribute('data-id');
          
          if (type === 'questoes') {
            const feitas = document.getElementById(`questoes-feitas-${id}`).value;
            const erradas = document.getElementById(`questoes-erradas-${id}`).value;
            const tempo = document.getElementById(`questoes-tempo-${id}`).value;
            
            if (!feitas || !tempo) {
              hasError = true;
              card.style.border = '1px solid red';
            } else {
              card.style.border = '';
              const activity = {
                type: 'questoes',
                data: {
                  assunto: id,
                  feitas: parseInt(feitas),
                  erradas: parseInt(erradas || 0),
                  tempo: parseInt(tempo)
                }
              };
              this.saveToPartialRegistration(activity);
              savedCount++;
              totalTime += parseInt(tempo);
              activities.questoes.push(activity.data);
            }
          } else if (type === 'anki') {
            const tempo = document.getElementById(`anki-tempo-${id}`).value;
            const cards = document.getElementById(`anki-cards-${id}`).value;
            
            if (!tempo || !cards) {
              hasError = true;
              card.style.border = '1px solid red';
            } else {
              card.style.border = '';
              const activity = {
                type: 'anki',
                data: {
                  deck: id,
                  tempo: parseInt(tempo),
                  cards: parseInt(cards)
                }
              };
              this.saveToPartialRegistration(activity);
              savedCount++;
              totalTime += parseInt(tempo);
              activities.anki.push(activity.data);
            }
          } else if (type === 'teoria') {
            const conteudo = document.getElementById(`teoria-conteudo-${id}`).value;
            const pagina = document.getElementById(`teoria-pagina-${id}`).value;
            const tempo = document.getElementById(`teoria-tempo-${id}`).value;
            
            if (!tempo) {
              hasError = true;
              card.style.border = '1px solid red';
            } else {
              card.style.border = '';
              const activity = {
                type: 'teoria',
                data: {
                  materia: id,
                  conteudo: conteudo || '',
                  pagina: pagina || '',
                  tempo: parseInt(tempo)
                }
              };
              this.saveToPartialRegistration(activity);
              savedCount++;
              totalTime += parseInt(tempo);
              activities.teoria.push(activity.data);
            }
          }
        });
        
        if (hasError) {
          alert('Preencha todos os campos obrigatórios das atividades selecionadas!');
          return;
        }
        
        this.closeRegisterModal();
        
        if (savedCount > 0) {
          const hojeStr = this.getDynamicDateString();
          const todayTasks = this.getTodayTasks();
          const pendingCount = this.countPendingTasks(todayTasks, this.partialRegistration.activities);
          
          if (pendingCount === 0) {
            this.finalizeDay();
          } else {
            this.showRegistrationSummary(savedCount, totalTime, activities, false);
          }
        }
      }
      
      saveToPartialRegistration(activity) {
        const hojeStr = this.getDynamicDateString();
        
        if (!this.partialRegistration.date || this.partialRegistration.date !== hojeStr) {
          this.partialRegistration = {
            date: hojeStr,
            activities: {},
            completed: false
          };
        }
        
        if (!this.partialRegistration.activities[activity.type]) {
          this.partialRegistration.activities[activity.type] = [];
        }
        
        const existingIndex = this.partialRegistration.activities[activity.type].findIndex(
          item => {
            if (activity.type === 'questoes') return item.assunto === activity.data.assunto;
            if (activity.type === 'anki') return item.deck === activity.data.deck;
            if (activity.type === 'teoria') return item.materia === activity.data.materia;
            return false;
          }
        );
        
        if (existingIndex >= 0) {
          this.partialRegistration.activities[activity.type].splice(existingIndex, 1);
        }
        
        this.partialRegistration.activities[activity.type].push(activity.data);
        
        localStorage.setItem('studyFlow_partialRegistration', JSON.stringify(this.partialRegistration));
        
        this.updateModuleWithActivity(activity);
      }
      
      updateModuleWithActivity(activity) {
        const hojeStr = this.getDynamicDateString();
        
        if (activity.type === 'questoes') {
          this.saveQuestoes(activity.data.assunto, activity.data.feitas, activity.data.erradas, activity.data.tempo, hojeStr);
        } else if (activity.type === 'anki') {
          this.saveAnki(activity.data.deck, activity.data.tempo, activity.data.cards, hojeStr);
        } else if (activity.type === 'teoria') {
          this.saveTeoria(activity.data.materia, activity.data.conteudo, activity.data.pagina, activity.data.tempo, hojeStr);
        }
      }
      
      showPostSaveModal() {
        const modal = document.getElementById('postSaveModal');
        modal.style.display = 'flex';
        
        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        };
      }
      
      finalizeDay() {
        const hojeStr = this.getDynamicDateString();
        
        if (this.hasPartialRegistration()) {
          const dailyActivities = {
            date: hojeStr,
            activities: this.partialRegistration.activities,
            completed: true
          };
          
          localStorage.setItem(`dailyActivities_${hojeStr}`, JSON.stringify(dailyActivities));
          
          this.partialRegistration = {
            date: null,
            activities: {},
            completed: true
          };
          localStorage.setItem('studyFlow_partialRegistration', JSON.stringify(this.partialRegistration));
        } else {
          const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || {
            date: hojeStr,
            activities: {},
            completed: true
          };
          dailyActivities.completed = true;
          localStorage.setItem(`dailyActivities_${hojeStr}`, JSON.stringify(dailyActivities));
        }
        
        localStorage.setItem('lastRegisterDate', hojeStr);
        
        this.typeMessage(`Dia ${hojeStr} finalizado com sucesso!`);
        
        // Atualizar painel lateral
        if (window.UI_ENHANCER && window.UI_ENHANCER.updateSidePanel) {
          window.UI_ENHANCER.updateSidePanel();
        }
        
        setTimeout(() => {
          this.showDailySummary();
        }, 1000);
      }
      
      closeRegisterModal() {
        document.getElementById('registerModal').style.display = 'none';
      }
      
      showRegistrationSummary(savedCount, totalTime, activities, isYesterday = false) {
        // Mensagem curta no chat
        const chatMessages = document.getElementById('chatMessages');
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container bot-container';
        const avatar = document.createElement('div');
        avatar.className = 'avatar bot-avatar-small';
        avatar.innerHTML = '<i class="fas fa-robot"></i>';
        messageContainer.appendChild(avatar);
        
        const successMessage = `
          <div class="message-bubble bot-bubble">
            <div class="message-content">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px">
                <i class="fas fa-check-circle" style="color: var(--success)"></i>
                <strong>Atividade registrada com sucesso. Progresso atualizado.</strong>
              </div>
            </div>
            <div class="bubble-time">${this.formatTime(new Date())}</div>
          </div>
        `;
        
        messageContainer.innerHTML += successMessage;
        chatMessages.appendChild(messageContainer);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Atualizar painel lateral apenas se não for de ontem
        if (!isYesterday) {
          if (window.UI_ENHANCER && window.UI_ENHANCER.updateSidePanel) {
            window.UI_ENHANCER.updateSidePanel();
            
            // Animar cards correspondentes
            setTimeout(() => {
              activities.questoes.forEach(q => {
                const card = document.querySelector(`[data-id="${q.assunto}"]`);
                if (card) {
                  card.classList.add('completed');
                  setTimeout(() => {
                    card.classList.remove('completed');
                  }, 1500);
                }
              });
              
              activities.anki.forEach(a => {
                const card = document.querySelector(`[data-id="${a.deck}"]`);
                if (card) {
                  card.classList.add('completed');
                  setTimeout(() => {
                    card.classList.remove('completed');
                  }, 1500);
                }
              });
              
              activities.teoria.forEach(t => {
                const card = document.querySelector(`[data-id="${t.materia}"]`);
                if (card) {
                  card.classList.add('completed');
                  setTimeout(() => {
                    card.classList.remove('completed');
                  }, 1500);
                }
              });
            }, 300);
          }
        }
      }
      
      getNextReviewDates() {
        const disciplines = this.getModuleData('disciplines');
        const nextReviews = [];
        const hoje = new Date();
        
        if (disciplines && Array.isArray(disciplines)) {
          disciplines.forEach(disciplina => {
            if (disciplina.assuntos && Array.isArray(disciplina.assuntos)) {
              disciplina.assuntos.forEach(assunto => {
                if (assunto.nextReviewDate) {
                  const nextDate = new Date(assunto.nextReviewDate);
                  if (nextDate > hoje) {
                    nextReviews.push({
                      assunto: assunto.nome,
                      disciplina: disciplina.name,
                      data: nextDate.toLocaleDateString('pt-BR')
                    });
                  }
                }
              });
            }
          });
        }
        
        return nextReviews
          .sort((a, b) => new Date(a.data) - new Date(b.data))
          .slice(0, 3);
      }
      
      toggleTheme() {
        if (this.currentTheme === 'light') {
          document.body.classList.add('dark-theme');
          document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
          this.currentTheme = 'dark';
        } else {
          document.body.classList.remove('dark-theme');
          document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
          this.currentTheme = 'light';
        }
        localStorage.setItem('theme', this.currentTheme);
        
        // Atualizar tema do painel lateral
        if (window.UI_ENHANCER && window.UI_ENHANCER.updateSidePanel) {
          window.UI_ENHANCER.updateSidePanel();
        }
      }
      
      addUserMessage(content) {
        this.addMessageToChat(content, true);
      }
      
      getActiveCycle() {
        const possibleKeys = [
          'StudyFlow_activeCycle',
          'StudyFlow_allCycles',
          'activeCycle',
          'StudyFlow_cycle',
          'currentCycle'
        ];
        
        for (const key of possibleKeys) {
          const data = this.getModuleData(key);
          if (data) {
            if (Array.isArray(data) && data.length > 0) {
              const cycle = data[0];
              if (cycle && cycle.generatedCycle && Array.isArray(cycle.generatedCycle)) {
                return cycle;
              }
            }
            else if (data.generatedCycle && Array.isArray(data.generatedCycle)) {
              return data;
            }
          }
        }
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.includes('cycle') || key.includes('Cycle') || key.includes('CYCLE'))) {
            try {
              const data = JSON.parse(localStorage.getItem(key));
              if (data) {
                if (Array.isArray(data) && data.length > 0) {
                  const cycle = data[0];
                  if (cycle && cycle.generatedCycle && Array.isArray(cycle.generatedCycle)) {
                    return cycle;
                  }
                }
                else if (data.generatedCycle && Array.isArray(data.generatedCycle)) {
                  return data;
                }
              }
            } catch (e) {
            }
          }
        }
        
        return null;
      }
      
      getModuleData(key) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          return null;
        }
      }
      
      setModuleData(key, data) {
        try {
          localStorage.setItem(key, JSON.stringify(data));
          return true;
        } catch (e) {
          return false;
        }
      }
      
      calculateTodayReviews(date = null) {
        const disciplines = this.getModuleData('disciplines');
        const dailyReviewGoal = this.getModuleData('dailyReviewGoal') || 5;
        
        if (!disciplines || !Array.isArray(disciplines)) return [];
        
        const targetDate = date || new Date();
        const targetTimestamp = targetDate.getTime();
        
        const hoje = new Date();
        const isToday = targetDate.toDateString() === hoje.toDateString();
        
        if (isToday) {
          const hojeStr = this.getDynamicDateString();
          const questoesRegistradasHoje = this.getQuestoesRegistradasHoje(hojeStr);
          
          if (questoesRegistradasHoje.length >= dailyReviewGoal) {
            return [];
          }
        }
        
        let pendingTopics = [];
        
        disciplines.forEach(disciplina => {
          if (disciplina.assuntos && Array.isArray(disciplina.assuntos)) {
            disciplina.assuntos.forEach(assunto => {
              if (assunto.suspended) return;
              
              if (assunto.nextReviewDate && assunto.nextReviewDate <= targetTimestamp) {
                const daysOverdue = Math.max(0, Math.floor((targetTimestamp - assunto.nextReviewDate) / (1000 * 60 * 60 * 24)));
                
                let avgDifficulty = 2;
                if (assunto.difficultyHistory && assunto.difficultyHistory.length > 0) {
                  avgDifficulty = assunto.difficultyHistory.reduce((a, b) => a + b, 0) / assunto.difficultyHistory.length;
                }
                const difficultyScore = (3 - avgDifficulty);
                
                const importance = assunto.importance || 3;
                
                const priority = (difficultyScore * 40) + (daysOverdue * 60) + (importance * 20);
                
                pendingTopics.push({
                  id: assunto.nome,
                  nome: assunto.nome,
                  disciplina: disciplina.name,
                  priority: priority,
                  daysOverdue: daysOverdue,
                  difficulty: avgDifficulty,
                  importance: importance
                });
              }
            });
          }
        });
        
        pendingTopics.sort((a, b) => b.priority - a.priority);
        
        if (isToday) {
          const hojeStr = this.getDynamicDateString();
          const questoesRegistradasHoje = this.getQuestoesRegistradasHoje(hojeStr);
          const remainingSlots = Math.max(0, dailyReviewGoal - questoesRegistradasHoje.length);
          
          return pendingTopics.slice(0, remainingSlots);
        }
        
        return pendingTopics.slice(0, dailyReviewGoal);
      }
      
      countQuestoesPendentesHoje(dateStr = null) {
        const hojeStr = dateStr || this.getDynamicDateString();
        const dailyReviewGoal = this.getModuleData('dailyReviewGoal') || 5;
        const questoesRegistradasHoje = this.getQuestoesRegistradasHoje(hojeStr);
        
        return Math.max(0, dailyReviewGoal - questoesRegistradasHoje.length);
      }
      
      calculateOverdueReviews() {
        const disciplines = this.getModuleData('disciplines');
        if (!disciplines || !Array.isArray(disciplines)) return 0;
        
        const hoje = new Date();
        const todayTimestamp = hoje.getTime();
        
        let atrasadas = 0;
        
        disciplines.forEach(disciplina => {
          if (disciplina.assuntos && Array.isArray(disciplina.assuntos)) {
            disciplina.assuntos.forEach(assunto => {
              if (assunto.nextReviewDate && assunto.nextReviewDate < todayTimestamp && !assunto.suspended) {
                atrasadas++;
              }
            });
          }
        });
        
        return atrasadas;
      }
      
      getTodaySubjects(date = null) {
        const activeCycle = this.getActiveCycle();
        if (!activeCycle || !activeCycle.generatedCycle) {
          return [];
        }
        
        const targetDate = date || new Date();
        const todayIndex = activeCycle.currentDay || 0;
        const materiasPorDia = this.materiasPorDia || 1;
        
        let subjects = [];
        const cycleLength = activeCycle.generatedCycle.length;
        
        if (cycleLength === 0) {
          return [];
        }
        
        const adjustedIndex = todayIndex % cycleLength;
        
        for (let i = 0; i < materiasPorDia; i++) {
          const index = (adjustedIndex + i) % cycleLength;
          let subject = activeCycle.generatedCycle[index];
          
          if (Array.isArray(subject)) {
            subject = subject.join(', ');
          }
          
          if (subject && !subject.includes('Revisão') && !subject.includes('Simulado')) {
            subjects.push(subject);
          }
        }
        
        return subjects;
      }
      
      getPerformanceBasedInterval(accuracy) {
        accuracy = Math.max(0, Math.min(100, accuracy));
        
        if (accuracy >= 100) return 12;
        if (accuracy >= 80) return 9;
        if (accuracy >= 60) return 6;
        if (accuracy >= 40) return 3;
        return 1;
      }
      
      calculateNextReviewSM2(q, currentEF, currentInterval, repetitions) {
        let newEF = currentEF + (0.1 - (3 - q) * (0.08 + (3 - q) * 0.02));
        newEF = Math.max(1.3, Math.min(newEF, 2.5));
        
        let newInterval;
        
        if (q < 2) {
          newInterval = 1;
          repetitions = 0;
        } else {
          if (repetitions === 0) {
            newInterval = 1;
          } else if (repetitions === 1) {
            newInterval = 3;
          } else {
            newInterval = Math.round(currentInterval * newEF);
          }
          repetitions++;
        }
        
        return { newInterval, newEF, repetitions };
      }
      
      calculateMemoryStrength(topic) {
        if (!topic.lastReviewed) return 0.5;
        
        const now = this.getToday();
        const lastReview = topic.lastReviewed;
        const diffTime = Math.max(0, now - lastReview);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        const baseStrength = 0.9;
        const decayRate = 0.15;
        
        let strength = baseStrength * Math.exp(-decayRate * diffDays);
        
        if (topic.difficultyHistory && topic.difficultyHistory.length > 0) {
          const avgDifficulty = topic.difficultyHistory.reduce((a, b) => a + b, 0) / topic.difficultyHistory.length;
          strength *= (1 - (avgDifficulty * 0.15));
        }
        
        return Math.min(Math.max(strength, 0.1), 0.95);
      }
      
      getToday() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return today.getTime();
      }
      
      trocarBaralhos() {
        const ankiData = this.getModuleData('ciclos_focus_v1');
        if (!ankiData) {
          this.typeMessage("Não foi possível encontrar os dados dos baralhos Anki.");
          return;
        }

        const totalDecks = ankiData.decks.length;
        const perDay = ankiData.perDay;
        const totalBlocks = Math.ceil(totalDecks / perDay);

        ankiData.blockIndex = (ankiData.blockIndex + 1) % totalBlocks;
        ankiData.lastUpdated = new Date().toDateString();

        this.setModuleData('ciclos_focus_v1', ankiData);

        this.typeMessage(`Baralhos trocados! Agora são os baralhos do bloco ${ankiData.blockIndex + 1} de ${totalBlocks}.`);
        
        // Atualizar painel lateral
        if (window.UI_ENHANCER && window.UI_ENHANCER.updateSidePanel) {
          window.UI_ENHANCER.updateSidePanel();
        }
      }
      
      addMessageToChat(content, isUser = false, timestamp = null, messageId = null) {
        if (messageId && this.messageIds.has(messageId)) {
          return;
        }
        
        if (messageId) {
          this.messageIds.add(messageId);
        }
        
        const chatMessages = document.getElementById('chatMessages');
        const messageContainer = document.createElement('div');
        messageContainer.className = `message-container ${isUser ? 'user-container' : 'bot-container'}`;
        
        if (!isUser) {
          const avatar = document.createElement('div');
          avatar.className = 'avatar bot-avatar-small';
          avatar.innerHTML = '<i class="fas fa-robot"></i>';
          messageContainer.appendChild(avatar);
        }
        
        const messageBubble = document.createElement('div');
        messageBubble.className = `message-bubble ${isUser ? 'user-bubble' : 'bot-bubble'}`;
        
        const processedContent = this.parseMarkdown(content);
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.innerHTML = processedContent;
        
        const messageTime = document.createElement('div');
        messageTime.className = 'bubble-time';
        messageTime.textContent = timestamp ? this.formatTime(new Date(timestamp)) : this.formatTime(new Date());
        
        messageBubble.appendChild(messageContent);
        messageBubble.appendChild(messageTime);
        
        if (isUser) {
          const reaction = document.createElement('div');
          reaction.className = 'message-reaction';
          reaction.innerHTML = '<span class="reaction-icon"><i class="fas fa-check-double"></i></span>';
          messageBubble.appendChild(reaction);
        }
        
        messageContainer.appendChild(messageBubble);
        
        if (isUser) {
          const avatar = document.createElement('div');
          avatar.className = 'avatar user-avatar-small';
          avatar.innerHTML = '<i class="fas fa-user"></i>';
          messageContainer.appendChild(avatar);
        }
        
        chatMessages.appendChild(messageContainer);
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        this.chatHistory.push({
          content: content,
          isUser: isUser,
          timestamp: timestamp || new Date().toISOString()
        });
        
        if (this.chatHistory.length > 3) {
          this.chatHistory = this.chatHistory.slice(-3);
        }
        
        localStorage.setItem('chatHistory', JSON.stringify(this.chatHistory));
      }
      
      parseMarkdown(text) {
        return text.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
      }
      
      addBotMessage(content, saveToHistory = true, messageId = null) {
        if (saveToHistory) {
          this.addMessageToChat(content, false, null, messageId);
        } else {
          const chatMessages = document.getElementById('chatMessages');
          const messageContainer = document.createElement('div');
          messageContainer.className = 'message-container bot-container';
          
          const avatar = document.createElement('div');
          avatar.className = 'avatar bot-avatar-small';
          avatar.innerHTML = '<i class="fas fa-robot"></i>';
          messageContainer.appendChild(avatar);
          
          const messageBubble = document.createElement('div');
          messageBubble.className = 'message-bubble bot-bubble';
          
          const processedContent = this.parseMarkdown(content);
          
          const messageContent = document.createElement('div');
          messageContent.className = 'message-content';
          messageContent.innerHTML = processedContent;
          
          const messageTime = document.createElement('div');
          messageTime.className = 'bubble-time';
          messageTime.textContent = this.formatTime(new Date());
          
          messageBubble.appendChild(messageContent);
          messageBubble.appendChild(messageTime);
          
          messageContainer.appendChild(messageBubble);
          chatMessages.appendChild(messageContainer);
          
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }
      
      typeMessage(text, callback = null, messageId = null) {
        const chatMessages = document.getElementById('chatMessages');
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container bot-container';
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar bot-avatar-small';
        avatar.innerHTML = '<i class="fas fa-robot"></i>';
        messageContainer.appendChild(avatar);
        
        const messageBubble = document.createElement('div');
        messageBubble.className = 'message-bubble bot-bubble';
        
        const processedText = this.parseMarkdown(text);
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.innerHTML = `<span class="typing-text">${processedText}</span>`;
        
        const messageTime = document.createElement('div');
        messageTime.className = 'bubble-time';
        messageTime.textContent = this.formatTime(new Date());
        
        messageBubble.appendChild(messageContent);
        messageBubble.appendChild(messageTime);
        
        messageContainer.appendChild(messageBubble);
        chatMessages.appendChild(messageContainer);
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        this.chatHistory.push({
          content: text,
          isUser: false,
          timestamp: new Date().toISOString()
        });
        
        if (this.chatHistory.length > 3) {
          this.chatHistory = this.chatHistory.slice(-3);
        }
        
        localStorage.setItem('chatHistory', JSON.stringify(this.chatHistory));
        
        if (callback) {
          setTimeout(callback, text.length * 30 + 300);
        }
      }
      
      showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container bot-container';
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar bot-avatar-small';
        avatar.innerHTML = '<i class="fas fa-robot"></i>';
        messageContainer.appendChild(avatar);
        
        const typingBubble = document.createElement('div');
        typingBubble.className = 'typing-indicator';
        typingBubble.id = 'typingIndicator';
        typingBubble.innerHTML = `
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        `;
        
        messageContainer.appendChild(typingBubble);
        chatMessages.appendChild(messageContainer);
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
          typingIndicator.parentElement.remove();
        }
      }
      
      sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (message) {
          this.addUserMessage(message);
          input.value = '';
          
          this.showTypingIndicator();
          setTimeout(() => {
            this.hideTypingIndicator();
            this.processUserMessage(message);
          }, 1000 + Math.random() * 1000);
        }
      }
      
      processUserMessage(message) {
        const lowerMessage = message.toLowerCase();
        
        if (lowerMessage.includes('resumo') || lowerMessage.includes('como estou') || lowerMessage.includes('tarefas')) {
          this.showDailySummary();
        } else if (lowerMessage.includes('registrar') || lowerMessage.includes('adicionar')) {
          this.openRegisterModal();
        } else if (lowerMessage.includes('configurar') || lowerMessage.includes('config')) {
          this.showConfigModal();
        } else if (lowerMessage.includes('ajuda') || lowerMessage.includes('comandos')) {
          this.showHelp();
        } else if (lowerMessage.includes('info') || lowerMessage.includes('sobre')) {
          this.showInfo();
        } else if (lowerMessage.includes('edital')) {
          this.showEditalMenu();
        } else if (lowerMessage.includes('simulado')) {
          this.showSimuladosMenu();
        } else if (lowerMessage.includes('reset')) {
          this.showResetConfirmation();
        } else {
          this.typeMessage("Entendi sua mensagem! Posso te ajudar com:\n\n• <strong>Resumo do dia</strong>\n• <strong>Registrar atividades</strong>\n• <strong>Edital</strong>\n• <strong>Simulados</strong>\n• <strong>Configurações</strong>\n• <strong>Ajuda e informações</strong>\n\nO que você gostaria de fazer?");
        }
      }
      
      showHelp() {
        const helpCard = `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-question-circle"></i>
              <div class="message-card-title">Como posso ajudá-lo?</div>
            </div>
            <div class="message-card-content">
              <div class="message-list">
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-calendar-day"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Resumo do dia</div>
                    <div class="message-list-description">Mostrar tarefas e progresso atual</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-plus-circle"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Registrar atividades</div>
                    <div class="message-list-description">Questões, Anki ou teoria</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-history"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Registrar atividades de ontem</div>
                    <div class="message-list-description">Para quando esqueceu de registrar no dia anterior</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-file-alt"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Edital</div>
                    <div class="message-list-description">Ver progresso no edital completo ou por matéria</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-chart-line"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Simulados</div>
                    <div class="message-list-description">Ver notas e relatórios de simulados</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-calendar-alt"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Programar Simulado</div>
                    <div class="message-list-description">Definir intervalos para simulados</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-chart-bar"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Relatório Periódico</div>
                    <div class="message-list-description">Gerar relatórios de desempenho</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-sync-alt"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Trocar Baralhos</div>
                    <div class="message-list-description">Corrigir manualmente a ordem dos baralhos do dia</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-cog"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Configurar</div>
                    <div class="message-list-description">Ajustar quantidade de matérias por dia</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-question-circle"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Ajuda</div>
                    <div class="message-list-description">Mostrar esta mensagem de ajuda</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-info"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Informações</div>
                    <div class="message-list-description">Sobre o StudyFlow</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-exclamation-triangle"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Reset</div>
                    <div class="message-list-description">Função temporária para corrigir travamentos</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        this.addBotMessage(helpCard, true, 'help-message');
      }
      
      showInfo() {
        const infoCard = `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-info-circle"></i>
              <div class="message-card-title">Sobre o StudyFlow</div>
            </div>
            <div class="message-card-content">
              <div class="message-text">
                O StudyFlow é seu assistente pessoal de estudos, integrando todas as suas ferramentas de aprendizado em um só lugar.
              </div>
              <div class="message-muted" style="margin-top: 10px">
                Comigo você pode:
              </div>
              <div class="message-list" style="margin-top: 8px">
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-check"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Gerenciar seu ciclo de estudos</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-check"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Registrar questões e revisões</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-check"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Acompanhar seu progresso no edital</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-check"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Analisar desempenho em simulados</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-check"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Receber alertas e lembretes</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-check"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Programar simulados</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-check"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Gerar relatórios periódicos</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-check"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Corrigir manualmente a ordem dos baralhos</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-check"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Registrar atividades do dia anterior</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        this.addBotMessage(infoCard, true, 'info-message');
      }
      
      showQuickActions() {
        this.addBotMessage(`
          <div class="quick-actions">
            <button class="action-btn secondary" onclick="chatBot.openRegisterModal()">
              <i class="fas fa-plus-circle"></i> Registrar
            </button>
            <button class="action-btn finalizar-dia" onclick="window.UI_ENHANCER.callFinalizeDay()">
              <i class="fas fa-check-double"></i> Finalizar Dia
            </button>
            <button class="action-btn info" onclick="chatBot.openYesterdayModal()">
              <i class="fas fa-history"></i> Registrar Atividades de Ontem
            </button>
            <button class="action-btn info" onclick="chatBot.showEditalMenu()">
              <i class="fas fa-file-alt"></i> Edital
            </button>
            <button class="action-btn info" onclick="chatBot.showSimuladosMenu()">
              <i class="fas fa-chart-line"></i> Simulados
            </button>
            <button class="action-btn info" onclick="chatBot.showSimuladoModal()">
              <i class="fas fa-calendar-alt"></i> Programar Simulado
            </button>
            <button class="action-btn info" onclick="chatBot.showRelatorioModal()">
              <i class="fas fa-chart-bar"></i> Relatório
            </button>
            <button class="action-btn info" onclick="chatBot.trocarBaralhos()">
              <i class="fas fa-sync-alt"></i> Trocar Baralhos
            </button>
            <button class="action-btn info" onclick="chatBot.showConfigModal()">
              <i class="fas fa-cog"></i> Configurar
            </button>
            <button class="action-btn info" onclick="chatBot.showHelp()">
              <i class="fas fa-question-circle"></i> Ajuda
            </button>
            <button class="action-btn info" onclick="chatBot.showInfo()">
              <i class="fas fa-info"></i> Informações
            </button>
            <button class="action-btn reset" onclick="chatBot.showResetConfirmation()">
              <i class="fas fa-exclamation-triangle"></i> Reset
            </button>
          </div>
        `, false);
      }
      
      toggleEmojiPicker() {
        const emojis = ["😊", "👍", "❤️", "🔥", "⭐", "📚", "🎯", "💡", "🚀", "✅"];
        
        let emojiHTML = '<div class="quick-actions">';
        emojis.forEach(emoji => {
          emojiHTML += `<button class="action-btn" onclick="chatBot.addEmoji('${emoji}')">${emoji}</button>`;
        });
        emojiHTML += '</div>';
        
        this.addBotMessage(emojiHTML, false);
      }
      
      addEmoji(emoji) {
        const input = document.getElementById('messageInput');
        input.value += emoji;
        input.focus();
      }
      
      showConfigModal() {
        document.getElementById('configModal').style.display = 'flex';
        document.getElementById('materiasPorDia').value = this.materiasPorDia;
      }
      
      closeConfigModal() {
        document.getElementById('configModal').style.display = 'none';
      }
      
      saveConfig() {
        const materiasPorDia = parseInt(document.getElementById('materiasPorDia').value);
        if (materiasPorDia >= 1 && materiasPorDia <= 5) {
          this.materiasPorDia = materiasPorDia;
          localStorage.setItem('studyFlow_materiasPorDia', materiasPorDia.toString());
          this.closeConfigModal();
          this.typeMessage(`Configuração salva! Agora você verá ${materiasPorDia} matéria(s) por dia.`);
          
          // Atualizar painel lateral
          if (window.UI_ENHANCER && window.UI_ENHANCER.updateSidePanel) {
            window.UI_ENHANCER.updateSidePanel();
          }
        } else {
          alert('Por favor, informe um número entre 1 e 5.');
        }
      }
      
      showSimuladoModal() {
        document.getElementById('simuladoModal').style.display = 'flex';
        const simuladoConfig = JSON.parse(localStorage.getItem('studyFlow_simuladoConfig')) || {};
        document.getElementById('simuladoInterval').value = simuladoConfig.interval || '0';
      }
      
      closeSimuladoModal() {
        document.getElementById('simuladoModal').style.display = 'none';
      }
      
      saveSimuladoConfig() {
        const interval = parseInt(document.getElementById('simuladoInterval').value);
        const simuladoConfig = {
          interval: interval
        };
        
        if (interval > 0) {
          const hoje = new Date();
          const nextSimulado = new Date();
          nextSimulado.setDate(hoje.getDate() + interval);
          simuladoConfig.nextSimulado = nextSimulado.toISOString();
        }
        
        localStorage.setItem('studyFlow_simuladoConfig', JSON.stringify(simuladoConfig));
        this.closeSimuladoModal();
        this.typeMessage('Configuração de simulado salva!');
      }
      
      showRelatorioModal() {
        document.getElementById('relatorioModal').style.display = 'flex';
      }
      
      closeRelatorioModal() {
        document.getElementById('relatorioModal').style.display = 'none';
      }
      
      generateRelatorio() {
        const periodo = parseInt(document.getElementById('relatorioPeriodo').value);
        this.closeRelatorioModal();
        
        const hoje = new Date();
        const periodData = this.getPeriodData(periodo);
        const previousPeriodData = this.getPeriodData(periodo, periodo);
        
        const atualTotais = this.calculatePeriodTotals(periodData);
        const anteriorTotais = this.calculatePeriodTotals(previousPeriodData);
        
        const relatorioHTML = this.generateRelatorioHTML(periodo, atualTotais, anteriorTotais);
        this.addBotMessage(relatorioHTML, true, 'relatorio-periodico');
      }
      
      getPeriodData(dias, offset = 0) {
        const data = [];
        const hoje = new Date();
        
        for (let i = offset + dias - 1; i >= offset; i--) {
          const dataItem = new Date();
          dataItem.setDate(hoje.getDate() - i);
          const dataStr = dataItem.toISOString().split('T')[0];
          const atividades = JSON.parse(localStorage.getItem(`dailyActivities_${dataStr}`)) || { activities: {} };
          
          if (Object.keys(atividades.activities).length > 0) {
            data.push({
              date: dataStr,
              atividades: atividades.activities
            });
          }
        }
        
        return data;
      }
      
      calculatePeriodTotals(periodData) {
        const totais = {
          totalTime: 0,
          totalQuestoes: 0,
          totalAcertos: 0,
          totalAnkiDecks: 0,
          totalFlashcards: 0
        };
        
        periodData.forEach(dia => {
          if (dia.atividades.questoes && dia.atividades.questoes.length > 0) {
            dia.atividades.questoes.forEach(q => {
              totais.totalTime += q.tempo;
              totais.totalQuestoes += q.feitas;
              totais.totalAcertos += (q.feitas - q.erradas);
            });
          }
          
          if (dia.atividades.anki && dia.atividades.anki.length > 0) {
            totais.totalAnkiDecks += dia.atividades.anki.length;
            dia.atividades.anki.forEach(a => {
              totais.totalTime += a.tempo;
              totais.totalFlashcards += a.cards;
            });
          }
          
          if (dia.atividades.teoria && dia.atividades.teoria.length > 0) {
            dia.atividades.teoria.forEach(t => {
              totais.totalTime += t.tempo;
            });
          }
        });
        
        return totais;
      }
      
      generateRelatorioHTML(periodo, atualTotais, anteriorTotais) {
        const diffTime = atualTotais.totalTime - anteriorTotais.totalTime;
        const diffQuestoes = atualTotais.totalQuestoes - anteriorTotais.totalQuestoes;
        const diffAnkiDecks = atualTotais.totalAnkiDecks - anteriorTotais.totalAnkiDecks;
        const diffFlashcards = atualTotais.totalFlashcards - anteriorTotais.totalFlashcards;
        
        const atualAcertosPercent = atualTotais.totalQuestoes > 0 ? (atualTotais.totalAcertos / atualTotais.totalQuestoes) * 100 : 0;
        const anteriorAcertosPercent = anteriorTotais.totalQuestoes > 0 ? (anteriorTotais.totalAcertos / anteriorTotais.totalQuestoes) * 100 : 0;
        const diffAcertosPercent = atualAcertosPercent - anteriorAcertosPercent;
        
        const atualHours = Math.floor(atualTotais.totalTime / 60);
        const atualMinutes = atualTotais.totalTime % 60;
        
        return `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-chart-bar"></i>
              <div class="message-card-title">Relatório Periódico (${periodo} dias)</div>
            </div>
            <div class="message-card-content">
              <div class="message-stats">
                <div class="message-stat">
                  <div class="message-stat-value">${atualHours}h ${atualMinutes}m</div>
                  <div class="message-stat-label">Tempo Total</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${atualTotais.totalQuestoes}</div>
                  <div class="message-stat-label">Questões</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${atualAcertosPercent.toFixed(1)}%</div>
                  <div class="message-stat-label">Acertos</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${atualTotais.totalFlashcards}</div>
                  <div class="message-stat-label">Flashcards</div>
                </div>
              </div>
              
              <div class="message-section">
                <div class="message-section-title">Comparação com Período Anterior</div>
                <div class="message-list">
                  <div class="message-list-item">
                    <div class="message-list-icon">⏱️</div>
                    <div class="message-list-content">
                      <div class="message-list-title">Horas estudadas</div>
                      <div class="message-list-description">
                        ${diffTime > 0 ? 
                          `<span style="color: var(--success)">+${diffTime} min</span> em relação ao período anterior` : 
                          diffTime < 0 ? 
                          `<span style="color: var(--danger)">${diffTime} min</span> em relação ao período anterior` : 
                          'Mesmo tempo de estudo que o período anterior'}
                      </div>
                    </div>
                  </div>
                  
                  <div class="message-list-item">
                    <div class="message-list-icon">🧩</div>
                    <div class="message-list-content">
                      <div class="message-list-title">Questões resolvidas</div>
                      <div class="message-list-description">
                        ${diffQuestoes > 0 ? 
                          `<span style="color: var(--success)">+${diffQuestoes} questões</span> em relação ao período anterior` : 
                          diffQuestoes < 0 ? 
                          `<span style="color: var(--danger)">${diffQuestoes} questões</span> em relação ao período anterior` : 
                          'Mesma quantidade de questões que o período anterior'}
                      </div>
                    </div>
                  </div>
                  
                  <div class="message-list-item">
                    <div class="message-list-icon">📊</div>
                    <div class="message-list-content">
                      <div class="message-list-title">Porcentagem de acertos</div>
                      <div class="message-list-description">
                        ${diffAcertosPercent > 0 ? 
                          `<span style="color: var(--success)">+${diffAcertosPercent.toFixed(1)}%</span> em relação ao período anterior` : 
                          diffAcertosPercent < 0 ? 
                          `<span style="color: var(--danger)">${diffAcertosPercent.toFixed(1)}%</span> em relação ao período anterior` : 
                          'Mesma porcentagem de acertos que o período anterior'}
                      </div>
                    </div>
                  </div>
                  
                  <div class="message-list-item">
                    <div class="message-list-icon">🔁</div>
                    <div class="message-list-content">
                      <div class="message-list-title">Flashcards revisados</div>
                      <div class="message-list-description">
                        ${diffFlashcards > 0 ? 
                          `<span style="color: var(--success)">+${diffFlashcards} flashcards</span> em relação ao período anterior` : 
                          diffFlashcards < 0 ? 
                          `<span style="color: var(--danger)">${diffFlashcards} flashcards</span> em relação ao período anterior` : 
                          'Mesma quantidade de flashcards que o período anterior'}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      getTodayDecks() {
        const ankiData = this.getModuleData('ciclos_focus_v1');
        if (!ankiData || !ankiData.decks || !ankiData.perDay) return [];
        
        const perDay = ankiData.perDay;
        const blockIndex = ankiData.blockIndex || 0;
        
        const startIndex = blockIndex * perDay;
        const todayDecks = ankiData.decks.slice(startIndex, startIndex + perDay);
        
        return todayDecks.map(deck => deck.name);
      }
      
      checkAlerts() {
        const alertas = [];
        const hoje = new Date();
        
        const revisoesAtrasadas = this.calculateOverdueReviews();
        if (revisoesAtrasadas > 0) {
          alertas.push({
            tipo: 'alert-danger',
            icone: 'exclamation-triangle',
            mensagem: `Você tem ${revisoesAtrasadas} revisões atrasadas!`
          });
        }
        
        const dailyCompletedReviews = this.getModuleData('dailyCompletedReviews') || 0;
        const dailyReviewGoal = this.getModuleData('dailyReviewGoal') || 5;
        
        const lastReviewDate = this.getModuleData('lastReviewDate');
        const hojeStr = hoje.toISOString().split('T')[0];
        
        if (lastReviewDate !== hojeStr) {
          this.setModuleData('dailyCompletedReviews', 0);
          this.setModuleData('lastReviewDate', hojeStr);
        } else if (dailyCompletedReviews < dailyReviewGoal / 2) {
          alertas.push({
            tipo: 'alert-warning',
            icone: 'bullseye',
            mensagem: `Você completou apenas ${dailyCompletedReviews} de ${dailyReviewGoal} revisões hoje.`
          });
        }
        
        const ultimoEstudo = localStorage.getItem('ultimoEstudo');
        if (ultimoEstudo) {
          const diasSemEstudo = Math.floor((hoje - new Date(ultimoEstudo)) / (1000 * 60 * 60 * 24));
          if (diasSemEstudo >= 2) {
            alertas.push({
              tipo: 'alert-danger',
              icone: 'calendar-times',
              mensagem: `Você não estuda há ${diasSemEstudo} dias!`
            });
          }
        }
        
        return alertas;
      }
      
      showEditalMenu() {
        const editalData = this.getEditalData();
        if (!editalData) {
          this.typeMessage("Não encontrei dados do edital verticalizado. Verifique se você já importou um edital no módulo correspondente.");
          return;
        }
        
        this.addBotMessage(`
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-file-alt"></i>
              <div class="message-card-title">Progresso no Edital</div>
            </div>
            <div class="message-card-content">
              <div class="message-text">
                Você quer ver seu progresso no edital completo ou em uma matéria específica?
              </div>
              <div class="quick-actions" style="margin-top: 12px">
                <button class="action-btn primary" onclick="chatBot.showEditalCompleto()">
                  <i class="fas fa-chart-pie"></i> Todo o Edital
                </button>
                <button class="action-btn secondary" onclick="chatBot.showMateriasEdital()">
                  <i class="fas fa-book"></i> Matéria Específica
                </button>
              </div>
            </div>
          </div>
        `, true, 'edital-menu');
      }
      
      getEditalData() {
        try {
          const editais = JSON.parse(localStorage.getItem('editais'));
          const editalAtivoId = localStorage.getItem('editalAtivoId');
          
          if (!editais || !editalAtivoId) {
            return null;
          }
          
          const editalAtivo = editais.find(edital => edital.id === editalAtivoId);
          if (!editalAtivo) {
            return null;
          }
          
          const completedTopicsKey = `completedTopics_${editalAtivoId}`;
          const completedTopics = JSON.parse(localStorage.getItem(completedTopicsKey)) || {};
          
          return {
            edital: editalAtivo,
            progresso: completedTopics
          };
        } catch (error) {
          return null;
        }
      }
      
      showEditalCompleto() {
        const editalData = this.getEditalData();
        if (!editalData) {
          this.typeMessage("Não foi possível carregar os dados do edital.");
          return;
        }
        
        const { edital, progresso } = editalData;
        
        let totalTopicos = 0;
        let topicosConcluidos = 0;
        
        edital.disciplinas.forEach(disciplina => {
          disciplina.topicos.forEach(topico => {
            totalTopicos++;
            const chaveTopico = `${disciplina.nome}-${topico}`;
            if (progresso[chaveTopico]) {
              topicosConcluidos++;
            }
          });
        });
        
        const porcentagemTotal = totalTopicos > 0 ? Math.round((topicosConcluidos / totalTopicos) * 100) : 0;
        
        const progressoDisciplinas = edital.disciplinas.map(disciplina => {
          let topicosDisciplina = 0;
          let concluidosDisciplina = 0;
          
          disciplina.topicos.forEach(topico => {
            topicosDisciplina++;
            const chaveTopico = `${disciplina.nome}-${topico}`;
            if (progresso[chaveTopico]) {
              concluidosDisciplina++;
            }
          });
          
          const porcentagem = topicosDisciplina > 0 ? Math.round((concluidosDisciplina / topicosDisciplina) * 100) : 0;
          
          return {
            nome: disciplina.nome,
            concluidos: concluidosDisciplina,
            total: topicosDisciplina,
            porcentagem: porcentagem
          };
        });
        
        progressoDisciplinas.sort((a, b) => a.porcentagem - b.porcentagem);
        
        let relatorioHTML = `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-chart-pie"></i>
              <div class="message-card-title">Progresso Geral do Edital</div>
            </div>
            <div class="message-card-content">
              <div class="message-stats">
                <div class="message-stat">
                  <div class="message-stat-value">${porcentagemTotal}%</div>
                  <div class="message-stat-label">Concluído</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${topicosConcluidos}/${totalTopicos}</div>
                  <div class="message-stat-label">Tópicos</div>
                </div>
              </div>
              <div class="message-progress">
                <div class="message-progress-bar">
                  <div class="message-progress-fill" style="width: ${porcentagemTotal}%"></div>
                </div>
                <div class="message-progress-text">
                  <span>0%</span>
                  <span>${porcentagemTotal}%</span>
                  <span>100%</span>
                </div>
              </div>
              <div class="message-section">
                <div class="message-section-title">Progresso por Disciplina</div>
                <div class="message-list">
        `;
        
        progressoDisciplinas.forEach(disciplina => {
          const statusClass = disciplina.porcentagem >= 80 ? 'success' : disciplina.porcentagem >= 50 ? 'warning' : 'danger';
          
          relatorioHTML += `
            <div class="message-list-item">
              <div class="message-list-icon"><i class="fas fa-book"></i></div>
              <div class="message-list-content">
                <div class="message-list-title">${disciplina.nome}</div>
                <div class="message-list-description">
                  ${disciplina.concluidos}/${disciplina.total} tópicos
                  <span class="message-badge message-badge-${statusClass}">${disciplina.porcentagem}%</span>
                </div>
              </div>
            </div>
          `;
        });
        
        relatorioHTML += `
                </div>
              </div>
            </div>
          </div>
        `;
        
        this.addBotMessage(relatorioHTML, true, 'edital-completo');
      }
      
      showMateriasEdital() {
        const editalData = this.getEditalData();
        if (!editalData) {
          this.typeMessage("Não foi possível carregar os dados do edital.");
          return;
        }
        
        const { edital } = editalData;
        
        let materiasHTML = `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-book"></i>
              <div class="message-card-title">Selecione uma Matéria</div>
            </div>
            <div class="message-card-content">
              <div class="quick-actions">
        `;
        
        edital.disciplinas.forEach(disciplina => {
          materiasHTML += `
            <button class="action-btn info" onclick="chatBot.showEditalMateria('${disciplina.nome}')">
              <i class="fas fa-book-open"></i> ${disciplina.nome}
            </button>
          `;
        });
        
        materiasHTML += `
              </div>
            </div>
          </div>
        `;
        
        this.addBotMessage(materiasHTML, true, 'materias-edital');
      }
      
      showEditalMateria(materiaNome) {
        const editalData = this.getEditalData();
        if (!editalData) {
          this.typeMessage("Não foi possível carregar os dados do edital.");
          return;
        }
        
        const { edital, progresso } = editalData;
        const disciplina = edital.disciplinas.find(d => d.nome === materiaNome);
        
        if (!disciplina) {
          this.typeMessage("Matéria não encontrada no edital.");
          return;
        }
        
        let totalTopicos = 0;
        let topicosConcluidos = 0;
        const topicosDetalhados = [];
        
        disciplina.topicos.forEach(topico => {
          totalTopicos++;
          const chaveTopico = `${disciplina.nome}-${topico}`;
          const concluido = progresso[chaveTopico] || false;
          
          if (concluido) {
            topicosConcluidos++;
          }
          
          topicosDetalhados.push({
            nome: topico,
            concluido: concluido
          });
        });
        
        const porcentagem = totalTopicos > 0 ? Math.round((topicosConcluidos / totalTopicos) * 100) : 0;
        
        let materiaHTML = `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-book-open"></i>
              <div class="message-card-title">${disciplina.nome}</div>
            </div>
            <div class="message-card-content">
              <div class="message-stats">
                <div class="message-stat">
                  <div class="message-stat-value">${porcentagem}%</div>
                  <div class="message-stat-label">Concluído</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${topicosConcluidos}/${totalTopicos}</div>
                  <div class="message-stat-label">Tópicos</div>
                </div>
              </div>
              <div class="message-progress">
                <div class="message-progress-bar">
                  <div class="message-progress-fill" style="width: ${porcentagem}%"></div>
                </div>
                <div class="message-progress-text">
                  <span>0%</span>
                  <span>${porcentagem}%</span>
                  <span>100%</span>
                </div>
              </div>
              <div class="message-section">
                <div class="message-section-title">Tópicos</div>
                <div class="message-list">
        `;
        
        topicosDetalhados.forEach(topico => {
          const statusIcon = topico.concluido ? 'check-circle' : 'circle';
          const statusColor = topico.concluido ? 'success' : 'gray';
          
          materiaHTML += `
            <div class="message-list-item">
              <div class="message-list-icon" style="color: var(--${statusColor})">
                <i class="fas fa-${statusIcon}"></i>
              </div>
              <div class="message-list-content">
                <div class="message-list-title">${topico.nome}</div>
                <div class="message-list-description">
                  ${topico.concluido ? 'Concluído' : 'Pendente'}
                </div>
              </div>
            </div>
          `;
        });
        
        materiaHTML += `
                </div>
              </div>
            </div>
          </div>
        `;
        
        this.addBotMessage(materiaHTML, true, `edital-${materiaNome}`);
      }
      
      showSimuladosMenu() {
        const simuladosData = this.getSimuladosData();
        if (!simuladosData || simuladosData.simulados.length === 0) {
          this.typeMessage("Não encontrei dados de simulados. Verifique se você já realizou algum simulado no módulo correspondente.");
          return;
        }
        
        this.addBotMessage(`
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-chart-line"></i>
              <div class="message-card-title">Análise de Simulados</div>
            </div>
            <div class="message-card-content">
              <div class="message-text">
                O que você gostaria de ver?
              </div>
              <div class="quick-actions" style="margin-top: 12px">
                <button class="action-btn primary" onclick="chatBot.showUltimoSimuladoNota()">
                  <i class="fas fa-star"></i> Nota do Último Simulado
                </button>
                <button class="action-btn secondary" onclick="chatBot.showUltimoSimuladoRelatorio()">
                  <i class="fas fa-chart-bar"></i> Relatório Completo
                </button>
                <button class="action-btn info" onclick="chatBot.showUltimoSimuladoData()">
                  <i class="fas fa-calendar"></i> Data do Último Simulado
                </button>
              </div>
            </div>
          </div>
        `, true, 'simulados-menu');
      }
      
      getSimuladosData() {
        try {
          const simulados = JSON.parse(localStorage.getItem('simulados')) || [];
          const provas = JSON.parse(localStorage.getItem('provas')) || [];
          const provaAtivaId = localStorage.getItem('provaAtivaId');
          
          if (simulados.length === 0) {
            return null;
          }
          
          simulados.sort((a, b) => new Date(b.date) - new Date(a.date));
          
          const ultimoSimulado = simulados[0];
          const prova = provas.find(p => p.id === ultimoSimulado.idProva);
          
          return {
            simulados: simulados,
            ultimoSimulado: ultimoSimulado,
            prova: prova,
            provaAtivaId: provaAtivaId
          };
        } catch (error) {
          return null;
        }
      }
      
      showUltimoSimuladoNota() {
        const simuladosData = this.getSimuladosData();
        if (!simuladosData) {
          this.typeMessage("Não foi possível carregar os dados dos simulados.");
          return;
        }
        
        const { ultimoSimulado, prova } = simuladosData;
        const dataFormatada = new Date(ultimoSimulado.date).toLocaleDateString('pt-BR');
        
        const porcentagem = parseFloat(ultimoSimulado.totalPercentage);
        let classificacao = '';
        let corClassificacao = '';
        
        if (porcentagem >= 90) {
          classificacao = 'EXCELENTE';
          corClassificacao = 'success';
        } else if (porcentagem >= 80) {
          classificacao = 'ÓTIMO';
          corClassificacao = 'primary';
        } else if (porcentagem >= 66) {
          classificacao = 'BOM';
          corClassificacao = 'secondary';
        } else if (porcentagem >= 51) {
          classificacao = 'MÉDIO';
          corClassificacao = 'warning';
        } else if (porcentagem >= 31) {
          classificacao = 'FRACO';
          corClassificacao = 'warning';
        } else {
          classificacao = 'CRÍTICO';
          corClassificacao = 'danger';
        }
        
        const notaHTML = `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-star"></i>
              <div class="message-card-title">Nota do Último Simulado</div>
            </div>
            <div class="message-card-content">
              <div class="message-stats">
                <div class="message-stat">
                  <div class="message-stat-value">${ultimoSimulado.totalScore}</div>
                  <div class="message-stat-label">Pontuação</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${ultimoSimulado.totalPercentage}%</div>
                  <div class="message-stat-label">Acertos</div>
                </div>
              </div>
              <div class="message-alert message-alert-${corClassificacao}">
                <i class="fas fa-${porcentagem >= 66 ? 'check' : 'exclamation'}-circle"></i>
                <div><strong>Classificação: ${classificacao}</strong></div>
              </div>
              <div class="message-list">
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-calendar"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Data</div>
                    <div class="message-list-description">${dataFormatada}</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-clock"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Tempo Total</div>
                    <div class="message-list-description">${ultimoSimulado.totalTime} minutos</div>
                  </div>
                </div>
                ${prova ? `
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-file-alt"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Prova</div>
                    <div class="message-list-description">${prova.nomeConcurso} - ${prova.nomeBanca}</div>
                  </div>
                </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;
        
        this.addBotMessage(notaHTML, true, 'ultimo-simulado-nota');
      }
      
      showUltimoSimuladoRelatorio() {
        const simuladosData = this.getSimuladosData();
        if (!simuladosData) {
          this.typeMessage("Não foi possível carregar os dados dos simulados.");
          return;
        }
        
        const { ultimoSimulado, prova } = simuladosData;
        const dataFormatada = new Date(ultimoSimulado.date).toLocaleDateString('pt-BR');
        
        const disciplinas = [];
        
        if (prova && prova.disciplinas) {
          Object.keys(prova.disciplinas).forEach(categoria => {
            Object.keys(prova.disciplinas[categoria]).forEach(disciplina => {
              if (ultimoSimulado.details[disciplina]) {
                disciplinas.push({
                  nome: disciplina,
                  categoria: categoria,
                  detalhes: ultimoSimulado.details[disciplina],
                  tempo: ultimoSimulado.time[disciplina] || 0
                });
              }
            });
          });
        } else {
          Object.keys(ultimoSimulado.details).forEach(disciplina => {
            disciplinas.push({
              nome: disciplina,
              categoria: 'GERAL',
              detalhes: ultimoSimulado.details[disciplina],
              tempo: ultimoSimulado.time[disciplina] || 0
            });
          });
        }
        
        let relatorioHTML = `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-chart-bar"></i>
              <div class="message-card-title">Relatório Completo - ${dataFormatada}</div>
            </div>
            <div class="message-card-content">
              <div class="message-stats">
                <div class="message-stat">
                  <div class="message-stat-value">${ultimoSimulado.totalScore}</div>
                  <div class="message-stat-label">Pontuação</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${ultimoSimulado.totalPercentage}%</div>
                  <div class="message-stat-label">Acertos</div>
                </div>
                <div class="message-stat">
                  <div class="message-stat-value">${ultimoSimulado.totalTime}</div>
                  <div class="message-stat-label">Minutos</div>
                </div>
              </div>
              <div class="message-section">
                <div class="message-section-title">Desempenho por Disciplina</div>
                <div class="message-list">
        `;
        
        disciplinas.forEach(disciplina => {
          const porcentagem = parseFloat(disciplina.detalhes.percentage);
          let statusClass = '';
          if (porcentagem >= 80) statusClass = 'success';
          else if (porcentagem >= 60) statusClass = 'warning';
          else statusClass = 'danger';
          
          relatorioHTML += `
            <div class="message-list-item">
              <div class="message-list-icon"><i class="fas fa-book"></i></div>
              <div class="message-list-content">
                <div class="message-list-title">${disciplina.nome}</div>
                <div class="message-list-description">
                  ${disciplina.detalhes.correct} acertos de ${disciplina.detalhes.correct + disciplina.detalhes.errors}
                  <span class="message-badge message-badge-${statusClass}">${disciplina.detalhes.percentage}%</span>
                </div>
                <div class="message-list-description">
                  Pontuação: ${disciplina.detalhes.score} • Tempo: ${disciplina.tempo} min
                </div>
              </div>
            </div>
          `;
        });
        
        relatorioHTML += `
                </div>
              </div>
            </div>
          </div>
        `;
        
        this.addBotMessage(relatorioHTML, true, 'ultimo-simulado-relatorio');
      }
      
      showUltimoSimuladoData() {
        const simuladosData = this.getSimuladosData();
        if (!simuladosData) {
          this.typeMessage("Não foi possível carregar os dados dos simulados.");
          return;
        }
        
        const { ultimoSimulado, simulados } = simuladosData;
        const dataFormatada = new Date(ultimoSimulado.date).toLocaleDateString('pt-BR');
        
        const hoje = new Date();
        const dataSimulado = new Date(ultimoSimulado.date);
        const diffTime = Math.abs(hoje - dataSimulado);
        const diffDias = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        const dataHTML = `
          <div class="message-card">
            <div class="message-card-header">
              <i class="fas fa-calendar"></i>
              <div class="message-card-title">Data do Último Simulado</div>
            </div>
            <div class="message-card-content">
              <div class="message-alert message-alert-info">
                <i class="fas fa-info-circle"></i>
                <div>Seu último simulado foi realizado há <strong>${diffDias} dia(s)</strong></div>
              </div>
              <div class="message-list">
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-calendar-day"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Data</div>
                    <div class="message-list-description">${dataFormatada}</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-history"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Tempo Decorrido</div>
                    <div class="message-list-description">${diffDias} dia(s)</div>
                  </div>
                </div>
                <div class="message-list-item">
                  <div class="message-list-icon"><i class="fas fa-chart-line"></i></div>
                  <div class="message-list-content">
                    <div class="message-list-title">Total de Simulados</div>
                    <div class="message-list-description">${simulados.length} realizados</div>
                  </div>
                </div>
              </div>
              ${diffDias > 30 ? `
              <div class="message-alert message-alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>Faz mais de 30 dias desde seu último simulado. Considere realizar um novo para avaliar seu progresso.</div>
              </div>
              ` : ''}
            </div>
          </div>
        `;
        
        this.addBotMessage(dataHTML, true, 'ultimo-simulado-data');
      }
      
      addDateDivider() {
        const hoje = this.getDynamicDateObject();
        const dataFormatada = this.formatDynamicDate(hoje);
        
        const chatMessages = document.getElementById('chatMessages');
        const dateDiv = document.createElement('div');
        dateDiv.className = 'chat-date';
        dateDiv.innerHTML = `<span>${dataFormatada}</span>`;
        chatMessages.appendChild(dateDiv);
      }
    }
    
    let chatBot;
    
    /* UI ENHANCEMENTS START */
    window.UI_ENHANCER = {
      init: function() {
        this.initSidePanel();
        this.updateSidePanel();
        this.bindEvents();
        this.setupActivityListeners();
        this.addFinalizarDiaButton();
        
        // Carregar automaticamente as atividades do dia ao abrir o site
        this.loadDailyActivitiesOnOpen();
      },
      
      initSidePanel: function() {
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelToggle = document.getElementById('sidePanelToggle');
        const panelFab = document.getElementById('panelFab');
        const mobilePanelToggle = document.getElementById('mobilePanelToggle');
        
        // Verificar se está em tela pequena
        if (window.innerWidth <= 900) {
          sidePanel.classList.add('collapsed');
          panelFab.classList.add('hidden');
        } else {
          panelFab.classList.remove('hidden');
        }
        
        // Estado do painel no localStorage
        const panelState = localStorage.getItem('ui_enhancer.panel.visible');
        if (panelState === 'false' && window.innerWidth > 900) {
          sidePanel.classList.add('collapsed');
        }
        
        // Alternar painel lateral
        sidePanelToggle.addEventListener('click', () => {
          sidePanel.classList.toggle('collapsed');
          this.updateToggleIcon();
          this.updateFabVisibility();
          this.savePanelState();
        });
        
        // Botão FAB para alternar
        panelFab.addEventListener('click', () => {
          sidePanel.classList.remove('collapsed');
          this.updateToggleIcon();
          this.updateFabVisibility();
          this.savePanelState();
        });
        
        // Botão mobile para alternar
        mobilePanelToggle.addEventListener('click', () => {
          sidePanel.classList.toggle('collapsed');
          this.updateToggleIcon();
          this.updateFabVisibility();
          this.savePanelState();
        });
        
        this.updateToggleIcon();
        this.updateFabVisibility();
      },
      
      loadDailyActivitiesOnOpen: function() {
        // Carregar atividades automaticamente ao abrir a página
        if (typeof window['getDailySummary'] === 'function') {
          try {
            window.getDailySummary();
          } catch (e) {
            console.log('getDailySummary não disponível');
          }
        } else if (typeof window['fetchActivities'] === 'function') {
          try {
            window.fetchActivities().then(() => this.updateSidePanel());
          } catch (e) {
            console.log('fetchActivities não disponível');
          }
        } else if (typeof window['getActivitiesForToday'] === 'function') {
          try {
            window.getActivitiesForToday();
            this.updateSidePanel();
          } catch (e) {
            console.log('getActivitiesForToday não disponível');
          }
        } else if (chatBot) {
          // Usar a função do chatBot para carregar atividades
          chatBot.showDailySummary();
        }
        
        // Atualizar o painel lateral imediatamente
        this.updateSidePanel();
      },
      
      updateToggleIcon: function() {
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelToggle = document.getElementById('sidePanelToggle');
        const mobilePanelToggle = document.getElementById('mobilePanelToggle');
        
        if (sidePanel.classList.contains('collapsed')) {
          sidePanelToggle.innerHTML = '<i class="fas fa-chevron-left"></i>';
          sidePanelToggle.setAttribute('aria-expanded', 'false');
          mobilePanelToggle.innerHTML = '<i class="fas fa-chart-bar"></i>';
          mobilePanelToggle.setAttribute('aria-label', 'Abrir painel de resumo');
        } else {
          sidePanelToggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
          sidePanelToggle.setAttribute('aria-expanded', 'true');
          mobilePanelToggle.innerHTML = '<i class="fas fa-times"></i>';
          mobilePanelToggle.setAttribute('aria-label', 'Fechar painel de resumo');
        }
      },
      
      updateFabVisibility: function() {
        const sidePanel = document.getElementById('sidePanel');
        const panelFab = document.getElementById('panelFab');
        
        if (sidePanel.classList.contains('collapsed') && window.innerWidth > 900) {
          panelFab.classList.remove('hidden');
        } else {
          panelFab.classList.add('hidden');
        }
      },
      
      savePanelState: function() {
        const sidePanel = document.getElementById('sidePanel');
        const isVisible = !sidePanel.classList.contains('collapsed');
        localStorage.setItem('ui_enhancer.panel.visible', isVisible);
      },
      
      setupActivityListeners: function() {
        // Monitorar eventos de atividade
        if (typeof window['registerActivity'] === 'function') {
          const originalRegister = window['registerActivity'];
          window['registerActivity'] = function(...args) {
            const result = originalRegister.apply(this, args);
            // Atualizar painel após registro
            setTimeout(() => {
              window.UI_ENHANCER.updateSidePanel();
            }, 100);
            return result;
          };
        }
        
        // Patch para window.completeActivity se existir
        if (typeof window['completeActivity'] === 'function') {
          const originalComplete = window['completeActivity'];
          window['completeActivity'] = function(...args) {
            const result = originalComplete.apply(this, args);
            // Atualizar painel após completar
            setTimeout(() => {
              window.UI_ENHANCER.updateSidePanel();
            }, 100);
            return result;
          };
        }
        
        // Monitorar mudanças no localStorage
        window.addEventListener('storage', (e) => {
          if (e.key && e.key.includes('dailyActivities') || 
              e.key === 'studyFlow_partialRegistration' ||
              e.key === 'ultimoEstudo' ||
              e.key === 'StudyFlow_activeCycle' ||
              e.key === 'ciclos_focus_v1') {
            this.updateSidePanel();
          }
        });
        
        // Atualizar painel ao redimensionar a janela
        window.addEventListener('resize', () => {
          const sidePanel = document.getElementById('sidePanel');
          const panelFab = document.getElementById('panelFab');
          
          if (window.innerWidth > 900) {
            sidePanel.classList.remove('collapsed');
            panelFab.classList.add('hidden');
          } else {
            sidePanel.classList.add('collapsed');
            panelFab.classList.add('hidden');
          }
          this.updateToggleIcon();
          this.updateFabVisibility();
        });
        
        // Atualizar painel quando o chat for atualizado
        const originalAddMessage = chatBot?.addMessageToChat;
        if (originalAddMessage) {
          chatBot.addMessageToChat = function(...args) {
            const sidePanel = document.getElementById('sidePanel');
            const content = args[0];
            // Verificar se é uma mensagem de resumo e suprimir se o painel estiver visível
            if (content && content.includes('Resumo do Dia') && !sidePanel.classList.contains('collapsed')) {
              // Não adicionar mensagem de resumo ao chat se o painel estiver visível
              return null;
            }
            return originalAddMessage.apply(this, args);
          };
        }
        
        // Adicionar listener para events customizados
        document.addEventListener('activity:registered', () => {
          this.updateSidePanel();
        });
        
        // Patch para função de registrar atividades do chatBot
        if (chatBot && chatBot.saveToPartialRegistration) {
          const originalSave = chatBot.saveToPartialRegistration;
          chatBot.saveToPartialRegistration = function(activity) {
            const result = originalSave.apply(this, arguments);
            // Disparar evento customizado
            document.dispatchEvent(new CustomEvent('activity:registered'));
            return result;
          };
        }
      },
      
      addFinalizarDiaButton: function() {
        // Verificar se há um candidato para a função de finalizar dia
        const candidates = ['finalizeDay', 'finishDay', 'completeDay', 'endDay', 'closeDay'];
        const foundCandidate = candidates.find(name => typeof window[name] === 'function');
        
        if (!foundCandidate) {
          // Se não houver candidato global, verificar se chatBot tem finalizeDay
          if (!chatBot || typeof chatBot.finalizeDay !== 'function') {
            console.warn('Nenhuma função candidata encontrada para Finalizar Dia');
            return;
          }
        }
        
        // Adicionar botão Finalizar Dia aos quick-actions
        const originalShowQuickActions = chatBot.showQuickActions;
        if (originalShowQuickActions) {
          chatBot.showQuickActions = function() {
            const quickActionsHTML = `
              <div class="quick-actions">
                <button class="action-btn secondary" onclick="chatBot.openRegisterModal()">
                  <i class="fas fa-plus-circle"></i> Registrar
                </button>
                <button class="action-btn finalizar-dia" onclick="window.UI_ENHANCER.callFinalizeDay()" 
                        aria-label="Finalizar Dia" title="Finalizar Dia" role="button" tabindex="0">
                  <i class="fas fa-check-double"></i> Finalizar Dia
                </button>
                <button class="action-btn info" onclick="chatBot.openYesterdayModal()">
                  <i class="fas fa-history"></i> Registrar Atividades de Ontem
                </button>
                <button class="action-btn info" onclick="chatBot.showEditalMenu()">
                  <i class="fas fa-file-alt"></i> Edital
                </button>
                <button class="action-btn info" onclick="chatBot.showSimuladosMenu()">
                  <i class="fas fa-chart-line"></i> Simulados
                </button>
                <button class="action-btn info" onclick="chatBot.showSimuladoModal()">
                  <i class="fas fa-calendar-alt"></i> Programar Simulado
                </button>
                <button class="action-btn info" onclick="chatBot.showRelatorioModal()">
                  <i class="fas fa-chart-bar"></i> Relatório
                </button>
                <button class="action-btn info" onclick="chatBot.trocarBaralhos()">
                  <i class="fas fa-sync-alt"></i> Trocar Baralhos
                </button>
                <button class="action-btn info" onclick="chatBot.showConfigModal()">
                  <i class="fas fa-cog"></i> Configurar
                </button>
                <button class="action-btn info" onclick="chatBot.showHelp()">
                  <i class="fas fa-question-circle"></i> Ajuda
                </button>
                <button class="action-btn info" onclick="chatBot.showInfo()">
                  <i class="fas fa-info"></i> Informações
                </button>
                <button class="action-btn reset" onclick="chatBot.showResetConfirmation()">
                  <i class="fas fa-exclamation-triangle"></i> Reset
                </button>
              </div>
            `;
            this.addBotMessage(quickActionsHTML, false);
          };
        }
      },
      
      callFinalizeDay: function() {
        // Encontrar a função candidata
        const candidates = ['finalizeDay', 'finishDay', 'completeDay', 'endDay', 'closeDay'];
        let finalizeFunc = null;
        let foundCandidate = null;
        
        // Primeiro procurar no escopo global
        for (const name of candidates) {
          if (typeof window[name] === 'function') {
            finalizeFunc = window[name];
            foundCandidate = name;
            break;
          }
        }
        
        // Se não encontrou no global, verificar no chatBot
        if (!finalizeFunc && chatBot && typeof chatBot.finalizeDay === 'function') {
          finalizeFunc = chatBot.finalizeDay.bind(chatBot);
          foundCandidate = 'chatBot.finalizeDay';
        }
        
        if (!finalizeFunc) {
          console.error('Nenhuma função Finalizar Dia encontrada');
          return;
        }
        
        // Chamar a função com feedback visual
        const button = event?.target?.closest('.action-btn.finalizar-dia');
        if (button) {
          button.classList.add('action-btn.finalizar-dia-success');
          button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finalizando...';
          button.disabled = true;
        }
        
        try {
          const result = finalizeFunc();
          
          if (result && typeof result.then === 'function') {
            // É uma Promise
            result.then(() => {
              if (button) {
                button.innerHTML = '<i class="fas fa-check"></i> Dia Finalizado!';
                setTimeout(() => {
                  button.innerHTML = '<i class="fas fa-check-double"></i> Finalizar Dia';
                  button.classList.remove('action-btn.finalizar-dia-success');
                  button.disabled = false;
                }, 2000);
              }
              // Atualizar painel lateral
              this.updateSidePanel();
            }).catch(error => {
              console.error('Erro ao finalizar dia:', error);
              if (button) {
                button.innerHTML = '<i class="fas fa-exclamation-circle"></i> Erro';
                button.classList.remove('action-btn.finalizar-dia-success');
                setTimeout(() => {
                  button.innerHTML = '<i class="fas fa-check-double"></i> Finalizar Dia';
                  button.disabled = false;
                }, 2000);
              }
            });
          } else {
            // Não é uma Promise
            if (button) {
              button.innerHTML = '<i class="fas fa-check"></i> Dia Finalizado!';
              setTimeout(() => {
                button.innerHTML = '<i class="fas fa-check-double"></i> Finalizar Dia';
                button.classList.remove('action-btn.finalizar-dia-success');
                button.disabled = false;
              }, 2000);
            }
            // Atualizar painel lateral
            this.updateSidePanel();
          }
        } catch (error) {
          console.error('Erro ao chamar função Finalizar Dia:', error);
          if (button) {
            button.innerHTML = '<i class="fas fa-exclamation-circle"></i> Erro';
            button.classList.remove('action-btn.finalizar-dia-success');
            setTimeout(() => {
              button.innerHTML = '<i class="fas fa-check-double"></i> Finalizar Dia';
              button.disabled = false;
            }, 2000);
          }
        }
      },
      
      updateSidePanel: function() {
        if (!chatBot) return;
        
        const hoje = chatBot.getDynamicDateObject();
        const hojeStr = chatBot.getDynamicDateString();
        const dataFormatada = chatBot.formatDynamicDate(hoje);
        
        // Atualizar data
        document.getElementById('sidePanelDate').textContent = dataFormatada;
        
        // Buscar dados do dia
        const dailyActivities = JSON.parse(localStorage.getItem(`dailyActivities_${hojeStr}`)) || { activities: {} };
        const partialRegistration = JSON.parse(localStorage.getItem('studyFlow_partialRegistration')) || {
          date: null,
          activities: {},
          completed: false
        };
        
        // Combinar atividades registradas
        let atividades = {
          questoes: [],
          anki: [],
          teoria: []
        };
        
        if (partialRegistration.date === hojeStr) {
          atividades.questoes = atividades.questoes.concat(partialRegistration.activities.questoes || []);
          atividades.anki = atividades.anki.concat(partialRegistration.activities.anki || []);
          atividades.teoria = atividades.teoria.concat(partialRegistration.activities.teoria || []);
        }
        
        atividades.questoes = atividades.questoes.concat(dailyActivities.activities.questoes || []);
        atividades.anki = atividades.anki.concat(dailyActivities.activities.anki || []);
        atividades.teoria = atividades.teoria.concat(dailyActivities.activities.teoria || []);
        
        // Remover duplicatas
        const uniqueQuestoes = [];
        const uniqueAnki = [];
        const uniqueTeoria = [];
        
        atividades.questoes.forEach(q => {
          if (!uniqueQuestoes.find(uq => uq.assunto === q.assunto)) {
            uniqueQuestoes.push(q);
          }
        });
        
        atividades.anki.forEach(a => {
          if (!uniqueAnki.find(ua => ua.deck === a.deck)) {
            uniqueAnki.push(a);
          }
        });
        
        atividades.teoria.forEach(t => {
          if (!uniqueTeoria.find(ut => ut.materia === t.materia)) {
            uniqueTeoria.push(t);
          }
        });
        
        atividades.questoes = uniqueQuestoes;
        atividades.anki = uniqueAnki;
        atividades.teoria = uniqueTeoria;
        
        // Calcular totais
        let totalTime = 0;
        let totalQuestoes = 0;
        let totalAcertos = 0;
        let totalAnkiDecks = 0;
        let totalAnkiCards = 0;
        let totalTeoria = 0;
        
        atividades.questoes.forEach(q => {
          totalTime += q.tempo;
          totalQuestoes += q.feitas;
          totalAcertos += (q.feitas - q.erradas);
        });
        
        atividades.anki.forEach(a => {
          totalTime += a.tempo;
          totalAnkiDecks++;
          totalAnkiCards += a.cards;
        });
        
        atividades.teoria.forEach(t => {
          totalTime += t.tempo;
          totalTeoria++;
        });
        
        // Calcular progresso
        const todayTasks = chatBot.getTodayTasks();
        const totalTasks = todayTasks.questoes.length + todayTasks.anki.length + todayTasks.teoria.length;
        const completedTasks = atividades.questoes.length + atividades.anki.length + atividades.teoria.length;
        const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        // Atualizar barra de progresso
        const progressFill = document.getElementById('progressFill');
        progressFill.style.width = `${progressPercent}%`;
        progressFill.setAttribute('aria-valuenow', progressPercent);
        
        document.getElementById('progressCompleted').textContent = `${completedTasks} atividades`;
        document.getElementById('progressTotal').textContent = `${completedTasks} de ${totalTasks}`;
        
        // Atualizar estatísticas
        const statsContainer = document.getElementById('sidePanelStats');
        const taxaAcerto = totalQuestoes > 0 ? Math.round((totalAcertos / totalQuestoes) * 100) : 0;
        
        statsContainer.innerHTML = `
          <div class="stat-card tooltip">
            <div class="stat-value">${totalTime}</div>
            <div class="stat-label">Minutos</div>
            <span class="tooltip-text">Tempo total estudado hoje</span>
          </div>
          <div class="stat-card tooltip">
            <div class="stat-value">${taxaAcerto}%</div>
            <div class="stat-label">Acertos</div>
            <span class="tooltip-text">Taxa de acerto em questões</span>
          </div>
          <div class="stat-card tooltip">
            <div class="stat-value">${totalAnkiCards}</div>
            <div class="stat-label">Cards</div>
            <span class="tooltip-text">Flashcards revisados</span>
          </div>
          <div class="stat-card tooltip">
            <div class="stat-value">${totalTeoria}</div>
            <div class="stat-label">Matérias</div>
            <span class="tooltip-text">Estudos teóricos</span>
          </div>
        `;
        
        // Atualizar atividades - criar cards individuais para pendentes
        const activitiesContainer = document.getElementById('sidePanelActivities');
        activitiesContainer.innerHTML = '';
        
        // Obter atividades pendentes
        const pendingActivities = this.getPendingActivities(todayTasks, atividades);
        
        // Adicionar atividades pendentes como cards individuais
        if (!chatBot.isDayFinished()) {
          // Questões pendentes
          pendingActivities.questoes.forEach(questao => {
            const pendingCard = document.createElement('div');
            pendingCard.className = 'activity-card pending';
            pendingCard.innerHTML = `
              <div class="activity-header">
                <div class="activity-title">
                  <i class="fas fa-book"></i>
                  <span>${questao.nome}</span>
                </div>
                <div class="activity-status status-pending">Pendente</div>
              </div>
              <div class="activity-details">
                ${questao.disciplina || 'Questões'}
              </div>
            `;
            activitiesContainer.appendChild(pendingCard);
          });
          
          // Anki pendentes
          pendingActivities.anki.forEach(deck => {
            const pendingCard = document.createElement('div');
            pendingCard.className = 'activity-card pending';
            pendingCard.innerHTML = `
              <div class="activity-header">
                <div class="activity-title">
                  <i class="fas fa-layer-group"></i>
                  <span>${deck.nome}</span>
                </div>
                <div class="activity-status status-pending">Pendente</div>
              </div>
              <div class="activity-details">
                Revisão de flashcards
              </div>
            `;
            activitiesContainer.appendChild(pendingCard);
          });
          
          // Teoria pendente
          pendingActivities.teoria.forEach(materia => {
            const pendingCard = document.createElement('div');
            pendingCard.className = 'activity-card pending';
            pendingCard.innerHTML = `
              <div class="activity-header">
                <div class="activity-title">
                  <i class="fas fa-book-open"></i>
                  <span>${materia}</span>
                </div>
                <div class="activity-status status-pending">Pendente</div>
              </div>
              <div class="activity-details">
                Estudo teórico
              </div>
            `;
            activitiesContainer.appendChild(pendingCard);
          });
        }
        
        // Adicionar questões concluídas
        atividades.questoes.forEach(q => {
          const acertos = q.feitas - q.erradas;
          const taxa = q.feitas > 0 ? Math.round((acertos / q.feitas) * 100) : 0;
          
          const activityCard = document.createElement('div');
          activityCard.className = 'activity-card completed';
          activityCard.innerHTML = `
            <div class="check-animation">
              <i class="fas fa-check"></i>
            </div>
            <div class="activity-header">
              <div class="activity-title">
                <i class="fas fa-book"></i>
                <span>${q.assunto}</span>
              </div>
              <div class="activity-status status-completed">Concluído</div>
            </div>
            <div class="activity-details">
              ${q.feitas} questões • ${taxa}% acerto • ${q.tempo} min
            </div>
          `;
          activitiesContainer.appendChild(activityCard);
        });
        
        // Adicionar Anki concluídos
        atividades.anki.forEach(a => {
          const activityCard = document.createElement('div');
          activityCard.className = 'activity-card completed';
          activityCard.innerHTML = `
            <div class="check-animation">
              <i class="fas fa-check"></i>
            </div>
            <div class="activity-header">
              <div class="activity-title">
                <i class="fas fa-layer-group"></i>
                <span>${a.deck}</span>
              </div>
              <div class="activity-status status-completed">Concluído</div>
            </div>
            <div class="activity-details">
              ${a.cards} cards revisados • ${a.tempo} min
            </div>
          `;
          activitiesContainer.appendChild(activityCard);
        });
        
        // Adicionar teoria concluída
        atividades.teoria.forEach(t => {
          const activityCard = document.createElement('div');
          activityCard.className = 'activity-card completed';
          activityCard.innerHTML = `
            <div class="check-animation">
              <i class="fas fa-check"></i>
            </div>
            <div class="activity-header">
              <div class="activity-title">
                <i class="fas fa-book-open"></i>
                <span>${t.materia}</span>
              </div>
              <div class="activity-status status-completed">Concluído</div>
            </div>
            <div class="activity-details">
              ${t.conteudo || t.pagina || 'Estudo concluído'} • ${t.tempo} min
            </div>
          `;
          activitiesContainer.appendChild(activityCard);
        });
        
        // Atualizar status do dia
        const dayStatus = document.getElementById('dayStatus');
        if (chatBot.isDayFinished()) {
          dayStatus.className = 'day-status completed';
          dayStatus.innerHTML = `
            <div class="day-status-text">
              <i class="fas fa-check-circle"></i>
              <span>Dia finalizado</span>
            </div>
            <div class="tooltip">
              <i class="fas fa-info-circle" style="color: var(--success)"></i>
              <span class="tooltip-text">Você finalizou o dia hoje</span>
            </div>
          `;
        } else if (completedTasks > 0) {
          dayStatus.className = 'day-status pending';
          dayStatus.innerHTML = `
            <div class="day-status-text">
              <i class="fas fa-clock"></i>
              <span>Dia em andamento</span>
            </div>
            <div class="tooltip">
              <i class="fas fa-info-circle" style="color: var(--gray)"></i>
              <span class="tooltip-text">${completedTasks}/${totalTasks} atividades concluídas</span>
            </div>
          `;
        } else {
          dayStatus.className = 'day-status pending';
          dayStatus.innerHTML = `
            <div class="day-status-text">
              <i class="fas fa-clock"></i>
              <span>Dia não iniciado</span>
            </div>
            <div class="tooltip">
              <i class="fas fa-info-circle" style="color: var(--gray)"></i>
              <span class="tooltip-text">Comece registrando suas atividades</span>
            </div>
          `;
        }
      },
      
      getPendingActivities: function(todayTasks, atividades) {
        const pending = {
          questoes: [],
          anki: [],
          teoria: []
        };
        
        // Filtrar questões pendentes
        if (todayTasks.questoes) {
          todayTasks.questoes.forEach(questao => {
            const isRegistered = atividades.questoes.find(q => q.assunto === questao.id);
            if (!isRegistered) {
              pending.questoes.push(questao);
            }
          });
        }
        
        // Filtrar anki pendentes
        if (todayTasks.anki) {
          todayTasks.anki.forEach(deck => {
            const isRegistered = atividades.anki.find(a => a.deck === deck.id);
            if (!isRegistered) {
              pending.anki.push(deck);
            }
          });
        }
        
        // Filtrar teoria pendente
        if (todayTasks.teoria) {
          todayTasks.teoria.forEach(materia => {
            const isRegistered = atividades.teoria.find(t => t.materia === materia);
            if (!isRegistered) {
              pending.teoria.push(materia);
            }
          });
        }
        
        return pending;
      },
      
      bindEvents: function() {
        // Atualizar painel quando houver mudanças no localStorage
        window.addEventListener('storage', (e) => {
          if (e.key && e.key.includes('dailyActivities') || 
              e.key === 'studyFlow_partialRegistration' ||
              e.key === 'ultimoEstudo') {
            this.updateSidePanel();
          }
        });
        
        // Atualizar painel ao redimensionar a janela
        window.addEventListener('resize', () => {
          const sidePanel = document.getElementById('sidePanel');
          if (window.innerWidth > 900) {
            sidePanel.classList.remove('collapsed');
          } else {
            sidePanel.classList.add('collapsed');
          }
          this.updateToggleIcon();
          this.updateFabVisibility();
        });
        
        // Atualizar painel quando a aba voltar a ficar visível
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            this.updateSidePanel();
          }
        });
        
        // Atualizar painel quando a janela receber foco
        window.addEventListener('focus', () => {
          this.updateSidePanel();
        });
      }
    };
    /* UI ENHANCEMENTS END */
    
    document.addEventListener('DOMContentLoaded', function() {
      chatBot = new StudyFlowChatBot();
    });
  </script>
</body>
</html>
